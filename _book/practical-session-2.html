<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Practical session 2 | Spatial transcriptomics data analysis: theory and practice</title>
  <meta name="description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Practical session 2 | Spatial transcriptomics data analysis: theory and practice" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  <meta name="github-repo" content="https://github.com/ncl-icbam/ismb-tutorial-2023.git" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Practical session 2 | Spatial transcriptomics data analysis: theory and practice" />
  
  <meta name="twitter:description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  

<meta name="author" content="Eleftherios Zormpas, Dr Simon J. Cockell" />


<meta name="date" content="2023-07-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="practical-session-1.html"/>
<link rel="next" href="practical-session-3.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial transcriptomics data analysis: theory and practice</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning objectives</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="practical-session-1.html"><a href="practical-session-1.html"><i class="fa fa-check"></i><b>1</b> Practical session 1</a>
<ul>
<li class="chapter" data-level="1.1" data-path="practical-session-1.html"><a href="practical-session-1.html#about-this-documentation"><i class="fa fa-check"></i><b>1.1</b> About this documentation</a></li>
<li class="chapter" data-level="1.2" data-path="practical-session-1.html"><a href="practical-session-1.html#posit-cloud"><i class="fa fa-check"></i><b>1.2</b> Posit Cloud</a></li>
<li class="chapter" data-level="1.3" data-path="practical-session-1.html"><a href="practical-session-1.html#import-10x-visium-data"><i class="fa fa-check"></i><b>1.3</b> Import 10X Visium data</a></li>
<li class="chapter" data-level="1.4" data-path="practical-session-1.html"><a href="practical-session-1.html#explore-data-types"><i class="fa fa-check"></i><b>1.4</b> Explore data types</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="practical-session-1.html"><a href="practical-session-1.html#spatialexperiment-class"><i class="fa fa-check"></i><b>1.4.1</b> SpatialExperiment class</a></li>
<li class="chapter" data-level="1.4.2" data-path="practical-session-1.html"><a href="practical-session-1.html#inspect-the-object"><i class="fa fa-check"></i><b>1.4.2</b> Inspect the object</a></li>
<li class="chapter" data-level="1.4.3" data-path="practical-session-1.html"><a href="practical-session-1.html#counts-table-and-gene-metadata"><i class="fa fa-check"></i><b>1.4.3</b> Counts table and gene metadata</a></li>
<li class="chapter" data-level="1.4.4" data-path="practical-session-1.html"><a href="practical-session-1.html#coordinates-table-and-spot-metadata"><i class="fa fa-check"></i><b>1.4.4</b> Coordinates table and spot metadata</a></li>
<li class="chapter" data-level="1.4.5" data-path="practical-session-1.html"><a href="practical-session-1.html#image-metadata"><i class="fa fa-check"></i><b>1.4.5</b> Image metadata</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="practical-session-1.html"><a href="practical-session-1.html#conclusion"><i class="fa fa-check"></i><b>1.5</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="practical-session-2.html"><a href="practical-session-2.html"><i class="fa fa-check"></i><b>2</b> Practical session 2</a>
<ul>
<li class="chapter" data-level="2.1" data-path="practical-session-2.html"><a href="practical-session-2.html#spot-level-quality-control"><i class="fa fa-check"></i><b>2.1</b> Spot-level Quality Control</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="practical-session-2.html"><a href="practical-session-2.html#plot-tissue-map"><i class="fa fa-check"></i><b>2.1.1</b> Plot tissue map</a></li>
<li class="chapter" data-level="2.1.2" data-path="practical-session-2.html"><a href="practical-session-2.html#calculating-qc-metrics"><i class="fa fa-check"></i><b>2.1.2</b> Calculating QC metrics</a></li>
<li class="chapter" data-level="2.1.3" data-path="practical-session-2.html"><a href="practical-session-2.html#library-size-threshold-plot"><i class="fa fa-check"></i><b>2.1.3</b> Library size threshold plot</a></li>
<li class="chapter" data-level="2.1.4" data-path="practical-session-2.html"><a href="practical-session-2.html#number-of-expressed-genes"><i class="fa fa-check"></i><b>2.1.4</b> Number of expressed genes</a></li>
<li class="chapter" data-level="2.1.5" data-path="practical-session-2.html"><a href="practical-session-2.html#percentage-of-mitochondrial-expression"><i class="fa fa-check"></i><b>2.1.5</b> Percentage of mitochondrial expression</a></li>
<li class="chapter" data-level="2.1.6" data-path="practical-session-2.html"><a href="practical-session-2.html#number-of-cells-per-spot"><i class="fa fa-check"></i><b>2.1.6</b> Number of cells per spot</a></li>
<li class="chapter" data-level="2.1.7" data-path="practical-session-2.html"><a href="practical-session-2.html#remove-low-quality-spots"><i class="fa fa-check"></i><b>2.1.7</b> Remove low-quality spots</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="practical-session-2.html"><a href="practical-session-2.html#normalisation-of-counts"><i class="fa fa-check"></i><b>2.2</b> Normalisation of counts</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background"><i class="fa fa-check"></i><b>2.2.1</b> Background</a></li>
<li class="chapter" data-level="2.2.2" data-path="practical-session-2.html"><a href="practical-session-2.html#log-tranformation-of-counts"><i class="fa fa-check"></i><b>2.2.2</b> Log-tranformation of counts</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="practical-session-2.html"><a href="practical-session-2.html#selecting-genes"><i class="fa fa-check"></i><b>2.3</b> Selecting genes</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-1"><i class="fa fa-check"></i><b>2.3.1</b> Background</a></li>
<li class="chapter" data-level="2.3.2" data-path="practical-session-2.html"><a href="practical-session-2.html#highly-variable-genes-hvgs"><i class="fa fa-check"></i><b>2.3.2</b> Highly Variable Genes (HVGs)</a></li>
<li class="chapter" data-level="2.3.3" data-path="practical-session-2.html"><a href="practical-session-2.html#spatially-variable-genes-svgs"><i class="fa fa-check"></i><b>2.3.3</b> Spatially variable genes (SVGs)</a></li>
<li class="chapter" data-level="2.3.4" data-path="practical-session-2.html"><a href="practical-session-2.html#integration-of-hvgs-and-svgs"><i class="fa fa-check"></i><b>2.3.4</b> Integration of HVGs and SVGs</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="practical-session-2.html"><a href="practical-session-2.html#dimensionality-reduction"><i class="fa fa-check"></i><b>2.4</b> Dimensionality reduction</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-2"><i class="fa fa-check"></i><b>2.4.1</b> Background</a></li>
<li class="chapter" data-level="2.4.2" data-path="practical-session-2.html"><a href="practical-session-2.html#pca-principal-component-analysis"><i class="fa fa-check"></i><b>2.4.2</b> PCA: Principal component analysis</a></li>
<li class="chapter" data-level="2.4.3" data-path="practical-session-2.html"><a href="practical-session-2.html#umap-uniform-manifold-approximation-and-projection"><i class="fa fa-check"></i><b>2.4.3</b> UMAP: Uniform Manifold Approximation and Projection</a></li>
<li class="chapter" data-level="2.4.4" data-path="practical-session-2.html"><a href="practical-session-2.html#umap-visualisations"><i class="fa fa-check"></i><b>2.4.4</b> UMAP visualisations</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="practical-session-2.html"><a href="practical-session-2.html#clustering"><i class="fa fa-check"></i><b>2.5</b> Clustering</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-3"><i class="fa fa-check"></i><b>2.5.1</b> Background</a></li>
<li class="chapter" data-level="2.5.2" data-path="practical-session-2.html"><a href="practical-session-2.html#clustering-on-hvgs"><i class="fa fa-check"></i><b>2.5.2</b> Clustering on HVGs</a></li>
<li class="chapter" data-level="2.5.3" data-path="practical-session-2.html"><a href="practical-session-2.html#hvgs-clustering-visualisations"><i class="fa fa-check"></i><b>2.5.3</b> HVGs clustering visualisations</a></li>
<li class="chapter" data-level="2.5.4" data-path="practical-session-2.html"><a href="practical-session-2.html#spatially-aware-clustering"><i class="fa fa-check"></i><b>2.5.4</b> Spatially-aware clustering</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="practical-session-2.html"><a href="practical-session-2.html#inter-cluster-differentially-expressed-genes-dges"><i class="fa fa-check"></i><b>2.6</b> Inter-cluster differentially expressed genes (DGEs)</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-4"><i class="fa fa-check"></i><b>2.6.1</b> Background</a></li>
<li class="chapter" data-level="2.6.2" data-path="practical-session-2.html"><a href="practical-session-2.html#dges-identification"><i class="fa fa-check"></i><b>2.6.2</b> DGEs identification</a></li>
<li class="chapter" data-level="2.6.3" data-path="practical-session-2.html"><a href="practical-session-2.html#dges-visualisation"><i class="fa fa-check"></i><b>2.6.3</b> DGEs visualisation</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="practical-session-2.html"><a href="practical-session-2.html#putting-it-all-together"><i class="fa fa-check"></i><b>2.7</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="practical-session-3.html"><a href="practical-session-3.html"><i class="fa fa-check"></i><b>3</b> Practical session 3</a>
<ul>
<li class="chapter" data-level="3.1" data-path="practical-session-3.html"><a href="practical-session-3.html#load-packages"><i class="fa fa-check"></i><b>3.1</b> Load packages</a></li>
<li class="chapter" data-level="3.2" data-path="practical-session-3.html"><a href="practical-session-3.html#background-5"><i class="fa fa-check"></i><b>3.2</b> Background</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="practical-session-3.html"><a href="practical-session-3.html#main-geocomputational-data-structures"><i class="fa fa-check"></i><b>3.2.1</b> Main geocomputational data structures</a></li>
<li class="chapter" data-level="3.2.2" data-path="practical-session-3.html"><a href="practical-session-3.html#the-sf-objects"><i class="fa fa-check"></i><b>3.2.2</b> The <code>sf</code> objects</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="practical-session-3.html"><a href="practical-session-3.html#data-structures-preparation"><i class="fa fa-check"></i><b>3.3</b> Data structures preparation</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="practical-session-3.html"><a href="practical-session-3.html#load-new-dataset"><i class="fa fa-check"></i><b>3.3.1</b> Load new dataset</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="practical-session-3.html"><a href="practical-session-3.html#spot-level-quality-control-1"><i class="fa fa-check"></i><b>3.4</b> Spot-level Quality Control</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="practical-session-3.html"><a href="practical-session-3.html#calculating-qc-metrics-1"><i class="fa fa-check"></i><b>3.4.1</b> Calculating QC metrics</a></li>
<li class="chapter" data-level="3.4.2" data-path="practical-session-3.html"><a href="practical-session-3.html#plot-manual-annotation"><i class="fa fa-check"></i><b>3.4.2</b> Plot manual annotation</a></li>
<li class="chapter" data-level="3.4.3" data-path="practical-session-3.html"><a href="practical-session-3.html#library-size-threshold"><i class="fa fa-check"></i><b>3.4.3</b> Library size threshold</a></li>
<li class="chapter" data-level="3.4.4" data-path="practical-session-3.html"><a href="practical-session-3.html#number-of-expressed-genes-1"><i class="fa fa-check"></i><b>3.4.4</b> Number of expressed genes</a></li>
<li class="chapter" data-level="3.4.5" data-path="practical-session-3.html"><a href="practical-session-3.html#percentage-of-mitochondrial-expression-1"><i class="fa fa-check"></i><b>3.4.5</b> Percentage of mitochondrial expression</a></li>
<li class="chapter" data-level="3.4.6" data-path="practical-session-3.html"><a href="practical-session-3.html#remove-low-quality-spots-1"><i class="fa fa-check"></i><b>3.4.6</b> Remove low-quality spots</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="practical-session-3.html"><a href="practical-session-3.html#normalisation-of-counts-1"><i class="fa fa-check"></i><b>3.5</b> Normalisation of counts</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="practical-session-3.html"><a href="practical-session-3.html#log-tranformation-of-counts-1"><i class="fa fa-check"></i><b>3.5.1</b> Log-tranformation of counts</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="practical-session-3.html"><a href="practical-session-3.html#gene-level-quality-control"><i class="fa fa-check"></i><b>3.6</b> Gene-level Quality Control</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="practical-session-3.html"><a href="practical-session-3.html#calculating-extra-qc-metrics"><i class="fa fa-check"></i><b>3.6.1</b> Calculating extra QC metrics</a></li>
<li class="chapter" data-level="3.6.2" data-path="practical-session-3.html"><a href="practical-session-3.html#set-and-apply-filters"><i class="fa fa-check"></i><b>3.6.2</b> Set and apply filters</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="practical-session-3.html"><a href="practical-session-3.html#selecting-genes-1"><i class="fa fa-check"></i><b>3.7</b> Selecting genes</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="practical-session-3.html"><a href="practical-session-3.html#highly-variable-genes-hvgs-1"><i class="fa fa-check"></i><b>3.7.1</b> Highly Variable Genes (HVGs)</a></li>
<li class="chapter" data-level="3.7.2" data-path="practical-session-3.html"><a href="practical-session-3.html#code-for-3.3-to-3.7"><i class="fa fa-check"></i><b>3.7.2</b> Code for 3.3 to 3.7</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="practical-session-3.html"><a href="practical-session-3.html#neighbour-graph-and-distance-matrix"><i class="fa fa-check"></i><b>3.8</b> Neighbour graph and distance matrix</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="practical-session-3.html"><a href="practical-session-3.html#adding-spatial-weights"><i class="fa fa-check"></i><b>3.8.1</b> Adding spatial weights</a></li>
<li class="chapter" data-level="3.8.2" data-path="practical-session-3.html"><a href="practical-session-3.html#generate-distance-matrices"><i class="fa fa-check"></i><b>3.8.2</b> Generate distance matrices</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="practical-session-3.html"><a href="practical-session-3.html#putting-it-all-together-1"><i class="fa fa-check"></i><b>3.9</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="practical-session-4.html"><a href="practical-session-4.html"><i class="fa fa-check"></i><b>4</b> Practical session 4</a>
<ul>
<li class="chapter" data-level="4.1" data-path="practical-session-4.html"><a href="practical-session-4.html#geographically-weighted-principal-components-analysis-gwpca"><i class="fa fa-check"></i><b>4.1</b> Geographically Weighted Principal Components Analysis (GWPCA)</a></li>
<li class="chapter" data-level="4.2" data-path="practical-session-4.html"><a href="practical-session-4.html#load-packages-1"><i class="fa fa-check"></i><b>4.2</b> Load packages</a></li>
<li class="chapter" data-level="4.3" data-path="practical-session-4.html"><a href="practical-session-4.html#load-quality-controled-and-normalised-data"><i class="fa fa-check"></i><b>4.3</b> Load Quality Controled and Normalised data</a></li>
<li class="chapter" data-level="4.4" data-path="practical-session-4.html"><a href="practical-session-4.html#parameter-prearation-for-gwpca"><i class="fa fa-check"></i><b>4.4</b> Parameter prearation for GWPCA</a></li>
<li class="chapter" data-level="4.5" data-path="practical-session-4.html"><a href="practical-session-4.html#run-gwpca"><i class="fa fa-check"></i><b>4.5</b> Run GWPCA</a></li>
<li class="chapter" data-level="4.6" data-path="practical-session-4.html"><a href="practical-session-4.html#plot-global-pca-results"><i class="fa fa-check"></i><b>4.6</b> Plot global PCA results</a></li>
<li class="chapter" data-level="4.7" data-path="practical-session-4.html"><a href="practical-session-4.html#identify-the-leading-genes-in-each-location"><i class="fa fa-check"></i><b>4.7</b> Identify the leading genes in each location</a></li>
<li class="chapter" data-level="4.8" data-path="practical-session-4.html"><a href="practical-session-4.html#percentage-of-total-variation-ptv"><i class="fa fa-check"></i><b>4.8</b> Percentage of Total Variation (PTV)</a></li>
<li class="chapter" data-level="4.9" data-path="practical-session-4.html"><a href="practical-session-4.html#identify-discrepancies"><i class="fa fa-check"></i><b>4.9</b> Identify discrepancies</a></li>
<li class="chapter" data-level="4.10" data-path="practical-session-4.html"><a href="practical-session-4.html#final-summary"><i class="fa fa-check"></i><b>4.10</b> Final Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial transcriptomics data analysis: theory and practice</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="practical-session-2" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> Practical session 2<a href="practical-session-2.html#practical-session-2" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Having previously introduced some of the Bioconductor ecosystem for storing and manipulating STx data, in this second session we will focus on some of the most common STx analysis tasks - particularly quality control assessment and associated spot- and gene- level filtering. We will also consider some global methods of STx analysis, including dimensionality reduction and clustering. All of the methods demonstrated here continue to focus on interoperable packages available via Bioconductor.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="practical-session-2.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load packages {-}</span></span>
<span id="cb29-2"><a href="practical-session-2.html#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SpatialExperiment)</span>
<span id="cb29-3"><a href="practical-session-2.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(STexampleData)</span>
<span id="cb29-4"><a href="practical-session-2.html#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspavis)</span>
<span id="cb29-5"><a href="practical-session-2.html#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb29-6"><a href="practical-session-2.html#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb29-7"><a href="practical-session-2.html#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span>
<span id="cb29-8"><a href="practical-session-2.html#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb29-9"><a href="practical-session-2.html#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb29-10"><a href="practical-session-2.html#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggExtra)</span></code></pre></div>
<ul>
<li><p><a href="https://bioconductor.org/packages/release/bioc/html/ggspavis.html"><code>ggspavis</code></a> is a Bioconductor package that includes visualization functions for spatially resolved transcriptomics datasets stored in <code>SpatialExperiment</code> format from spot-based (e.g., 10x Genomics Visium) platforms (<span class="citation">Weber and Crowell (<a href="#ref-ggspavis2023Apr" role="doc-biblioref">2022</a>)</span>).</p></li>
<li><p><a href="https://bioconductor.org/packages/release/bioc/html/scater.html"><code>scater</code></a> is also a Bioconductor package that is a selection of tools for doing various analyses of scRNA-seq gene expression data, with a focus on quality control and visualization which has extended applications to STx data too. It is based on the <code>SingleCellExperiment</code> and <code>SpatialExperiment</code> classes and thus is interoperable with many other Bioconductor packages such as <a href="Spot-level%20quality%20control%20(sQC)%20procedures%20are%20employed%20to%20eliminate%20low-quality%20spots%20before%20conducting%20further%20analyses"><code>scran</code></a>, <a href="https://bioconductor.org/packages/release/scuttle"><code>scuttle</code></a> and <a href="https://bioconductor.org/packages/release/iSEE"><code>iSEE</code></a>.</p></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="practical-session-2.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Reload the example dataset</span></span>
<span id="cb30-2"><a href="practical-session-2.html#cb30-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">Visium_humanDLPFC</span>()</span></code></pre></div>
<pre><code>## see ?STexampleData and browseVignettes(&#39;STexampleData&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
<div id="spot-level-quality-control" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Spot-level Quality Control<a href="practical-session-2.html#spot-level-quality-control" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Considered quality control (QC) procedures are essential for analysing any high-throughput data in molecular biology. The removal of noise and low quality data from complex datasets can improve the reliability of downsrtream analyses. STx is no different in this regard, and QC can be undertaken in 2 main places - spot-level and gene-level. Here, we focus on spot-level QC.</p>
<p>Spot-level quality control (sQC) procedures are employed to eliminate low-quality spots before conducting further analyses. Low-quality spots may result from issues during library preparation or other experimental procedures, such as a high percentage of dead cells due to cell damage during library preparation, or low mRNA capture efficiency caused by ineffective reverse transcription or PCR amplification. Keeping these spots usually leads to creating problems during downstream analyses.</p>
<p>We can identify low-quality spots using several characteristics that are also used in cell-level QC for scRNA-sq data, including:</p>
<ol style="list-style-type: decimal">
<li><strong>library size</strong> (total of UMI counts per spot will vary due to sequencing <em>-like different samples in a bulk RNA-seq-</em>, or due to number of cells in the spot)</li>
<li><strong>number of expressed genes</strong> (i.e. number of genes with non-zero UMI counts per spot)</li>
<li><strong>proportion of reads mapping to mitochondrial genes</strong> (a high proportion indicates putative cell damage)</li>
</ol>
<p>Low library size or low number of expressed features can indicate poor mRNA capture rates, e.g. due to cell damage and missing mRNAs, or low reaction efficiency. A high proportion of mitochondrial reads indicates cell damage, e.g. partial cell lysis leading to leakage and missing cytoplasmic mRNAs, with the resulting reads therefore concentrated on the remaining mitochondrial mRNAs that are relatively protected inside the mitochondrial membrane. Unusually high numbers of cells per spot can indicate problems during cell segmentation.</p>
<p>The idea of using scRNA-seq QC metrics in STx data comes from the fact that if we remove space and effectively treat each spot as a single cell, the two datasets share common features. We need to bear in mind, however, that the expected distributions for high-quality <em>spots</em> are different (compared to high-quality <em>cells</em> in scRNA-seq), since spots may contain zero, one, or multiple cells.</p>
<p>A few publications for further reading that can help you understand the quality controls: <span class="citation">McCarthy et al. (<a href="#ref-McCarthy2017Apr" role="doc-biblioref">2017</a>)</span> and <span class="citation">Amezquita et al. (<a href="#ref-Amezquita2020Feb" role="doc-biblioref">2020</a>)</span>.</p>
<div id="plot-tissue-map" class="section level3 hasAnchor" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Plot tissue map<a href="practical-session-2.html#plot-tissue-map" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The dorso-lateral prefrontal cortex (DLPFC) is a functional brain region in primates involved in executive function. It consists of six layers of neurons that differ in their cell types, density and connections. The DLPFC dataset we looked at in session one, and will be here using comes with manual annotation of these layers (and the adjacent white matter - WM) by the authors <span class="citation">Maynard et al. (<a href="#ref-Maynard2021Mar" role="doc-biblioref">2021</a>)</span>. We can plot the tissue map with and without the annotations to get a complete view.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="practical-session-2.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot spatial coordinates without annotations</span></span>
<span id="cb33-2"><a href="practical-session-2.html#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpots</span>(spe)</span>
<span id="cb33-3"><a href="practical-session-2.html#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="practical-session-2.html#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot spatial coordinates with annotations</span></span>
<span id="cb33-5"><a href="practical-session-2.html#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpots</span>(spe,</span>
<span id="cb33-6"><a href="practical-session-2.html#cb33-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">annotate =</span> <span class="st">&quot;ground_truth&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-maps-gTruth-1.png" width="50%" /><img src="_main_files/figure-html/02_plot-maps-gTruth-2.png" width="50%" /></p>
</div>
<div id="calculating-qc-metrics" class="section level3 hasAnchor" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> Calculating QC metrics<a href="practical-session-2.html#calculating-qc-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will calculate the three main QC metrics described above using methods from the <code>scater</code> <span class="citation">(<a href="#ref-McCarthy2017Apr" role="doc-biblioref">McCarthy et al. 2017</a>)</span> package, and investigate their influence on the DLPFC dataset with some plots from <code>ggspavis</code>, along with some additional plots of our own.</p>
<p>At present, the dataset contains both on- and off-tissue spots - we plotted these in the previous practical. For any future analysis though we are only interested in the on-tissue spots. Therefore, before we run any calculations we want to remove the off-tissue spots.</p>
<p><strong><em>NOTE</em></strong>: the on- or off-tissue information for each spot can be found in the <code>colData</code> of the <code>spe</code> object and in the <code>in_tissue</code> column where <em>0 = off-tissue</em> and <em>1 = on-tissue</em>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="practical-session-2.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Dataset dimensions before the filtering</span></span>
<span id="cb34-2"><a href="practical-session-2.html#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spe)</span></code></pre></div>
<pre><code>## [1] 33538  4992</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="practical-session-2.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Subset to keep only on-tissue spots</span></span>
<span id="cb36-2"><a href="practical-session-2.html#cb36-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[, <span class="fu">colData</span>(spe)<span class="sc">$</span>in_tissue <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb36-3"><a href="practical-session-2.html#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spe)</span></code></pre></div>
<pre><code>## [1] 33538  3639</code></pre>
<p>The next thing we need to do before we make decisions on how to quality <em>“trim”</em> the dataset is to calculate the percentage per spot of mitochodrial gene expression and store this information inside the <code>colData</code>. First of all, find the mitochrondrial genes - their gene names start with “MT-” or “mt-”.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="practical-session-2.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Classify genes as &quot;mitochondrial&quot; (is_mito == TRUE) </span></span>
<span id="cb38-2"><a href="practical-session-2.html#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="do">## or not (is_mito == FALSE)</span></span>
<span id="cb38-3"><a href="practical-session-2.html#cb38-3" aria-hidden="true" tabindex="-1"></a>is_mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;(^MT-)|(^mt-)&quot;</span>, <span class="fu">rowData</span>(spe)<span class="sc">$</span>gene_name)</span>
<span id="cb38-4"><a href="practical-session-2.html#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(spe)<span class="sc">$</span>gene_name[is_mito]</span></code></pre></div>
<pre><code>##  [1] &quot;MT-ND1&quot;  &quot;MT-ND2&quot;  &quot;MT-CO1&quot;  &quot;MT-CO2&quot;  &quot;MT-ATP8&quot; &quot;MT-ATP6&quot; &quot;MT-CO3&quot; 
##  [8] &quot;MT-ND3&quot;  &quot;MT-ND4L&quot; &quot;MT-ND4&quot;  &quot;MT-ND5&quot;  &quot;MT-ND6&quot;  &quot;MT-CYB&quot;</code></pre>
<p>Then find what proportion of reads in a spot’s library are attributable to the expression of these genes. This uses a function, <code>addPerCellQC()</code> from <code>scater</code> (which in this instance is actually a wrapper around <code>scuttle</code>).</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="practical-session-2.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate per-spot QC metrics and store in colData</span></span>
<span id="cb40-2"><a href="practical-session-2.html#cb40-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">addPerCellQC</span>(spe, <span class="at">subsets =</span> <span class="fu">list</span>(<span class="at">mito =</span> is_mito))</span>
<span id="cb40-3"><a href="practical-session-2.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">colData</span>(spe))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 13 columns
##                            barcode_id     sample_id in_tissue array_row
##                           &lt;character&gt;   &lt;character&gt; &lt;integer&gt; &lt;integer&gt;
## AAACAAGTATCTCCCA-1 AAACAAGTATCTCCCA-1 sample_151673         1        50
## AAACAATCTACTAGCA-1 AAACAATCTACTAGCA-1 sample_151673         1         3
## AAACACCAATAACTGC-1 AAACACCAATAACTGC-1 sample_151673         1        59
## AAACAGAGCGACTCCT-1 AAACAGAGCGACTCCT-1 sample_151673         1        14
## AAACAGCTTTCAGAAG-1 AAACAGCTTTCAGAAG-1 sample_151673         1        43
## AAACAGGGTCTATATT-1 AAACAGGGTCTATATT-1 sample_151673         1        47
##                    array_col ground_truth cell_count       sum  detected
##                    &lt;integer&gt;  &lt;character&gt;  &lt;integer&gt; &lt;numeric&gt; &lt;numeric&gt;
## AAACAAGTATCTCCCA-1       102       Layer3          6      8458      3586
## AAACAATCTACTAGCA-1        43       Layer1         16      1667      1150
## AAACACCAATAACTGC-1        19           WM          5      3769      1960
## AAACAGAGCGACTCCT-1        94       Layer3          2      5433      2424
## AAACAGCTTTCAGAAG-1         9       Layer5          4      4278      2264
## AAACAGGGTCTATATT-1        13       Layer6          6      4004      2178
##                    subsets_mito_sum subsets_mito_detected subsets_mito_percent
##                           &lt;numeric&gt;             &lt;numeric&gt;            &lt;numeric&gt;
## AAACAAGTATCTCCCA-1             1407                    13              16.6351
## AAACAATCTACTAGCA-1              204                    11              12.2376
## AAACACCAATAACTGC-1              430                    13              11.4089
## AAACAGAGCGACTCCT-1             1316                    13              24.2223
## AAACAGCTTTCAGAAG-1              651                    12              15.2174
## AAACAGGGTCTATATT-1              621                    13              15.5095
##                        total
##                    &lt;numeric&gt;
## AAACAAGTATCTCCCA-1      8458
## AAACAATCTACTAGCA-1      1667
## AAACACCAATAACTGC-1      3769
## AAACAGAGCGACTCCT-1      5433
## AAACAGCTTTCAGAAG-1      4278
## AAACAGGGTCTATATT-1      4004</code></pre>
<p>After calculating a required metric, we need to apply a cut-off threshold for the metric to decide whether or not to keep each spot. It is important to consider an individual dataset on its own merits, as it might need slightly different cut-off values to be applied. As a result we cannot rely on identifying a single value to use every time and we need to rely on plotting these metrics and making a decision on a dataset-by-dataset basis.</p>
</div>
<div id="library-size-threshold-plot" class="section level3 hasAnchor" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> Library size threshold plot<a href="practical-session-2.html#library-size-threshold-plot" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can plot a histogram of the library sizes across spots. The library size is the number of UMI counts in each spot. We can find this information in the <code>sum</code> column in the <code>colData</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="practical-session-2.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Density and histogram of library sizes</span></span>
<span id="cb42-2"><a href="practical-session-2.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)),</span>
<span id="cb42-3"><a href="practical-session-2.html#cb42-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> sum)) <span class="sc">+</span></span>
<span id="cb42-4"><a href="practical-session-2.html#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb42-5"><a href="practical-session-2.html#cb42-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb42-6"><a href="practical-session-2.html#cb42-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb42-7"><a href="practical-session-2.html#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb42-8"><a href="practical-session-2.html#cb42-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">1.0</span>,</span>
<span id="cb42-9"><a href="practical-session-2.html#cb42-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb42-10"><a href="practical-session-2.html#cb42-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a href="practical-session-2.html#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb42-12"><a href="practical-session-2.html#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb42-13"><a href="practical-session-2.html#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Library size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb42-14"><a href="practical-session-2.html#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span> </span>
<span id="cb42-15"><a href="practical-session-2.html#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-libSize-histo-1.png" width="672" /></p>
<p>As we can see there are no obvious issues with the library sizes. An example of an issue could be a high frequency of small libraries which would indicate poor experimental output. Generally we do not want to keep spots with too small libraries.</p>
<p>If the dataset we are analysing contains the number of cells that are present in each spot (this one does), then it makes sense to also plot the library sizes against the number of cells per spot. In that way we are making sure that we don’t remove any spots that may have biological meaning. In many cases though the datasets do not have such information unless we can generate it using a nuclei segmentation tool to extract this information from the H&amp;E images.</p>
<p>The horizontal red line (argument <code>threshold</code> in the <code>plotQC</code> function) shows a first guess at a possible filtering threshold for library size based on the above histogram.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="practical-session-2.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Scatter plot, library size against number of cells per spot</span></span>
<span id="cb43-2"><a href="practical-session-2.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>, </span>
<span id="cb43-3"><a href="practical-session-2.html#cb43-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">metric_x =</span> <span class="st">&quot;cell_count&quot;</span>, <span class="at">metric_y =</span> <span class="st">&quot;sum&quot;</span>, </span>
<span id="cb43-4"><a href="practical-session-2.html#cb43-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">threshold_y =</span> <span class="dv">700</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-libSizeVScelNo-1.png" width="576" /></p>
<p><strong>NOTE</strong>: The <code>ggspavis</code> plots for QC are convenient, but not very configurable. As can be seen from the “missing” bin in the top histogram here, the default configuration provided is not always the best. A ggplot2 alternative (using <code>ggExtra</code> to provide the marginal histograms) is also provided here.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="practical-session-2.html#cb44-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)), <span class="fu">aes</span>(<span class="at">x=</span>cell_count, <span class="at">y=</span>sum)) <span class="sc">+</span></span>
<span id="cb44-2"><a href="practical-session-2.html#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb44-3"><a href="practical-session-2.html#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb44-4"><a href="practical-session-2.html#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">700</span>, <span class="at">colour=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span> </span>
<span id="cb44-5"><a href="practical-session-2.html#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb44-6"><a href="practical-session-2.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggMarginal</span>(p, <span class="at">type=</span><span class="st">&#39;histogram&#39;</span>, <span class="at">margins =</span> <span class="st">&#39;both&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_ggplot-libSizeVScelNo-1.png" width="576" /></p>
<p>We need to keep in mind here that the threshold is, to an extent, arbitrary. It is therefore important to look at the number of spots that are left out of the dataset by this choice of cut-off value, and also have a look at their putative spatial patterns. If we filtered out spots with biological relevance, then we should observe some patterns on the tissue map that correlate with some of the known biological structures of the tissue. If we do observe such a phenomenon, we have probably set our threshold too high (i.e. not permissive enough).</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="practical-session-2.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select library size threshold</span></span>
<span id="cb45-2"><a href="practical-session-2.html#cb45-2" aria-hidden="true" tabindex="-1"></a>qc_lib_size <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>sum <span class="sc">&lt;</span> <span class="dv">700</span></span>
<span id="cb45-3"><a href="practical-session-2.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb45-4"><a href="practical-session-2.html#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_lib_size)</span></code></pre></div>
<pre><code>## qc_lib_size
## FALSE  TRUE 
##  3628    11</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="practical-session-2.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb47-2"><a href="practical-session-2.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>qc_lib_size <span class="ot">&lt;-</span> qc_lib_size</span>
<span id="cb47-3"><a href="practical-session-2.html#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="practical-session-2.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check putative spatial patterns of removed spots</span></span>
<span id="cb47-5"><a href="practical-session-2.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb47-6"><a href="practical-session-2.html#cb47-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;qc_lib_size&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_libSize-thresh-1.png" width="672" /></p>
<p>As an optional exercise, try to illustrate what happens if we set the threshold too high (i.e., 2000 UMI counts).</p>
<p><strong>NOTE:</strong> For reference, remember the ground truth layers in this dataset <a href="practical-session-2.html#plot-tissue-map">that we plotted</a> at the beginning of this session.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="practical-session-2.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select library size threshold</span></span>
<span id="cb48-2"><a href="practical-session-2.html#cb48-2" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb48-3"><a href="practical-session-2.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb48-4"><a href="practical-session-2.html#cb48-4" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb48-5"><a href="practical-session-2.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb48-6"><a href="practical-session-2.html#cb48-6" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb48-7"><a href="practical-session-2.html#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="practical-session-2.html#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Check putative spatial patterns of removed spots</span></span>
<span id="cb48-9"><a href="practical-session-2.html#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(...)</span></code></pre></div>
</div>
<div id="number-of-expressed-genes" class="section level3 hasAnchor" number="2.1.4">
<h3><span class="header-section-number">2.1.4</span> Number of expressed genes<a href="practical-session-2.html#number-of-expressed-genes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we did with the library sizes, we can plot a histogram of the number of expressed genes across spots. A gene is “expressed” in a spot if it has at least one count in it. We can find this information in the <code>detected</code> column in the <code>colData</code>.</p>
<p>We will follow the same logic for the plots as we did for the library size earlier.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="practical-session-2.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Density and histogram of expressed genes</span></span>
<span id="cb49-2"><a href="practical-session-2.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)),</span>
<span id="cb49-3"><a href="practical-session-2.html#cb49-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> detected)) <span class="sc">+</span></span>
<span id="cb49-4"><a href="practical-session-2.html#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb49-5"><a href="practical-session-2.html#cb49-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb49-6"><a href="practical-session-2.html#cb49-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-7"><a href="practical-session-2.html#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb49-8"><a href="practical-session-2.html#cb49-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">1.0</span>,</span>
<span id="cb49-9"><a href="practical-session-2.html#cb49-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb49-10"><a href="practical-session-2.html#cb49-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-11"><a href="practical-session-2.html#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb49-12"><a href="practical-session-2.html#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb49-13"><a href="practical-session-2.html#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Genes expressed in each spot&quot;</span>) <span class="sc">+</span> </span>
<span id="cb49-14"><a href="practical-session-2.html#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span> </span>
<span id="cb49-15"><a href="practical-session-2.html#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-genesInSpot-histo-1.png" width="672" /></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="practical-session-2.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot number of expressed genes vs. number of cells per spot</span></span>
<span id="cb50-2"><a href="practical-session-2.html#cb50-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)), <span class="fu">aes</span>(<span class="at">x=</span>cell_count, <span class="at">y=</span>detected)) <span class="sc">+</span></span>
<span id="cb50-3"><a href="practical-session-2.html#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb50-4"><a href="practical-session-2.html#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-5"><a href="practical-session-2.html#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">500</span>, <span class="at">colour=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span> </span>
<span id="cb50-6"><a href="practical-session-2.html#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb50-7"><a href="practical-session-2.html#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggMarginal</span>(p, <span class="at">type=</span><span class="st">&#39;histogram&#39;</span>, <span class="at">margins =</span> <span class="st">&#39;both&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_genesInSpot-scatter-1.png" width="576" /></p>
<p>Finally, again as before, we apply the chosen threshold to flag spots with (in this case) fewer than 500 expressed genes.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="practical-session-2.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select expressed genes threshold</span></span>
<span id="cb51-2"><a href="practical-session-2.html#cb51-2" aria-hidden="true" tabindex="-1"></a>qc_detected <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>detected <span class="sc">&lt;</span> <span class="dv">500</span></span>
<span id="cb51-3"><a href="practical-session-2.html#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb51-4"><a href="practical-session-2.html#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_detected)</span></code></pre></div>
<pre><code>## qc_detected
## FALSE  TRUE 
##  3628    11</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="practical-session-2.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb53-2"><a href="practical-session-2.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>qc_detected <span class="ot">&lt;-</span> qc_detected</span>
<span id="cb53-3"><a href="practical-session-2.html#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="practical-session-2.html#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for putative spatial pattern of removed spots</span></span>
<span id="cb53-5"><a href="practical-session-2.html#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb53-6"><a href="practical-session-2.html#cb53-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;qc_detected&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_genesInSpot-thresh-1.png" width="672" /></p>
<p>Again, an optional exercise is provided to see the effects of an over-enthusiastic filter - to illustrate what happens if we set the threshold too high (i.e., 1000 expressed genes).</p>
<p><strong>NOTE:</strong> For reference, remember the ground truth layers in this dataset <a href="practical-session-2.html#plot-tissue-map">that we plotted</a> at the beginning of this session.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="practical-session-2.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select library size threshold</span></span>
<span id="cb54-2"><a href="practical-session-2.html#cb54-2" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb54-3"><a href="practical-session-2.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb54-4"><a href="practical-session-2.html#cb54-4" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb54-5"><a href="practical-session-2.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb54-6"><a href="practical-session-2.html#cb54-6" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb54-7"><a href="practical-session-2.html#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="practical-session-2.html#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Check putative spatial patterns of removed spots</span></span>
<span id="cb54-9"><a href="practical-session-2.html#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(...)</span></code></pre></div>
</div>
<div id="percentage-of-mitochondrial-expression" class="section level3 hasAnchor" number="2.1.5">
<h3><span class="header-section-number">2.1.5</span> Percentage of mitochondrial expression<a href="practical-session-2.html#percentage-of-mitochondrial-expression" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As we briefly touched on at the beginning, a high proportion of mitochondrial reads indicates low cell quality, probably due to cell damage.</p>
<p>We calculated this data earlier on in this session, and can now investigate the percentage of mitochondrial expression across spots by looking at the column <code>subsets_mito_percent</code> in the <code>colData</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="practical-session-2.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Density and histogram of percentage of mitochondrial expression</span></span>
<span id="cb55-2"><a href="practical-session-2.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)),</span>
<span id="cb55-3"><a href="practical-session-2.html#cb55-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> subsets_mito_percent)) <span class="sc">+</span></span>
<span id="cb55-4"><a href="practical-session-2.html#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb55-5"><a href="practical-session-2.html#cb55-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb55-6"><a href="practical-session-2.html#cb55-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb55-7"><a href="practical-session-2.html#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb55-8"><a href="practical-session-2.html#cb55-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">1.0</span>,</span>
<span id="cb55-9"><a href="practical-session-2.html#cb55-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb55-10"><a href="practical-session-2.html#cb55-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb55-11"><a href="practical-session-2.html#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb55-12"><a href="practical-session-2.html#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb55-13"><a href="practical-session-2.html#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Percentage of mitochondrial expression&quot;</span>) <span class="sc">+</span> </span>
<span id="cb55-14"><a href="practical-session-2.html#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span> </span>
<span id="cb55-15"><a href="practical-session-2.html#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-mitoPercent-histo-1.png" width="672" /></p>
<p>In this instance, a higher percentage of mitochondrial expression is the thing to avoid, so the threshold is an upper bound, rather than the lower bounds we have observed so far. Our suggestion this time is to cut-off at 28%.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="practical-session-2.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot mitochondrial read proportion vs. number of cells per spot</span></span>
<span id="cb56-2"><a href="practical-session-2.html#cb56-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)), <span class="fu">aes</span>(<span class="at">x=</span>cell_count, <span class="at">y=</span>subsets_mito_percent)) <span class="sc">+</span></span>
<span id="cb56-3"><a href="practical-session-2.html#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb56-4"><a href="practical-session-2.html#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="practical-session-2.html#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">28</span>, <span class="at">colour=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span> </span>
<span id="cb56-6"><a href="practical-session-2.html#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb56-7"><a href="practical-session-2.html#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggMarginal</span>(p, <span class="at">type=</span><span class="st">&#39;histogram&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_mitoPercent-scatter-1.png" width="576" /></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="practical-session-2.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select expressed genes threshold</span></span>
<span id="cb57-2"><a href="practical-session-2.html#cb57-2" aria-hidden="true" tabindex="-1"></a>qc_mito <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>subsets_mito_percent <span class="sc">&gt;</span> <span class="dv">28</span></span>
<span id="cb57-3"><a href="practical-session-2.html#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb57-4"><a href="practical-session-2.html#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_mito)</span></code></pre></div>
<pre><code>## qc_mito
## FALSE  TRUE 
##  3622    17</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="practical-session-2.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb59-2"><a href="practical-session-2.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>qc_mito <span class="ot">&lt;-</span> qc_mito</span>
<span id="cb59-3"><a href="practical-session-2.html#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="practical-session-2.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for putative spatial pattern of removed spots</span></span>
<span id="cb59-5"><a href="practical-session-2.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb59-6"><a href="practical-session-2.html#cb59-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;qc_mito&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_mitoPercent-thresh-1.png" width="672" /></p>
<p>Again, try to illustrate what happens if we set the threshold too low (i.e., 20 0r 25%).</p>
<p><strong>NOTE:</strong> For reference, remember the ground truth layers in this dataset <a href="practical-session-2.html#plot-tissue-map">that we plotted</a> at the beginning of this session.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="practical-session-2.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select library size threshold</span></span>
<span id="cb60-2"><a href="practical-session-2.html#cb60-2" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb60-3"><a href="practical-session-2.html#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb60-4"><a href="practical-session-2.html#cb60-4" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb60-5"><a href="practical-session-2.html#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb60-6"><a href="practical-session-2.html#cb60-6" aria-hidden="true" tabindex="-1"></a>code...</span>
<span id="cb60-7"><a href="practical-session-2.html#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="practical-session-2.html#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Check putative spatial patterns of removed spots</span></span>
<span id="cb60-9"><a href="practical-session-2.html#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(...)</span></code></pre></div>
</div>
<div id="number-of-cells-per-spot" class="section level3 hasAnchor" number="2.1.6">
<h3><span class="header-section-number">2.1.6</span> Number of cells per spot<a href="practical-session-2.html#number-of-cells-per-spot" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As previously mentioned, number of cells per spot is an attribute that not all datasets include. Nonetheless, it can be useful to further control the quality of the dataset prior to any downstream analysis. Of course, the number of cells per spot depends on the tissue type and organism and according to <a href="https://kb.10xgenomics.com/hc/en-us/articles/360035487952-How-many-cells-are-captured-in-a-single-spot-">10X Genomics</a>, each spot typically contains between 0 and 10 cells.</p>
<p>The DPFLC dataset does contain information on the number of cells per spot (acquired by processing and cell segmentation of high-resolution histology images obtained prior on-slide cDNA synthesis, see <span class="citation">Maynard et al. (<a href="#ref-Maynard2021Mar" role="doc-biblioref">2021</a>)</span> for details). To investigate the number of cells in each spot looking for any outlier values that could indicate problems we need to take a look in the column <code>cell_count</code> in <code>colData</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="practical-session-2.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Density and histogram of the number of cells in each spot</span></span>
<span id="cb61-2"><a href="practical-session-2.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)),</span>
<span id="cb61-3"><a href="practical-session-2.html#cb61-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> cell_count)) <span class="sc">+</span></span>
<span id="cb61-4"><a href="practical-session-2.html#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb61-5"><a href="practical-session-2.html#cb61-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">binwidth =</span> <span class="dv">1</span>,</span>
<span id="cb61-6"><a href="practical-session-2.html#cb61-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb61-7"><a href="practical-session-2.html#cb61-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb61-8"><a href="practical-session-2.html#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb61-9"><a href="practical-session-2.html#cb61-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">1.5</span>,</span>
<span id="cb61-10"><a href="practical-session-2.html#cb61-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb61-11"><a href="practical-session-2.html#cb61-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb61-12"><a href="practical-session-2.html#cb61-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb61-13"><a href="practical-session-2.html#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb61-14"><a href="practical-session-2.html#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of cells per spot&quot;</span>) <span class="sc">+</span> </span>
<span id="cb61-15"><a href="practical-session-2.html#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span> </span>
<span id="cb61-16"><a href="practical-session-2.html#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-cellsPerSpot-histo-1.png" width="672" /></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="practical-session-2.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look at the values</span></span>
<span id="cb62-2"><a href="practical-session-2.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">colData</span>(spe)<span class="sc">$</span>cell_count)</span></code></pre></div>
<pre><code>## 
##   0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19 
##  84 211 483 623 617 541 421 287 140  92  50  25  18  10   9   3   8   2   1   2 
##  20  21  22  23  25  26  27 
##   3   2   1   1   2   2   1</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="practical-session-2.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot number of expressed genes vs. number of cells per spot</span></span>
<span id="cb64-2"><a href="practical-session-2.html#cb64-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">as.data.frame</span>(<span class="fu">colData</span>(spe)), <span class="fu">aes</span>(<span class="at">x=</span>cell_count, <span class="at">y=</span>detected)) <span class="sc">+</span></span>
<span id="cb64-3"><a href="practical-session-2.html#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb64-4"><a href="practical-session-2.html#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb64-5"><a href="practical-session-2.html#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">colour=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span> </span>
<span id="cb64-6"><a href="practical-session-2.html#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb64-7"><a href="practical-session-2.html#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggMarginal</span>(p, <span class="at">type=</span><span class="st">&#39;histogram&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_cellsPerSpot-scatter-1.png" width="576" /></p>
<p>As we can see from both the histogram and the scatter plot there is a tail of very high values, which could indicate problems for these spots. More specifically, we can see from the scatter plot that most of the spots with very high cell counts also tend to have lower numbers of expressed genes. This indicates problems with the experiment on these spots, and they should be removed.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="practical-session-2.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select expressed genes threshold</span></span>
<span id="cb65-2"><a href="practical-session-2.html#cb65-2" aria-hidden="true" tabindex="-1"></a>qc_cell_count <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>cell_count <span class="sc">&gt;</span> <span class="dv">10</span></span>
<span id="cb65-3"><a href="practical-session-2.html#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb65-4"><a href="practical-session-2.html#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_cell_count)</span></code></pre></div>
<pre><code>## qc_cell_count
## FALSE  TRUE 
##  3549    90</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="practical-session-2.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb67-2"><a href="practical-session-2.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>qc_cell_count <span class="ot">&lt;-</span> qc_cell_count</span>
<span id="cb67-3"><a href="practical-session-2.html#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="practical-session-2.html#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for putative spatial pattern of removed spots</span></span>
<span id="cb67-5"><a href="practical-session-2.html#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb67-6"><a href="practical-session-2.html#cb67-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;qc_cell_count&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_cellsPerSpot-thresh-1.png" width="672" /></p>
<p>While there is a spatial pattern to the discarded spots, it does not appear to be correlated with the known biological features (cortical layers). The discarded spots are typically at the edges of the tissue. It seems plausible that something has gone wrong with the cell segmentation on the edges of the images, so it makes sense to remove these spots.</p>
</div>
<div id="remove-low-quality-spots" class="section level3 hasAnchor" number="2.1.7">
<h3><span class="header-section-number">2.1.7</span> Remove low-quality spots<a href="practical-session-2.html#remove-low-quality-spots" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>All the steps so far have flagged spots with potential issues - before proceeding with analysis, we want to remove these spots from our SpatialExperiment object. Since we have calculated different spot-level QC metrics and selected thresholds for each one, we can combine them to identify a set of low-quality spots, and remove them from our <code>spe</code> object in a single step.</p>
<p>We can also check once more that the combined set of discarded spots does not correspond to any obvious biologically relevant group of spots.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="practical-session-2.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check the number of discarded spots for each metric</span></span>
<span id="cb68-2"><a href="practical-session-2.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">cbind</span>(qc_lib_size, qc_detected, qc_mito, qc_cell_count), <span class="dv">2</span>, sum)</span></code></pre></div>
<pre><code>##   qc_lib_size   qc_detected       qc_mito qc_cell_count 
##            11            11            17            90</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="practical-session-2.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine together the set of discarded spots</span></span>
<span id="cb70-2"><a href="practical-session-2.html#cb70-2" aria-hidden="true" tabindex="-1"></a>discard <span class="ot">&lt;-</span> qc_lib_size <span class="sc">|</span> qc_detected <span class="sc">|</span> qc_mito <span class="sc">|</span> qc_cell_count</span>
<span id="cb70-3"><a href="practical-session-2.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Store the set in the object</span></span>
<span id="cb70-4"><a href="practical-session-2.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>discard <span class="ot">&lt;-</span> discard</span>
<span id="cb70-5"><a href="practical-session-2.html#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="practical-session-2.html#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Check the spatial pattern of combined set of discarded spots</span></span>
<span id="cb70-7"><a href="practical-session-2.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb70-8"><a href="practical-session-2.html#cb70-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;discard&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_checkQC-thresh-1.png" width="672" /></p>
<p>Since this dataset has also manual annotation (<a href="practical-session-2.html#plot-tissue-map">remember</a>)) we see that there are locations that are not annotated (marked with <code>NA</code>). We could further remove those locations to reduce potential noise and further increase the quality of the dataset.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="practical-session-2.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select locations without annotation</span></span>
<span id="cb71-2"><a href="practical-session-2.html#cb71-2" aria-hidden="true" tabindex="-1"></a>qc_NA_spots <span class="ot">&lt;-</span> <span class="fu">is.na</span>(<span class="fu">colData</span>(spe)<span class="sc">$</span>ground_truth)</span>
<span id="cb71-3"><a href="practical-session-2.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine together the set of discarded spots</span></span>
<span id="cb71-4"><a href="practical-session-2.html#cb71-4" aria-hidden="true" tabindex="-1"></a>discard <span class="ot">&lt;-</span> qc_lib_size <span class="sc">|</span> qc_detected <span class="sc">|</span> qc_mito <span class="sc">|</span> qc_cell_count <span class="sc">|</span> qc_NA_spots</span>
<span id="cb71-5"><a href="practical-session-2.html#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Store the set in the object</span></span>
<span id="cb71-6"><a href="practical-session-2.html#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>discard <span class="ot">&lt;-</span> discard</span>
<span id="cb71-7"><a href="practical-session-2.html#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="practical-session-2.html#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Check the spatial pattern of combined set of discarded spots</span></span>
<span id="cb71-9"><a href="practical-session-2.html#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(spe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb71-10"><a href="practical-session-2.html#cb71-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;discard&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_notAnnotSpots-1.png" width="672" /></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="practical-session-2.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="do">## remove combined set of low-quality spots</span></span>
<span id="cb72-2"><a href="practical-session-2.html#cb72-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[, <span class="sc">!</span><span class="fu">colData</span>(spe)<span class="sc">$</span>discard]</span></code></pre></div>
</div>
</div>
<div id="normalisation-of-counts" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Normalisation of counts<a href="practical-session-2.html#normalisation-of-counts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="background" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Background<a href="practical-session-2.html#background" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Normalisation is applied in STx data for the same reason as any other RNA-Seq technique - the differences observed in the count data can arise from a range of systematic factors, not just a physiologically-relevant change in expression. The primary systematic effect is that of library size (or in the case of STx, counts/UMIs per spot). <code>scater</code> corrects for library size by scaling the sizes across all spots such that the mean library size is 1. Normalized counts are then calculated as a ratio of observed count to library size factor.</p>
<p>Secondly, a log-transformation is applied to the scaled counts - this transformation is commonly applied as it stabilises the variance across the range of transcriptomics data (otherwise the variance is dominated by highly expressed genes) and it facilitates comparisons of expression by rendering positive and negative changes symmetrical and found by subtraction rather than division. Since <span class="math inline">\(log2(0)\)</span> is undefined, a <em>pseudocount</em> is added to each observed count to avoid this error - a pseudocount of 1 is typically applied, as <span class="math inline">\(log2(0+1) = 0\)</span>.</p>
<p>Here we will be using methods from the <code>scater</code> <span class="citation">(<a href="#ref-McCarthy2017Apr" role="doc-biblioref">McCarthy et al. 2017</a>)</span> and <code>scran</code> <span class="citation">(<a href="#ref-Lun2016Oct" role="doc-biblioref">Lun, McCarthy, and Marioni 2016</a>)</span> packages that calculate logcounts using library size factors. The library size factors approach is arguably the simplest approach for STx data. Other approaches used in scRNA-seq are more difficult to justify their use in STx because of two main reasons:</p>
<ol style="list-style-type: decimal">
<li>Spots can contain multiple cells of different cell-types.</li>
<li>Datasets can include multiple tissue samples which will lead to different clusterings.</li>
</ol>
</div>
<div id="log-tranformation-of-counts" class="section level3 hasAnchor" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Log-tranformation of counts<a href="practical-session-2.html#log-tranformation-of-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="practical-session-2.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate library size factors</span></span>
<span id="cb73-2"><a href="practical-session-2.html#cb73-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">computeLibraryFactors</span>(spe)</span>
<span id="cb73-3"><a href="practical-session-2.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look at the size factors</span></span>
<span id="cb73-4"><a href="practical-session-2.html#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sizeFactors</span>(spe))</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1514  0.6326  0.9011  1.0000  1.2849  3.7500</code></pre>
<p>As described above, the mean size factor is 1.0.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="practical-session-2.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Density and histogram of library sizes</span></span>
<span id="cb75-2"><a href="practical-session-2.html#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">sFact =</span> <span class="fu">sizeFactors</span>(spe)), </span>
<span id="cb75-3"><a href="practical-session-2.html#cb75-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> sFact)) <span class="sc">+</span></span>
<span id="cb75-4"><a href="practical-session-2.html#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb75-5"><a href="practical-session-2.html#cb75-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb75-6"><a href="practical-session-2.html#cb75-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-7"><a href="practical-session-2.html#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb75-8"><a href="practical-session-2.html#cb75-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">1.0</span>,</span>
<span id="cb75-9"><a href="practical-session-2.html#cb75-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb75-10"><a href="practical-session-2.html#cb75-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-11"><a href="practical-session-2.html#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb75-12"><a href="practical-session-2.html#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb75-13"><a href="practical-session-2.html#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Library size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb75-14"><a href="practical-session-2.html#cb75-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span> </span>
<span id="cb75-15"><a href="practical-session-2.html#cb75-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_plot-labfact-histo-1.png" width="672" /></p>
<p>The log-transformation that takes place is a log2-transformation and in order to avoid <em>- Infinity</em> values we add a pseudo value of 1. Both the log2- transformation and the pseudocount of 1 are defaults in this method.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="practical-session-2.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate logcounts and store in the spe object</span></span>
<span id="cb76-2"><a href="practical-session-2.html#cb76-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(spe)</span>
<span id="cb76-3"><a href="practical-session-2.html#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="practical-session-2.html#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check that a new assay has been added</span></span>
<span id="cb76-5"><a href="practical-session-2.html#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="fu">assayNames</span>(spe)</span></code></pre></div>
<pre><code>## [1] &quot;counts&quot;    &quot;logcounts&quot;</code></pre>
</div>
</div>
<div id="selecting-genes" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Selecting genes<a href="practical-session-2.html#selecting-genes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="background-1" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Background<a href="practical-session-2.html#background-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Gene selection - or alternatively “feature selection” - is applied to identify genes that are likely to be informative for downstream analyses. The most common feature selection method is the definition of highly variable genes (HVGs). The assumption is that since we quality-controlled and normalised our dataset, the genes with high variability are the ones that contain high levels of biological variability too. Since here we have a spatial dataset we can also try to identify spatially variable genes too (SVGs).</p>
<p>It is important to note that HVGs are identified solely from the gene expression data. Spatial information does not play a role in finding HVGs. STx data pose a dilemma; does the meaningful spatial information reflect only spatial distribution of major cell types or does it reflect additional important spatial features? If we believe the former, relying on HVGs can be enough. If the second also holds true though, it is important to identify SVGs as well.</p>
</div>
<div id="highly-variable-genes-hvgs" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Highly Variable Genes (HVGs)<a href="practical-session-2.html#highly-variable-genes-hvgs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will be using methods from the <code>scran</code> package <span class="citation">(<a href="#ref-Lun2016Oct" role="doc-biblioref">Lun, McCarthy, and Marioni 2016</a>)</span> to identify a set of HVGs. Again, here we need to remember that <code>scran</code> methods were developed for scRNA-seq and we are performing the analysis under the assumption that the spots of an STx experiment can be treated as single cells.</p>
<p>In this dataset, the mitochondrial genes are too highly expressed and are not of major biological interest. As a result, if we are to identify true HVGs, we first need to remove the mitochondrial genes.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="practical-session-2.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Remove mitochondrial genes</span></span>
<span id="cb78-2"><a href="practical-session-2.html#cb78-2" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[<span class="sc">!</span>is_mito, ]</span></code></pre></div>
<p>Then, we apply methods from <code>scran</code> that give a list of HVGs, which can be used for further downstream analyses.</p>
<p>First we model the variance of the log-expression profiles for each gene, decomposing it into technical and biological components based on a fitted mean-variance trend.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="practical-session-2.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit mean-variance relationship</span></span>
<span id="cb79-2"><a href="practical-session-2.html#cb79-2" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(spe)</span>
<span id="cb79-3"><a href="practical-session-2.html#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualize mean-variance relationship</span></span>
<span id="cb79-4"><a href="practical-session-2.html#cb79-4" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">metadata</span>(dec)</span>
<span id="cb79-5"><a href="practical-session-2.html#cb79-5" aria-hidden="true" tabindex="-1"></a>fit_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mean =</span> fit<span class="sc">$</span>mean,</span>
<span id="cb79-6"><a href="practical-session-2.html#cb79-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">var =</span> fit<span class="sc">$</span>var,</span>
<span id="cb79-7"><a href="practical-session-2.html#cb79-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">trend =</span> fit<span class="sc">$</span><span class="fu">trend</span>(fit<span class="sc">$</span>mean))</span>
<span id="cb79-8"><a href="practical-session-2.html#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="practical-session-2.html#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> fit_df, </span>
<span id="cb79-10"><a href="practical-session-2.html#cb79-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> var)) <span class="sc">+</span> </span>
<span id="cb79-11"><a href="practical-session-2.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb79-12"><a href="practical-session-2.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> trend), <span class="at">colour =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb79-13"><a href="practical-session-2.html#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;mean of log-expression&quot;</span>,</span>
<span id="cb79-14"><a href="practical-session-2.html#cb79-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;variance of log-expression&quot;</span>) <span class="sc">+</span> </span>
<span id="cb79-15"><a href="practical-session-2.html#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_features_FitModel-1.png" width="672" /></p>
<p>The <code>trend</code> function that we used above is returned from the <code>modelGeneVar</code> function and returns the fitted value of the trend at any value of the mean. The “biological” variance of a gene is what remains when the fitted variance for a gene of that expression value is subtracted from the total variance (so genes above the blue trend line have a positive biological variance).</p>
<p>We select the top 10% of genes based on their biological variability The parameter <code>prop</code> defines how many HVGs we want. For example <code>prop = 0.1</code> returns the top 10% of genes. <code>prop = 1.0</code> would return all genes with a positive biological variability.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="practical-session-2.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select top HVGs</span></span>
<span id="cb80-2"><a href="practical-session-2.html#cb80-2" aria-hidden="true" tabindex="-1"></a>top_hvgs <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">prop =</span> <span class="fl">0.1</span>)</span>
<span id="cb80-3"><a href="practical-session-2.html#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="practical-session-2.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="do">## How many HVGs?</span></span>
<span id="cb80-5"><a href="practical-session-2.html#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(top_hvgs)</span></code></pre></div>
<pre><code>## [1] 1429</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="practical-session-2.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the HVGs on the mean:variance trend</span></span>
<span id="cb82-2"><a href="practical-session-2.html#cb82-2" aria-hidden="true" tabindex="-1"></a>fit_df <span class="ot">&lt;-</span> fit_df <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="practical-session-2.html#cb82-3" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;row.names&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-4"><a href="practical-session-2.html#cb82-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">topHVGs =</span> <span class="fu">ifelse</span>(row.names <span class="sc">%in%</span> top_hvgs, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb82-5"><a href="practical-session-2.html#cb82-5" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">column_to_rownames</span>(<span class="st">&quot;row.names&quot;</span>)</span>
<span id="cb82-6"><a href="practical-session-2.html#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="practical-session-2.html#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> fit_df,</span>
<span id="cb82-8"><a href="practical-session-2.html#cb82-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> var, <span class="at">colour =</span> topHVGs)) <span class="sc">+</span> </span>
<span id="cb82-9"><a href="practical-session-2.html#cb82-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb82-10"><a href="practical-session-2.html#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> trend), <span class="at">colour =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb82-11"><a href="practical-session-2.html#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb82-12"><a href="practical-session-2.html#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb82-13"><a href="practical-session-2.html#cb82-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">&quot;Variance of log-expression&quot;</span>,</span>
<span id="cb82-14"><a href="practical-session-2.html#cb82-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">colour =</span> <span class="st">&quot;Top HVGs&quot;</span>) <span class="sc">+</span> </span>
<span id="cb82-15"><a href="practical-session-2.html#cb82-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_features_selectHVGs-1.png" width="672" /></p>
<p><strong>NOTE</strong> - we will return to feature selection in the next practical, as it is a complicated process with significant impacts on the chosen downstream analysis.</p>
</div>
<div id="spatially-variable-genes-svgs" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Spatially variable genes (SVGs)<a href="practical-session-2.html#spatially-variable-genes-svgs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>SVGs are genes with a highly spatially correlated pattern of expression, which varies along with the spatial distribution of a tissue structure of interest. This phenomenon is also called <em>spatial autocorrelation</em> and underlies all types of spatial data, as we will discuss later.</p>
<p>The field of geography has developed some statistical measures to calculate spatial autocorrelation. Examples of these are Moran’s <em>I</em> <span class="citation">(<a href="#ref-Moran1950Jun" role="doc-biblioref"><span>“<span class="nocase">Notes on Continuous Stochastic Phenomena on JSTOR</span>”</span> 1950</a>)</span> and Geary’s <em>C</em> <span class="citation">(<a href="#ref-Geary1954Nov" role="doc-biblioref"><span>“<span class="nocase">The Contiguity Ratio and Statistical Mapping on JSTOR</span>”</span> 1954</a>)</span> that can be used to rank genes by the observed spatial autocorrelation to identify SVGs.</p>
<p>Several sophisticated new statistical methods to identify SVGs in STx data have also recently been developed. These include <a href="https://github.com/Teichlab/SpatialDE">SpatialDE</a> <span class="citation">(<a href="#ref-Svensson2018May" role="doc-biblioref">Svensson, Teichmann, and Stegle 2018</a>)</span>, <a href="https://xzhoulab.github.io/SPARK/">SPARK</a> <span class="citation">(<a href="#ref-Sun2020Feb" role="doc-biblioref">Sun, Zhu, and Zhou 2020</a>)</span>, and <a href="https://xzhoulab.github.io/SPARK/">SPARK-X</a> <span class="citation">(<a href="#ref-Zhu2021Dec" role="doc-biblioref">Zhu, Sun, and Zhou 2021</a>)</span>.</p>
</div>
<div id="integration-of-hvgs-and-svgs" class="section level3 hasAnchor" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> Integration of HVGs and SVGs<a href="practical-session-2.html#integration-of-hvgs-and-svgs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A recent benchmark paper <span class="citation">(<a href="#ref-Li2022Jan" role="doc-biblioref">Li et al. 2022</a>)</span> showed that integrating HVGs and SVGs to generate a combined set of features can improve downstream clustering performance in STx data. This confirms that SVGs contain additional biologically relevant information that is not captured by HVGs in these datasets. For example, a simple way to combine these features is to concatenate columns of principal components (PCs) calculated on the set of HVGs and the set of SVGs (excluding overlapping HVGs), and then using the combined set of features for further downstream analyses <span class="citation">(<a href="#ref-Li2022Jan" role="doc-biblioref">Li et al. 2022</a>)</span>.</p>
</div>
</div>
<div id="dimensionality-reduction" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> Dimensionality reduction<a href="practical-session-2.html#dimensionality-reduction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="background-2" class="section level3 hasAnchor" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> Background<a href="practical-session-2.html#background-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>STx data, just like bulk and single-cell transcriptomics, is captured in high-dimensional space. The reduction of this complexity can be helpful for a number of applications. Principal Components Analysis (PCA) assumes linearity in the data and has historically been used for dimensionality reduction. More modern techniques, such as Uniform Manifold Approximation and Projection (UMAP) <span class="citation">(<a href="#ref-McInnes2018Feb" role="doc-biblioref">McInnes, Healy, and Melville 2018</a>)</span> and t-Stochastic Neighbor Embedding (tSNE) <span class="citation">(<a href="#ref-vandermaaten08" role="doc-biblioref">Maaten and Hinton 2008</a>)</span> do not assume linearity and provide some performance advantages.</p>
<p>The main practical difference between the output of these techniques is that the distances between the data points in PCA space are interpretable and can be used for clustering, while the distances in a UMAP/tSNE embedding are not interpretable in this way. As a result, we will be using PCA to reduce the dimensions of our dataset to assist clustering and UMAP to further reduce the principal components (PCs) in a two-dimensional space and produce better visualisations for the PCA.</p>
<p>Dimensionality reduction prior to clustering has two main advantages, firstly it reduces dataset noise from random variation. Secondly it improves the computational efficiency of downstream analyses such as clustering. In an STx experiment, like the one we are analysing here, we have more than 3,000 spots and almost 1,500 HVGs. As as result, each spot has 1,500 attributes (dimensions) as a basis for subsequent clustering. This large number of variables that differentiate or cluster together spots gives rise to the <em>curse of dimensionality</em> <span class="citation">(<a href="#ref-Keogh2017Apr" role="doc-biblioref">Keogh and Mueen 2017</a>)</span>. This principle states that data points (spots) with a large number of features appear equidistant in attribute space resulting in poor clustering output.</p>
</div>
<div id="pca-principal-component-analysis" class="section level3 hasAnchor" number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> PCA: Principal component analysis<a href="practical-session-2.html#pca-principal-component-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will use an efficient implementation of PCA provided in the <code>scater</code> package <span class="citation">(<a href="#ref-McCarthy2017Apr" role="doc-biblioref">McCarthy et al. 2017</a>)</span> and retain the top 50 PCs for further downstream analyses. The random seed is required for reproducibility reasons because this implementation uses randomisation.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="practical-session-2.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set seed</span></span>
<span id="cb83-2"><a href="practical-session-2.html#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">987</span>)</span>
<span id="cb83-3"><a href="practical-session-2.html#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute PCA</span></span>
<span id="cb83-4"><a href="practical-session-2.html#cb83-4" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(spe, <span class="at">subset_row =</span> top_hvgs)</span>
<span id="cb83-5"><a href="practical-session-2.html#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Check correctness - names</span></span>
<span id="cb83-6"><a href="practical-session-2.html#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="fu">reducedDimNames</span>(spe)</span></code></pre></div>
<pre><code>## [1] &quot;PCA&quot;</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="practical-session-2.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check correctness - dimensions</span></span>
<span id="cb85-2"><a href="practical-session-2.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">reducedDim</span>(spe, <span class="st">&quot;PCA&quot;</span>))</span></code></pre></div>
<pre><code>## [1] 3511   50</code></pre>
</div>
<div id="umap-uniform-manifold-approximation-and-projection" class="section level3 hasAnchor" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> UMAP: Uniform Manifold Approximation and Projection<a href="practical-session-2.html#umap-uniform-manifold-approximation-and-projection" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will also run UMAP - using <code>scater</code>’s implementation - on the 50 PCs generated above and retain the top 2 UMAP components to visualise results.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="practical-session-2.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set seed</span></span>
<span id="cb87-2"><a href="practical-session-2.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">987</span>)</span>
<span id="cb87-3"><a href="practical-session-2.html#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute UMAP on top 50 PCs</span></span>
<span id="cb87-4"><a href="practical-session-2.html#cb87-4" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">runUMAP</span>(spe, <span class="at">dimred =</span> <span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb87-5"><a href="practical-session-2.html#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Check correctness - names</span></span>
<span id="cb87-6"><a href="practical-session-2.html#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">reducedDimNames</span>(spe)</span></code></pre></div>
<pre><code>## [1] &quot;PCA&quot;  &quot;UMAP&quot;</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="practical-session-2.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check correctness - dimensions</span></span>
<span id="cb89-2"><a href="practical-session-2.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">reducedDim</span>(spe, <span class="st">&quot;UMAP&quot;</span>))</span></code></pre></div>
<pre><code>## [1] 3511    2</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="practical-session-2.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Update column names for easier plotting</span></span>
<span id="cb91-2"><a href="practical-session-2.html#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(<span class="fu">reducedDim</span>(spe, <span class="st">&quot;UMAP&quot;</span>)) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;UMAP&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="umap-visualisations" class="section level3 hasAnchor" number="2.4.4">
<h3><span class="header-section-number">2.4.4</span> UMAP visualisations<a href="practical-session-2.html#umap-visualisations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can generate plots either using plotting functions from the <a href="https://bioconductor.org/packages/ggspavis">ggspavis</a> package or <a href="https://ggplot2.tidyverse.org/"><code>ggplot2</code></a> package. When clustering later, we will add cluster labels to these reduced dimension plots for an off-tissue visualisation.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="practical-session-2.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot top 2 PCA dimensions</span></span>
<span id="cb92-2"><a href="practical-session-2.html#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plotDimRed(spe, type = &quot;PCA&quot;)</span></span>
<span id="cb92-3"><a href="practical-session-2.html#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="practical-session-2.html#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(spe<span class="sc">@</span>int_colData<span class="sc">@</span>listData<span class="sc">$</span>reducedDims<span class="sc">$</span>PCA),</span>
<span id="cb92-5"><a href="practical-session-2.html#cb92-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">colour =</span> spe<span class="sc">@</span>colData<span class="sc">$</span>ground_truth)) <span class="sc">+</span> </span>
<span id="cb92-6"><a href="practical-session-2.html#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb92-7"><a href="practical-session-2.html#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_brewer</span>(<span class="at">type =</span> <span class="st">&quot;qual&quot;</span>) <span class="sc">+</span> </span>
<span id="cb92-8"><a href="practical-session-2.html#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Reduced dimensions: PCA&quot;</span>,</span>
<span id="cb92-9"><a href="practical-session-2.html#cb92-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;PC1&quot;</span>,</span>
<span id="cb92-10"><a href="practical-session-2.html#cb92-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;PC2&quot;</span>,</span>
<span id="cb92-11"><a href="practical-session-2.html#cb92-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Layers&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-12"><a href="practical-session-2.html#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb92-13"><a href="practical-session-2.html#cb92-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-14"><a href="practical-session-2.html#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot top 2 UMAP dimensions</span></span>
<span id="cb92-15"><a href="practical-session-2.html#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="co"># plotDimRed(spe, type = &quot;UMAP&quot;)</span></span>
<span id="cb92-16"><a href="practical-session-2.html#cb92-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-17"><a href="practical-session-2.html#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">as.data.frame</span>(spe<span class="sc">@</span>int_colData<span class="sc">@</span>listData<span class="sc">$</span>reducedDims<span class="sc">$</span>UMAP),</span>
<span id="cb92-18"><a href="practical-session-2.html#cb92-18" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> UMAP1, <span class="at">y =</span> UMAP2, <span class="at">colour =</span> spe<span class="sc">@</span>colData<span class="sc">$</span>ground_truth)) <span class="sc">+</span> </span>
<span id="cb92-19"><a href="practical-session-2.html#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb92-20"><a href="practical-session-2.html#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_brewer</span>(<span class="at">type =</span> <span class="st">&quot;qual&quot;</span>) <span class="sc">+</span> </span>
<span id="cb92-21"><a href="practical-session-2.html#cb92-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Reduced dimensions: UMAP&quot;</span>,</span>
<span id="cb92-22"><a href="practical-session-2.html#cb92-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;UMAP1&quot;</span>,</span>
<span id="cb92-23"><a href="practical-session-2.html#cb92-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;UMAP2&quot;</span>,</span>
<span id="cb92-24"><a href="practical-session-2.html#cb92-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Layers&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-25"><a href="practical-session-2.html#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/02_dimRed_UMAP-vis-1.png" width="576" /><img src="_main_files/figure-html/02_dimRed_UMAP-vis-2.png" width="576" /></p>
</div>
</div>
<div id="clustering" class="section level2 hasAnchor" number="2.5">
<h2><span class="header-section-number">2.5</span> Clustering<a href="practical-session-2.html#clustering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="background-3" class="section level3 hasAnchor" number="2.5.1">
<h3><span class="header-section-number">2.5.1</span> Background<a href="practical-session-2.html#background-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The clustering of observations into statistically similar groups is a well-established application in both bulk and single-cell RNA-Seq analysis. Clustering is a helpful tool because it structures and orders the data, allowing useful insights to be gained from complex, multivariate datasets and use those insights to classify the observed data or to generate hypotheses.</p>
<p>Common clustering methods are applied to ST data based on correlation or statistical distance of gene expression measurements. As we briefly mentioned above, the dimensionality of STx data means that sample distances in gene expression space tend to be small and not reliable for identifying clusters, so feature selection (gene selection) or dimensionality reduction approaches (i.e., PCA, UMAP) tend to be taken before clustering.</p>
<p>Common approaches to clustering gene expression data include k-means, hierarchical and Louvain algorithms, and all have been applied to the clustering of ST data. Some of these methods are implemented in some of the most popular single-cell analysis packages, such as <code>Seurat</code> <span class="citation">(<a href="#ref-Hao2021Jun" role="doc-biblioref">Hao et al. 2021</a>)</span> and <code>scran</code> <span class="citation">(<a href="#ref-Lun2016Oct" role="doc-biblioref">Lun, McCarthy, and Marioni 2016</a>)</span> and have been used for clustering in a number of ST studies.</p>
</div>
<div id="clustering-on-hvgs" class="section level3 hasAnchor" number="2.5.2">
<h3><span class="header-section-number">2.5.2</span> Clustering on HVGs<a href="practical-session-2.html#clustering-on-hvgs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we apply graph-based clustering to the top 50 PCs calculated on the set of selected HVGs, using the Walktrap method implemented in <code>scran</code> <span class="citation">(<a href="#ref-Lun2016Oct" role="doc-biblioref">Lun, McCarthy, and Marioni 2016</a>)</span>. To do so, we assume that (i) each spot is equal to a cell and (ii) we can detect from the gene expression the biologically informative spatial distribution patterns of cell types.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="practical-session-2.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set seed</span></span>
<span id="cb93-2"><a href="practical-session-2.html#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">987</span>)</span>
<span id="cb93-3"><a href="practical-session-2.html#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Set number of Nearest-Neighbours (NNs)</span></span>
<span id="cb93-4"><a href="practical-session-2.html#cb93-4" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb93-5"><a href="practical-session-2.html#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Build the k-NN graph</span></span>
<span id="cb93-6"><a href="practical-session-2.html#cb93-6" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">buildSNNGraph</span>(spe, <span class="at">k =</span> k, <span class="at">use.dimred =</span> <span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb93-7"><a href="practical-session-2.html#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Run walktrap clustering</span></span>
<span id="cb93-8"><a href="practical-session-2.html#cb93-8" aria-hidden="true" tabindex="-1"></a>g_walk <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">cluster_walktrap</span>(g)</span>
<span id="cb93-9"><a href="practical-session-2.html#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Get the cluster labels</span></span>
<span id="cb93-10"><a href="practical-session-2.html#cb93-10" aria-hidden="true" tabindex="-1"></a>clus <span class="ot">&lt;-</span> g_walk<span class="sc">$</span>membership</span>
<span id="cb93-11"><a href="practical-session-2.html#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many</span></span>
<span id="cb93-12"><a href="practical-session-2.html#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(clus)</span></code></pre></div>
<pre><code>## clus
##   1   2   3   4   5   6 
## 350 354 661 895 366 885</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="practical-session-2.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Store cluster labels in column &#39;label&#39; in colData</span></span>
<span id="cb95-2"><a href="practical-session-2.html#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colLabels</span>(spe) <span class="ot">&lt;-</span> <span class="fu">factor</span>(clus)</span></code></pre></div>
</div>
<div id="hvgs-clustering-visualisations" class="section level3 hasAnchor" number="2.5.3">
<h3><span class="header-section-number">2.5.3</span> HVGs clustering visualisations<a href="practical-session-2.html#hvgs-clustering-visualisations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can visualise the clusters in two ways:</p>
<ol style="list-style-type: decimal">
<li>plotting in spatial coordinates on the tissue map</li>
<li>plotting in the UMAP/PCA embeddings.</li>
</ol>
<p>We can use plotting functions either from the <a href="https://bioconductor.org/packages/ggspavis">ggspavis</a> package.</p>
<p>For reference, we will also display the ground truth (manually annotated) labels available for this dataset.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="practical-session-2.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot in tissue map</span></span>
<span id="cb96-2"><a href="practical-session-2.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpots</span>(spe, <span class="at">annotate =</span> <span class="st">&quot;label&quot;</span>, </span>
<span id="cb96-3"><a href="practical-session-2.html#cb96-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="st">&quot;libd_layer_colors&quot;</span>)</span>
<span id="cb96-4"><a href="practical-session-2.html#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="practical-session-2.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot ground truth in tissue map</span></span>
<span id="cb96-6"><a href="practical-session-2.html#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpots</span>(spe, <span class="at">annotate =</span> <span class="st">&quot;ground_truth&quot;</span>, </span>
<span id="cb96-7"><a href="practical-session-2.html#cb96-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="st">&quot;libd_layer_colors&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_clust_vis-map-1.png" width="50%" /><img src="_main_files/figure-html/02_clust_vis-map-2.png" width="50%" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="practical-session-2.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot clusters in PCA space</span></span>
<span id="cb97-2"><a href="practical-session-2.html#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDimRed</span>(spe, <span class="at">type =</span> <span class="st">&quot;PCA&quot;</span>, </span>
<span id="cb97-3"><a href="practical-session-2.html#cb97-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">annotate =</span> <span class="st">&quot;label&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;libd_layer_colors&quot;</span>)</span>
<span id="cb97-4"><a href="practical-session-2.html#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="practical-session-2.html#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot clusters in UMAP space</span></span>
<span id="cb97-6"><a href="practical-session-2.html#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDimRed</span>(spe, <span class="at">type =</span> <span class="st">&quot;UMAP&quot;</span>, </span>
<span id="cb97-7"><a href="practical-session-2.html#cb97-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">annotate =</span> <span class="st">&quot;label&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;libd_layer_colors&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_clust_vis-DimRed-1.png" width="50%" /><img src="_main_files/figure-html/02_clust_vis-DimRed-2.png" width="50%" /></p>
<p>From the visualizations, we can see that the clustering reproduces, to an extent, the known biological structure of the tissue, but not perfectly. One reason for this could be the fact that each spot may be comprised of a number different cells whose gene expression profiles are diluted in the overall profile of the spot, thus leading to low-quality clustering.</p>
</div>
<div id="spatially-aware-clustering" class="section level3 hasAnchor" number="2.5.4">
<h3><span class="header-section-number">2.5.4</span> Spatially-aware clustering<a href="practical-session-2.html#spatially-aware-clustering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In STx data, we can also perform clustering that takes spatial information into account, for example to identify spatially compact or spatially connected clusters.</p>
<p>A simple strategy is to perform graph-based clustering on a set of features (columns) that includes both molecular features (gene expression) and spatial features (x-y coordinates). In this case, a crucial tuning parameter is the relative amount of scaling between the two data modalities – if the scaling is chosen poorly, either the molecular or spatial features will dominate the clustering. Depending on data availability, further modalities could also be included. In this section, we will include some examples on this clustering approach.</p>
</div>
</div>
<div id="inter-cluster-differentially-expressed-genes-dges" class="section level2 hasAnchor" number="2.6">
<h2><span class="header-section-number">2.6</span> Inter-cluster differentially expressed genes (DGEs)<a href="practical-session-2.html#inter-cluster-differentially-expressed-genes-dges" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="background-4" class="section level3 hasAnchor" number="2.6.1">
<h3><span class="header-section-number">2.6.1</span> Background<a href="practical-session-2.html#background-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we will identify differentially expressed genes between clusters.</p>
<p>We will use the <code>findMarkers</code> implementation from the <code>scran</code> <span class="citation">(<a href="#ref-Lun2016Oct" role="doc-biblioref">Lun, McCarthy, and Marioni 2016</a>)</span>. This implementation uses a binomial test, which tests for genes that differ in the proportion expressed vs. not expressed between clusters. This is a more stringent test than the default <em>t</em>-tests, and tends to select genes that are easier to interpret and validate experimentally.</p>
</div>
<div id="dges-identification" class="section level3 hasAnchor" number="2.6.2">
<h3><span class="header-section-number">2.6.2</span> DGEs identification<a href="practical-session-2.html#dges-identification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="practical-session-2.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set gene names as row names ease of plotting</span></span>
<span id="cb98-2"><a href="practical-session-2.html#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(spe) <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spe)<span class="sc">$</span>gene_name</span>
<span id="cb98-3"><a href="practical-session-2.html#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Test for DGEs</span></span>
<span id="cb98-4"><a href="practical-session-2.html#cb98-4" aria-hidden="true" tabindex="-1"></a>markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(spe, <span class="at">test =</span> <span class="st">&quot;binom&quot;</span>, <span class="at">direction =</span> <span class="st">&quot;up&quot;</span>)</span>
<span id="cb98-5"><a href="practical-session-2.html#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Check output</span></span>
<span id="cb98-6"><a href="practical-session-2.html#cb98-6" aria-hidden="true" tabindex="-1"></a>markers</span></code></pre></div>
<pre><code>## List of length 6
## names(6): 1 2 3 4 5 6</code></pre>
<p>The output from the <code>findMarkers</code> implementation is a list of length equal to the number of clusters. Each element of the list contains the Log-Fold-Change (LogFC) of each gene between one cluster and all others.</p>
</div>
<div id="dges-visualisation" class="section level3 hasAnchor" number="2.6.3">
<h3><span class="header-section-number">2.6.3</span> DGEs visualisation<a href="practical-session-2.html#dges-visualisation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will plot LogFCs for cluster 1 against all other clusters</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="practical-session-2.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select cluster 1 genes</span></span>
<span id="cb100-2"><a href="practical-session-2.html#cb100-2" aria-hidden="true" tabindex="-1"></a>interesting <span class="ot">&lt;-</span> markers[[<span class="dv">1</span>]]</span>
<span id="cb100-3"><a href="practical-session-2.html#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Get the top genes</span></span>
<span id="cb100-4"><a href="practical-session-2.html#cb100-4" aria-hidden="true" tabindex="-1"></a>best_set <span class="ot">&lt;-</span> interesting[interesting<span class="sc">$</span>Top <span class="sc">&lt;=</span> <span class="dv">5</span>, ]</span>
<span id="cb100-5"><a href="practical-session-2.html#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate the effect</span></span>
<span id="cb100-6"><a href="practical-session-2.html#cb100-6" aria-hidden="true" tabindex="-1"></a>logFCs <span class="ot">&lt;-</span> <span class="fu">getMarkerEffects</span>(best_set)</span>
<span id="cb100-7"><a href="practical-session-2.html#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot a heat map</span></span>
<span id="cb100-8"><a href="practical-session-2.html#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(logFCs, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">length.out =</span> <span class="dv">101</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/02_dges_vis-clst1-1.png" width="50%" /></p>
<p>Below we will plot the log-transformed normalised expression of the top genes for one cluster alongside their expression in the other clusters.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="practical-session-2.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select genes</span></span>
<span id="cb101-2"><a href="practical-session-2.html#cb101-2" aria-hidden="true" tabindex="-1"></a>top_genes <span class="ot">&lt;-</span> <span class="fu">head</span>(<span class="fu">rownames</span>(interesting))</span>
<span id="cb101-3"><a href="practical-session-2.html#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot expression</span></span>
<span id="cb101-4"><a href="practical-session-2.html#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plotExpression</span>(spe, <span class="at">x =</span> <span class="st">&quot;label&quot;</span>, <span class="at">features =</span> top_genes)</span></code></pre></div>
<p><img src="_main_files/figure-html/02_dges_vis-2-1.png" width="672" /></p>
</div>
</div>
<div id="putting-it-all-together" class="section level2 hasAnchor" number="2.7">
<h2><span class="header-section-number">2.7</span> Putting it all together<a href="practical-session-2.html#putting-it-all-together" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="practical-session-2.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clear workspace from previous chapters</span></span>
<span id="cb102-2"><a href="practical-session-2.html#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all =</span> <span class="cn">TRUE</span>))</span>
<span id="cb102-3"><a href="practical-session-2.html#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="practical-session-2.html#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># LOAD DATA</span></span>
<span id="cb102-5"><a href="practical-session-2.html#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="practical-session-2.html#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SpatialExperiment)</span>
<span id="cb102-7"><a href="practical-session-2.html#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(STexampleData)</span>
<span id="cb102-8"><a href="practical-session-2.html#cb102-8" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">Visium_humanDLPFC</span>()</span>
<span id="cb102-9"><a href="practical-session-2.html#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="practical-session-2.html#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="co"># QUALITY CONTROL (QC)</span></span>
<span id="cb102-11"><a href="practical-session-2.html#cb102-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-12"><a href="practical-session-2.html#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb102-13"><a href="practical-session-2.html#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="co"># subset to keep only spots over tissue</span></span>
<span id="cb102-14"><a href="practical-session-2.html#cb102-14" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[, <span class="fu">colData</span>(spe)<span class="sc">$</span>in_tissue <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb102-15"><a href="practical-session-2.html#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co"># identify mitochondrial genes</span></span>
<span id="cb102-16"><a href="practical-session-2.html#cb102-16" aria-hidden="true" tabindex="-1"></a>is_mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;(^MT-)|(^mt-)&quot;</span>, <span class="fu">rowData</span>(spe)<span class="sc">$</span>gene_name)</span>
<span id="cb102-17"><a href="practical-session-2.html#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate per-spot QC metrics</span></span>
<span id="cb102-18"><a href="practical-session-2.html#cb102-18" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">addPerCellQC</span>(spe, <span class="at">subsets =</span> <span class="fu">list</span>(<span class="at">mito =</span> is_mito))</span>
<span id="cb102-19"><a href="practical-session-2.html#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="co"># select QC thresholds</span></span>
<span id="cb102-20"><a href="practical-session-2.html#cb102-20" aria-hidden="true" tabindex="-1"></a>qc_lib_size <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>sum <span class="sc">&lt;</span> <span class="dv">600</span></span>
<span id="cb102-21"><a href="practical-session-2.html#cb102-21" aria-hidden="true" tabindex="-1"></a>qc_detected <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>detected <span class="sc">&lt;</span> <span class="dv">400</span></span>
<span id="cb102-22"><a href="practical-session-2.html#cb102-22" aria-hidden="true" tabindex="-1"></a>qc_mito <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>subsets_mito_percent <span class="sc">&gt;</span> <span class="dv">28</span></span>
<span id="cb102-23"><a href="practical-session-2.html#cb102-23" aria-hidden="true" tabindex="-1"></a>qc_cell_count <span class="ot">&lt;-</span> <span class="fu">colData</span>(spe)<span class="sc">$</span>cell_count <span class="sc">&gt;</span> <span class="dv">10</span></span>
<span id="cb102-24"><a href="practical-session-2.html#cb102-24" aria-hidden="true" tabindex="-1"></a><span class="co"># combined set of discarded spots</span></span>
<span id="cb102-25"><a href="practical-session-2.html#cb102-25" aria-hidden="true" tabindex="-1"></a>discard <span class="ot">&lt;-</span> qc_lib_size <span class="sc">|</span> qc_detected <span class="sc">|</span> qc_mito <span class="sc">|</span> qc_cell_count</span>
<span id="cb102-26"><a href="practical-session-2.html#cb102-26" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(spe)<span class="sc">$</span>discard <span class="ot">&lt;-</span> discard</span>
<span id="cb102-27"><a href="practical-session-2.html#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="co"># filter low-quality spots</span></span>
<span id="cb102-28"><a href="practical-session-2.html#cb102-28" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[, <span class="sc">!</span><span class="fu">colData</span>(spe)<span class="sc">$</span>discard]</span>
<span id="cb102-29"><a href="practical-session-2.html#cb102-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-30"><a href="practical-session-2.html#cb102-30" aria-hidden="true" tabindex="-1"></a><span class="co"># NORMALIZATION</span></span>
<span id="cb102-31"><a href="practical-session-2.html#cb102-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-32"><a href="practical-session-2.html#cb102-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span>
<span id="cb102-33"><a href="practical-session-2.html#cb102-33" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate logcounts using library size factors</span></span>
<span id="cb102-34"><a href="practical-session-2.html#cb102-34" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(spe)</span>
<span id="cb102-35"><a href="practical-session-2.html#cb102-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-36"><a href="practical-session-2.html#cb102-36" aria-hidden="true" tabindex="-1"></a><span class="co"># FEATURE SELECTION</span></span>
<span id="cb102-37"><a href="practical-session-2.html#cb102-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-38"><a href="practical-session-2.html#cb102-38" aria-hidden="true" tabindex="-1"></a><span class="co"># remove mitochondrial genes</span></span>
<span id="cb102-39"><a href="practical-session-2.html#cb102-39" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> spe[<span class="sc">!</span>is_mito, ]</span>
<span id="cb102-40"><a href="practical-session-2.html#cb102-40" aria-hidden="true" tabindex="-1"></a><span class="co"># fit mean-variance relationship</span></span>
<span id="cb102-41"><a href="practical-session-2.html#cb102-41" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(spe)</span>
<span id="cb102-42"><a href="practical-session-2.html#cb102-42" aria-hidden="true" tabindex="-1"></a><span class="co"># select top HVGs</span></span>
<span id="cb102-43"><a href="practical-session-2.html#cb102-43" aria-hidden="true" tabindex="-1"></a>top_hvgs <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">prop =</span> <span class="fl">0.1</span>)</span>
<span id="cb102-44"><a href="practical-session-2.html#cb102-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-45"><a href="practical-session-2.html#cb102-45" aria-hidden="true" tabindex="-1"></a><span class="co"># DIMENSIONALITY REDUCTION</span></span>
<span id="cb102-46"><a href="practical-session-2.html#cb102-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-47"><a href="practical-session-2.html#cb102-47" aria-hidden="true" tabindex="-1"></a><span class="co"># compute PCA</span></span>
<span id="cb102-48"><a href="practical-session-2.html#cb102-48" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb102-49"><a href="practical-session-2.html#cb102-49" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(spe, <span class="at">subset_row =</span> top_hvgs)</span>
<span id="cb102-50"><a href="practical-session-2.html#cb102-50" aria-hidden="true" tabindex="-1"></a><span class="co"># compute UMAP on top 50 PCs</span></span>
<span id="cb102-51"><a href="practical-session-2.html#cb102-51" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb102-52"><a href="practical-session-2.html#cb102-52" aria-hidden="true" tabindex="-1"></a>spe <span class="ot">&lt;-</span> <span class="fu">runUMAP</span>(spe, <span class="at">dimred =</span> <span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb102-53"><a href="practical-session-2.html#cb102-53" aria-hidden="true" tabindex="-1"></a><span class="co"># update column names</span></span>
<span id="cb102-54"><a href="practical-session-2.html#cb102-54" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(<span class="fu">reducedDim</span>(spe, <span class="st">&quot;UMAP&quot;</span>)) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;UMAP&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb102-55"><a href="practical-session-2.html#cb102-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-56"><a href="practical-session-2.html#cb102-56" aria-hidden="true" tabindex="-1"></a><span class="co"># CLUSTERING</span></span>
<span id="cb102-57"><a href="practical-session-2.html#cb102-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-58"><a href="practical-session-2.html#cb102-58" aria-hidden="true" tabindex="-1"></a><span class="co"># graph-based clustering</span></span>
<span id="cb102-59"><a href="practical-session-2.html#cb102-59" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb102-60"><a href="practical-session-2.html#cb102-60" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb102-61"><a href="practical-session-2.html#cb102-61" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">buildSNNGraph</span>(spe, <span class="at">k =</span> k, <span class="at">use.dimred =</span> <span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb102-62"><a href="practical-session-2.html#cb102-62" aria-hidden="true" tabindex="-1"></a>g_walk <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">cluster_walktrap</span>(g)</span>
<span id="cb102-63"><a href="practical-session-2.html#cb102-63" aria-hidden="true" tabindex="-1"></a>clus <span class="ot">&lt;-</span> g_walk<span class="sc">$</span>membership</span>
<span id="cb102-64"><a href="practical-session-2.html#cb102-64" aria-hidden="true" tabindex="-1"></a><span class="fu">colLabels</span>(spe) <span class="ot">&lt;-</span> <span class="fu">factor</span>(clus)</span>
<span id="cb102-65"><a href="practical-session-2.html#cb102-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-66"><a href="practical-session-2.html#cb102-66" aria-hidden="true" tabindex="-1"></a><span class="co"># MARKER GENES</span></span>
<span id="cb102-67"><a href="practical-session-2.html#cb102-67" aria-hidden="true" tabindex="-1"></a><span class="co"># test for marker genes</span></span>
<span id="cb102-68"><a href="practical-session-2.html#cb102-68" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(spe) <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spe)<span class="sc">$</span>gene_name</span>
<span id="cb102-69"><a href="practical-session-2.html#cb102-69" aria-hidden="true" tabindex="-1"></a>markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(spe, <span class="at">test =</span> <span class="st">&quot;binom&quot;</span>, <span class="at">direction =</span> <span class="st">&quot;up&quot;</span>)</span></code></pre></div>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Amezquita2020Feb" class="csl-entry">
Amezquita, Robert A., Aaron T. L. Lun, Etienne Becht, Vince J. Carey, Lindsay N. Carpp, Ludwig Geistlinger, Federico Marini, et al. 2020. <span>“<span class="nocase">Orchestrating single-cell analysis with Bioconductor</span>.”</span> <em>Nat Methods</em> 17 (February): 137–45. <a href="https://doi.org/10.1038/s41592-019-0654-x">https://doi.org/10.1038/s41592-019-0654-x</a>.
</div>
<div id="ref-Hao2021Jun" class="csl-entry">
Hao, Yuhan, Stephanie Hao, Erica Andersen-Nissen, William M. Mauck, Shiwei Zheng, Andrew Butler, Maddie J. Lee, et al. 2021. <span>“<span class="nocase">Integrated analysis of multimodal single-cell data</span>.”</span> <em>Cell</em> 184 (13): 3573–3587.e29. <a href="https://doi.org/10.1016/j.cell.2021.04.048">https://doi.org/10.1016/j.cell.2021.04.048</a>.
</div>
<div id="ref-Keogh2017Apr" class="csl-entry">
Keogh, Eamonn, and Abdullah Mueen. 2017. <span>“<span class="nocase">Curse of Dimensionality</span>.”</span> In <em><span class="nocase">Encyclopedia of Machine Learning and Data Mining</span></em>, 314–15. Boston, MA, USA: Springer, Boston, MA. <a href="https://doi.org/10.1007/978-1-4899-7687-1_192">https://doi.org/10.1007/978-1-4899-7687-1_192</a>.
</div>
<div id="ref-Li2022Jan" class="csl-entry">
Li, Yijun, Stefan Stanojevic, Bing He, Zheng Jing, Qianhui Huang, Jian Kang, and Lana X. Garmire. 2022. <span>“<span class="nocase">Benchmarking Computational Integration Methods for Spatial Transcriptomics Data</span>.”</span> <em>bioRxiv</em>, January, 2021.08.27.457741. <a href="https://doi.org/10.1101/2021.08.27.457741">https://doi.org/10.1101/2021.08.27.457741</a>.
</div>
<div id="ref-Lun2016Oct" class="csl-entry">
Lun, Aaron T. L., Davis J. McCarthy, and John C. Marioni. 2016. <span>“<span class="nocase">A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor</span>.”</span> <em>F1000Research</em> 5 (2122): 2122. <a href="https://doi.org/10.12688/f1000research.9501.2">https://doi.org/10.12688/f1000research.9501.2</a>.
</div>
<div id="ref-vandermaaten08" class="csl-entry">
Maaten, Laurens van der, and Geoffrey Hinton. 2008. <span>“Visualizing Data Using t-SNE.”</span> <em>Journal of Machine Learning Research</em> 9 (86): 2579–2605. <a href="http://jmlr.org/papers/v9/vandermaaten08a.html">http://jmlr.org/papers/v9/vandermaaten08a.html</a>.
</div>
<div id="ref-Maynard2021Mar" class="csl-entry">
Maynard, Kristen R., Leonardo Collado-Torres, Lukas M. Weber, Cedric Uytingco, Brianna K. Barry, Stephen R. Williams, Joseph L. Catallini, et al. 2021. <span>“<span class="nocase">Transcriptome-scale spatial gene expression in the human dorsolateral prefrontal cortex</span>.”</span> <em>Nat Neurosci</em> 24 (March): 425–36. <a href="https://doi.org/10.1038/s41593-020-00787-0">https://doi.org/10.1038/s41593-020-00787-0</a>.
</div>
<div id="ref-McCarthy2017Apr" class="csl-entry">
McCarthy, Davis J., Kieran R. Campbell, Aaron T. L. Lun, and Quin F. Wills. 2017. <span>“<span class="nocase">Scater: pre-processing, quality control, normalization and visualization of single-cell RNA-seq data in R</span>.”</span> <em>Bioinformatics</em> 33 (8): 1179–86. <a href="https://doi.org/10.1093/bioinformatics/btw777">https://doi.org/10.1093/bioinformatics/btw777</a>.
</div>
<div id="ref-McInnes2018Feb" class="csl-entry">
McInnes, Leland, John Healy, and James Melville. 2018. <span>“<span class="nocase">UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</span>.”</span> <em>arXiv</em>, February. <a href="https://doi.org/10.48550/arXiv.1802.03426">https://doi.org/10.48550/arXiv.1802.03426</a>.
</div>
<div id="ref-Moran1950Jun" class="csl-entry">
<span>“<span class="nocase">Notes on Continuous Stochastic Phenomena on JSTOR</span>.”</span> 1950. <em>Biometrika</em>. <a href="https://www.jstor.org/stable/2332142">https://www.jstor.org/stable/2332142</a>.
</div>
<div id="ref-Sun2020Feb" class="csl-entry">
Sun, Shiquan, Jiaqiang Zhu, and Xiang Zhou. 2020. <span>“<span class="nocase">Statistical analysis of spatial expression patterns for spatially resolved transcriptomic studies</span>.”</span> <em>Nat Methods</em> 17 (February): 193–200. <a href="https://doi.org/10.1038/s41592-019-0701-7">https://doi.org/10.1038/s41592-019-0701-7</a>.
</div>
<div id="ref-Svensson2018May" class="csl-entry">
Svensson, Valentine, Sarah A. Teichmann, and Oliver Stegle. 2018. <span>“<span class="nocase">SpatialDE: identification of spatially variable genes</span>.”</span> <em>Nat Methods</em> 15 (May): 343–46. <a href="https://doi.org/10.1038/nmeth.4636">https://doi.org/10.1038/nmeth.4636</a>.
</div>
<div id="ref-Geary1954Nov" class="csl-entry">
<span>“<span class="nocase">The Contiguity Ratio and Statistical Mapping on JSTOR</span>.”</span> 1954. <em>Incorporated Statistician</em>. <a href="https://www.jstor.org/stable/2986645">https://www.jstor.org/stable/2986645</a>.
</div>
<div id="ref-ggspavis2023Apr" class="csl-entry">
Weber, Lukas M., and Helena L. Crowell. 2022. <em>Ggspavis: Visualization Functions for Spatially Resolved Transcriptomics Data</em>. <a href="https://github.com/lmweber/ggspavis">https://github.com/lmweber/ggspavis</a>.
</div>
<div id="ref-Zhu2021Dec" class="csl-entry">
Zhu, Jiaqiang, Shiquan Sun, and Xiang Zhou. 2021. <span>“<span class="nocase">SPARK-X: non-parametric modeling enables scalable and robust detection of spatial expression patterns for large spatial transcriptomic studies</span>.”</span> <em>Genome Biol</em> 22 (1): 1–25. <a href="https://doi.org/10.1186/s13059-021-02404-0">https://doi.org/10.1186/s13059-021-02404-0</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="practical-session-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="practical-session-3.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/02-stx-analysis.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
