<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Practical session 3 | Spatial transcriptomics data analysis: theory and practice</title>
  <meta name="description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Practical session 3 | Spatial transcriptomics data analysis: theory and practice" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  <meta name="github-repo" content="https://github.com/ncl-icbam/ismb-tutorial-2023.git" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Practical session 3 | Spatial transcriptomics data analysis: theory and practice" />
  
  <meta name="twitter:description" content="This book will guide you through the practical steps of the in-person tutorial IP2 for the ISMB/ECCB 2023 conference in Lyon named: Spatial transcriptomics data analysis: theory and practice." />
  

<meta name="author" content="Eleftherios Zormpas, Dr Simon J. Cockell" />


<meta name="date" content="2023-06-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="practical-session-2.html"/>
<link rel="next" href="practical-session-4.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial transcriptomics data analysis: theory and practice</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning objectives</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="practical-session-1.html"><a href="practical-session-1.html"><i class="fa fa-check"></i><b>1</b> Practical session 1</a>
<ul>
<li class="chapter" data-level="1.1" data-path="practical-session-1.html"><a href="practical-session-1.html#log-into-the-posit-cloud-server"><i class="fa fa-check"></i><b>1.1</b> Log into the Posit Cloud server</a></li>
<li class="chapter" data-level="1.2" data-path="practical-session-1.html"><a href="practical-session-1.html#import-10x-visium-data"><i class="fa fa-check"></i><b>1.2</b> Import 10X Visium data</a></li>
<li class="chapter" data-level="1.3" data-path="practical-session-1.html"><a href="practical-session-1.html#explore-data-types"><i class="fa fa-check"></i><b>1.3</b> Explore data types</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="practical-session-1.html"><a href="practical-session-1.html#spatialexperiment-class"><i class="fa fa-check"></i><b>1.3.1</b> SpatialExperiment class</a></li>
<li class="chapter" data-level="1.3.2" data-path="practical-session-1.html"><a href="practical-session-1.html#inspect-the-object"><i class="fa fa-check"></i><b>1.3.2</b> Inspect the object</a></li>
<li class="chapter" data-level="1.3.3" data-path="practical-session-1.html"><a href="practical-session-1.html#counts-table-and-gene-metadata"><i class="fa fa-check"></i><b>1.3.3</b> Counts table and gene metadata</a></li>
<li class="chapter" data-level="1.3.4" data-path="practical-session-1.html"><a href="practical-session-1.html#coordinates-table-and-spot-metadata"><i class="fa fa-check"></i><b>1.3.4</b> Coordinates table and spot metadata</a></li>
<li class="chapter" data-level="1.3.5" data-path="practical-session-1.html"><a href="practical-session-1.html#image-metadata"><i class="fa fa-check"></i><b>1.3.5</b> Image metadata</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="practical-session-2.html"><a href="practical-session-2.html"><i class="fa fa-check"></i><b>2</b> Practical session 2</a>
<ul>
<li class="chapter" data-level="2.1" data-path="practical-session-2.html"><a href="practical-session-2.html#spot-level-quality-control"><i class="fa fa-check"></i><b>2.1</b> Spot-level Quality Control</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="practical-session-2.html"><a href="practical-session-2.html#plot-tissue-map"><i class="fa fa-check"></i><b>2.1.1</b> Plot tissue map</a></li>
<li class="chapter" data-level="2.1.2" data-path="practical-session-2.html"><a href="practical-session-2.html#calculating-qc-metrics"><i class="fa fa-check"></i><b>2.1.2</b> Calculating QC metrics</a></li>
<li class="chapter" data-level="2.1.3" data-path="practical-session-2.html"><a href="practical-session-2.html#library-size-threshold-plot"><i class="fa fa-check"></i><b>2.1.3</b> Library size threshold plot</a></li>
<li class="chapter" data-level="2.1.4" data-path="practical-session-2.html"><a href="practical-session-2.html#number-of-expressed-genes"><i class="fa fa-check"></i><b>2.1.4</b> Number of expressed genes</a></li>
<li class="chapter" data-level="2.1.5" data-path="practical-session-2.html"><a href="practical-session-2.html#percentage-of-mitochondrial-expression"><i class="fa fa-check"></i><b>2.1.5</b> Percentage of mitochondrial expression</a></li>
<li class="chapter" data-level="2.1.6" data-path="practical-session-2.html"><a href="practical-session-2.html#number-of-cells-per-spot"><i class="fa fa-check"></i><b>2.1.6</b> Number of cells per spot</a></li>
<li class="chapter" data-level="2.1.7" data-path="practical-session-2.html"><a href="practical-session-2.html#remove-low-quality-spots"><i class="fa fa-check"></i><b>2.1.7</b> Remove low-quality spots</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="practical-session-2.html"><a href="practical-session-2.html#normalisation-of-counts"><i class="fa fa-check"></i><b>2.2</b> Normalisation of counts</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background"><i class="fa fa-check"></i><b>2.2.1</b> Background</a></li>
<li class="chapter" data-level="2.2.2" data-path="practical-session-2.html"><a href="practical-session-2.html#log-tranformation-of-counts"><i class="fa fa-check"></i><b>2.2.2</b> Log-tranformation of counts</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="practical-session-2.html"><a href="practical-session-2.html#selecting-genes"><i class="fa fa-check"></i><b>2.3</b> Selecting genes</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-1"><i class="fa fa-check"></i><b>2.3.1</b> Background</a></li>
<li class="chapter" data-level="2.3.2" data-path="practical-session-2.html"><a href="practical-session-2.html#highly-variable-genes-hvgs"><i class="fa fa-check"></i><b>2.3.2</b> Highly Variable Genes (HVGs)</a></li>
<li class="chapter" data-level="2.3.3" data-path="practical-session-2.html"><a href="practical-session-2.html#spatially-variable-genes-svgs"><i class="fa fa-check"></i><b>2.3.3</b> Spatially variable genes (SVGs)</a></li>
<li class="chapter" data-level="2.3.4" data-path="practical-session-2.html"><a href="practical-session-2.html#integration-of-hvgs-and-svgs"><i class="fa fa-check"></i><b>2.3.4</b> Integration of HVGs and SVGs</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="practical-session-2.html"><a href="practical-session-2.html#dimensionality-reduction"><i class="fa fa-check"></i><b>2.4</b> Dimensionality reduction</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-2"><i class="fa fa-check"></i><b>2.4.1</b> Background</a></li>
<li class="chapter" data-level="2.4.2" data-path="practical-session-2.html"><a href="practical-session-2.html#pca-principal-component-analysis"><i class="fa fa-check"></i><b>2.4.2</b> PCA: Principal component analysis</a></li>
<li class="chapter" data-level="2.4.3" data-path="practical-session-2.html"><a href="practical-session-2.html#umap-uniform-manifold-approximation-and-projection"><i class="fa fa-check"></i><b>2.4.3</b> UMAP: Uniform Manifold Approximation and Projection</a></li>
<li class="chapter" data-level="2.4.4" data-path="practical-session-2.html"><a href="practical-session-2.html#umap-visualisations"><i class="fa fa-check"></i><b>2.4.4</b> UMAP visualisations</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="practical-session-2.html"><a href="practical-session-2.html#clustering"><i class="fa fa-check"></i><b>2.5</b> Clustering</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-3"><i class="fa fa-check"></i><b>2.5.1</b> Background</a></li>
<li class="chapter" data-level="2.5.2" data-path="practical-session-2.html"><a href="practical-session-2.html#clustering-on-hvgs"><i class="fa fa-check"></i><b>2.5.2</b> Clustering on HVGs</a></li>
<li class="chapter" data-level="2.5.3" data-path="practical-session-2.html"><a href="practical-session-2.html#hvgs-clustering-visualisations"><i class="fa fa-check"></i><b>2.5.3</b> HVGs clustering visualisations</a></li>
<li class="chapter" data-level="2.5.4" data-path="practical-session-2.html"><a href="practical-session-2.html#spatially-aware-clustering"><i class="fa fa-check"></i><b>2.5.4</b> Spatially-aware clustering</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="practical-session-2.html"><a href="practical-session-2.html#inter-cluster-differentially-expressed-genes-dges"><i class="fa fa-check"></i><b>2.6</b> Inter-cluster differentially expressed genes (DGEs)</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="practical-session-2.html"><a href="practical-session-2.html#background-4"><i class="fa fa-check"></i><b>2.6.1</b> Background</a></li>
<li class="chapter" data-level="2.6.2" data-path="practical-session-2.html"><a href="practical-session-2.html#dges-identification"><i class="fa fa-check"></i><b>2.6.2</b> DGEs identification</a></li>
<li class="chapter" data-level="2.6.3" data-path="practical-session-2.html"><a href="practical-session-2.html#dges-visualisation"><i class="fa fa-check"></i><b>2.6.3</b> DGEs visualisation</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="practical-session-2.html"><a href="practical-session-2.html#other-visualisations"><i class="fa fa-check"></i><b>2.7</b> Other visualisations</a></li>
<li class="chapter" data-level="2.8" data-path="practical-session-2.html"><a href="practical-session-2.html#putting-it-all-together"><i class="fa fa-check"></i><b>2.8</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="practical-session-3.html"><a href="practical-session-3.html"><i class="fa fa-check"></i><b>3</b> Practical session 3</a>
<ul>
<li class="chapter" data-level="3.1" data-path="practical-session-3.html"><a href="practical-session-3.html#background-5"><i class="fa fa-check"></i><b>3.1</b> Background</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="practical-session-3.html"><a href="practical-session-3.html#main-geocomputatinal-data-structures"><i class="fa fa-check"></i><b>3.1.1</b> Main geocomputatinal data structures</a></li>
<li class="chapter" data-level="3.1.2" data-path="practical-session-3.html"><a href="practical-session-3.html#the-sf-objects"><i class="fa fa-check"></i><b>3.1.2</b> The <code>sf</code> objects</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="practical-session-3.html"><a href="practical-session-3.html#data-structures-preparation"><i class="fa fa-check"></i><b>3.2</b> Data structures preparation</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="practical-session-3.html"><a href="practical-session-3.html#load-new-dataset"><i class="fa fa-check"></i><b>3.2.1</b> Load new dataset</a></li>
<li class="chapter" data-level="3.2.2" data-path="practical-session-3.html"><a href="practical-session-3.html#create-point-geometries"><i class="fa fa-check"></i><b>3.2.2</b> Create point geometries</a></li>
<li class="chapter" data-level="3.2.3" data-path="practical-session-3.html"><a href="practical-session-3.html#tesselate-space"><i class="fa fa-check"></i><b>3.2.3</b> Tesselate space</a></li>
<li class="chapter" data-level="3.2.4" data-path="practical-session-3.html"><a href="practical-session-3.html#polygonise-the-tessellation"><i class="fa fa-check"></i><b>3.2.4</b> Polygonise the tessellation</a></li>
<li class="chapter" data-level="3.2.5" data-path="practical-session-3.html"><a href="practical-session-3.html#identify-neighbours"><i class="fa fa-check"></i><b>3.2.5</b> Identify neighbours</a></li>
<li class="chapter" data-level="3.2.6" data-path="practical-session-3.html"><a href="practical-session-3.html#generate-distance-matrices"><i class="fa fa-check"></i><b>3.2.6</b> Generate distance matrices</a></li>
<li class="chapter" data-level="3.2.7" data-path="practical-session-3.html"><a href="practical-session-3.html#putting-it-all-together-1"><i class="fa fa-check"></i><b>3.2.7</b> Putting it all together</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="practical-session-4.html"><a href="practical-session-4.html"><i class="fa fa-check"></i><b>4</b> Practical session 4</a>
<ul>
<li class="chapter" data-level="4.1" data-path="practical-session-4.html"><a href="practical-session-4.html#geographically-weighted-principal-components-analysis-gwpca"><i class="fa fa-check"></i><b>4.1</b> Geographically Weighted Principal Components Analysis (GWPCA)</a></li>
<li class="chapter" data-level="4.2" data-path="practical-session-4.html"><a href="practical-session-4.html#load-packages"><i class="fa fa-check"></i><b>4.2</b> Load packages</a></li>
<li class="chapter" data-level="4.3" data-path="practical-session-4.html"><a href="practical-session-4.html#load-quality-controled-and-normalised-data"><i class="fa fa-check"></i><b>4.3</b> Load Quality Controled and Normalised data</a></li>
<li class="chapter" data-level="4.4" data-path="practical-session-4.html"><a href="practical-session-4.html#data-prearation-and-single-gwpca-run"><i class="fa fa-check"></i><b>4.4</b> Data prearation and single GWPCA run</a></li>
<li class="chapter" data-level="4.5" data-path="practical-session-4.html"><a href="practical-session-4.html#run-gwpca"><i class="fa fa-check"></i><b>4.5</b> Run GWPCA</a></li>
<li class="chapter" data-level="4.6" data-path="practical-session-4.html"><a href="practical-session-4.html#plot-global-pca-results"><i class="fa fa-check"></i><b>4.6</b> Plot global PCA results</a></li>
<li class="chapter" data-level="4.7" data-path="practical-session-4.html"><a href="practical-session-4.html#identify-the-leading-genes-in-each-location"><i class="fa fa-check"></i><b>4.7</b> Identify the leading genes in each location</a></li>
<li class="chapter" data-level="4.8" data-path="practical-session-4.html"><a href="practical-session-4.html#percentage-of-total-variation-ptv"><i class="fa fa-check"></i><b>4.8</b> Percentage of Total Variation (PTV)</a></li>
<li class="chapter" data-level="4.9" data-path="practical-session-4.html"><a href="practical-session-4.html#identify-discrepancies"><i class="fa fa-check"></i><b>4.9</b> Identify discrepancies</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial transcriptomics data analysis: theory and practice</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="practical-session-3" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Practical session 3<a href="practical-session-3.html#practical-session-3" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This practical session will demonstrate the application of the most commonly used spatial analysis tools to STx data, and how we work with coordinate data alongside expression data.
## Load packages</p>
<ul>
<li><p><a href="https://cran.r-project.org/web/packages/spdep/index.html"><code>spdep</code></a> is a collection of functions to create spatial weights matrix objects from polygon <em>‘contiguities’</em>, from point patterns by distance and tessellations, for summarizing these objects, and for permitting their use in spatial data analysis like regional aggregation and tests for spatial <em>‘autocorrelation’</em>.</p></li>
<li><p><a href="https://cran.r-project.org/web/packages/sf/index.html"><code>sf</code></a> (<em>Simple Features for R</em>) is a package that offers support for simple features, a standardized way to encode spatial vector data.</p></li>
<li><p><a href="https://cran.r-project.org/web/packages/GWmodel/index.html"><code>GWmodel</code></a> is a suit of models that fit situations when data are not described well by some global model, but where there are spatial regions where a suitably localised calibration provides a better description.</p></li>
</ul>
<div id="background-5" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Background<a href="practical-session-3.html#background-5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="main-geocomputatinal-data-structures" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Main geocomputatinal data structures<a href="practical-session-3.html#main-geocomputatinal-data-structures" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are three main data structures that we need to have ready before we undertake a geocomputational approach to STx data analysis. Namely these are; (1) geometries (point and polygon), (2) neighbours lists and (3) distance matrices.</p>
<ol style="list-style-type: decimal">
<li><p>Spatial geometries can be points, lines, polygons and pixels. Polygons consist of a multitude of points connected by lines and can have many forms like circle, hexagon, non-canonical polygon etc.</p></li>
<li><p>Neighbour lists are special types of lists that contain information about the neighbours of each polygon. The neighbours can be defined either by adjacency or by distance.</p></li>
<li><p>Distance matrices contain the distances between different points and can be either weighted or un-weighted. The weighted distances are usually objective to each point and its neighbours. Meaning that the closer or farther a neighbour is from the point of focus, the weight of their distance changes according to an applied kernel. Usually in the case of STx data, like the ones generated by the 10X Visium platform, the un-weighted distance between is two points is in pixels and we acquire it from the <code>spaceranger</code> output.</p></li>
</ol>
</div>
<div id="the-sf-objects" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> The <code>sf</code> objects<a href="practical-session-3.html#the-sf-objects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Package <code>sf</code> represents simple features as native R objects. All functions and methods in <code>sf</code> that operate on spatial data are prefixed by <em>st_</em>, which refers to <em>spatial type</em>. Simple features are implemented as R native data, using simple data structures (S3 classes, lists, matrix, vector). Typical use involves reading, manipulating and writing of sets of features, with attributes and geometries.</p>
<p>As attributes are typically stored in <code>data.frame</code> objects (or the very similar <code>tbl_df</code>), we will also store feature geometries in a <code>data.frame</code> column. Since geometries are not single-valued, they are put in a list-column, a list of length equal to the number of records in the <code>data.frame</code>, with each list element holding the simple feature geometry of that feature. The three classes used to represent simple features are:</p>
<ul>
<li><code>sf</code>, the table (<code>data.frame</code>) with feature attributes and feature geometries, which contains</li>
<li><code>sfc</code>, the list-column with the geometries for each feature (record), which is composed of</li>
<li><code>sfg</code>, the feature geometry of an individual simple feature.</li>
</ul>
<div id="simple-feature-geometry-types" class="section level4 hasAnchor" number="3.1.2.1">
<h4><span class="header-section-number">3.1.2.1</span> Simple feature geometry types<a href="practical-session-3.html#simple-feature-geometry-types" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The following seven simple feature types are the most common:</p>
<table>
<colgroup>
<col width="7%" />
<col width="92%" />
</colgroup>
<thead>
<tr class="header">
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>POINT</code></td>
<td>zero-dimensional geometry containing a single point</td>
</tr>
<tr class="even">
<td><code>LINESTRING</code></td>
<td>sequence of points connected by straight, non-self intersecting line pieces; one-dimensional geometry</td>
</tr>
<tr class="odd">
<td><code>POLYGON</code></td>
<td>geometry with a positive area (two-dimensional); sequence of points form a closed, non-self intersecting ring; the first ring denotes the exterior ring, zero or more subsequent rings denote holes in this exterior ring</td>
</tr>
<tr class="even">
<td><code>MULTIPOINT</code></td>
<td>set of points; a MULTIPOINT is simple if no two Points in the MULTIPOINT are equal</td>
</tr>
<tr class="odd">
<td><code>MULTILINESTRING</code></td>
<td>set of linestrings</td>
</tr>
<tr class="even">
<td><code>MULTIPOLYGON</code></td>
<td>set of polygons</td>
</tr>
<tr class="odd">
<td><code>GEOMETRYCOLLECTION</code></td>
<td>set of geometries of any type except GEOMETRYCOLLECTION</td>
</tr>
</tbody>
</table>
<p>Each of the geometry types can also be a (typed) empty set, containing zero coordinates (for <code>POINT</code> the standard is not clear how to represent the empty geometry). Empty geometries can be thought of being the analogue to missing (<code>NA</code>) attributes, NULL values or empty lists.</p>
</div>
<div id="sf-objects-with-simple-features" class="section level4 hasAnchor" number="3.1.2.2">
<h4><span class="header-section-number">3.1.2.2</span> sf: objects with simple features<a href="practical-session-3.html#sf-objects-with-simple-features" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As we usually do not work with geometries of single <code>simple features</code>, but with datasets consisting of sets of features with attributes, the two are put together in <code>sf</code> (simple feature) objects. The following command reads a test dataset called <code>nc</code> from a file that is contained in the <code>sf</code> package:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="practical-session-3.html#cb91-1" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="at">package =</span> <span class="st">&quot;sf&quot;</span>))</span></code></pre></div>
<pre><code>## Reading layer `nc&#39; from data source 
##   `/home/sjcockell/R/x86_64-pc-linux-gnu-library/4.3/sf/shape/nc.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 100 features and 14 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## Geodetic CRS:  NAD27</code></pre>
<p>The short report printed gives the file name, the driver (ESRI Shapefile), mentions that there are 100 features (records, represented as rows) and 14 fields (attributes, represented as columns).</p>
<p>This object is of class:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="practical-session-3.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(nc)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<p>meaning it extends (and “is” a) <code>data.frame</code>, but with a single list-column with geometries, which is held in the column with name:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="practical-session-3.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(nc, <span class="st">&quot;sf_column&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;geometry&quot;</code></pre>
<p>If we print the first three features, we see their attribute values and an abridged version of the geometry</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="practical-session-3.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(nc[<span class="dv">9</span><span class="sc">:</span><span class="dv">15</span>], <span class="at">n =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>which would give the following output:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:Sf-overview"></span>
<img src="images/sf_xfig.png" alt="Overview of the `sf` object." width="100%" />
<p class="caption">
Figure 3.1: Overview of the <code>sf</code> object.
</p>
</div>
<p>In the output we see:</p>
<ul>
<li>in green a simple feature: a single record, or <code>data.frame</code> row, consisting of attributes and geometry</li>
<li>in blue a single simple feature geometry (an object of class <code>sfg</code>)</li>
<li>in red a simple feature list-column (an object of class <code>sfc</code>, which is a column in the <code>data.frame</code>)</li>
<li>that although geometries are native R objects, they are printed as <a href="#wkb">well-known text</a></li>
</ul>
<p>It is also possible to create <code>data.frame</code> objects with geometry list-columns that are not of class <code>sf</code>, e.g. by:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="practical-session-3.html#cb98-1" aria-hidden="true" tabindex="-1"></a>nc.no_sf <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(nc)</span>
<span id="cb98-2"><a href="practical-session-3.html#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(nc.no_sf)</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<p>However, such objects:</p>
<ul>
<li>no longer register which column is the geometry list-column</li>
<li>no longer have a plot method, and</li>
<li>lack all of the other dedicated methods for class <code>sf</code></li>
</ul>
</div>
<div id="sfc-simple-feature-geometry-list-column" class="section level4 hasAnchor" number="3.1.2.3">
<h4><span class="header-section-number">3.1.2.3</span> sfc: simple feature geometry list-column<a href="practical-session-3.html#sfc-simple-feature-geometry-list-column" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The column in the <code>sf</code> data.frame that contains the geometries is a list, of class <code>sfc</code>. We can retrieve the geometry list-column in this case by using standard <code>data.frame</code> notation like <code>nc$geom</code> or <code>nc[[15]]</code>, but the more general way uses <code>st_geometry</code>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="practical-session-3.html#cb100-1" aria-hidden="true" tabindex="-1"></a>(nc_geom <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(nc))</span></code></pre></div>
<pre><code>## Geometry set for 100 features 
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## Geodetic CRS:  NAD27
## First 5 geometries:</code></pre>
<pre><code>## MULTIPOLYGON (((-81.47276 36.23436, -81.54084 3...</code></pre>
<pre><code>## MULTIPOLYGON (((-81.23989 36.36536, -81.24069 3...</code></pre>
<pre><code>## MULTIPOLYGON (((-80.45634 36.24256, -80.47639 3...</code></pre>
<pre><code>## MULTIPOLYGON (((-76.00897 36.3196, -76.01735 36...</code></pre>
<pre><code>## MULTIPOLYGON (((-77.21767 36.24098, -77.23461 3...</code></pre>
<p>Geometries are printed in abbreviated form, but we can view a complete geometry by selecting it, e.g. the first one by:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="practical-session-3.html#cb107-1" aria-hidden="true" tabindex="-1"></a>nc_geom[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## MULTIPOLYGON (((-81.47276 36.23436, -81.54084 36.27251, -81.56198 36.27359, -81.63306 36.34069, -81.74107 36.39178, -81.69828 36.47178, -81.7028 36.51934, -81.67 36.58965, -81.3453 36.57286, -81.34754 36.53791, -81.32478 36.51368, -81.31332 36.4807, -81.26624 36.43721, -81.26284 36.40504, -81.24069 36.37942, -81.23989 36.36536, -81.26424 36.35241, -81.32899 36.3635, -81.36137 36.35316, -81.36569 36.33905, -81.35413 36.29972, -81.36745 36.2787, -81.40639 36.28505, -81.41233 36.26729, -81.43104 36.26072, -81.45289 36.23959, -81.47276 36.23436)))</code></pre>
<p>The way this is printed is called <em>well-known text</em>, and is part of the standards. The word <code>MULTIPOLYGON</code> is followed by three parentheses, because it can consist of multiple polygons, in the form of <code>MULTIPOLYGON(POL1,POL2)</code>, where <code>POL1</code> might consist of an exterior ring and zero or more interior rings, as of <code>(EXT1,HOLE1,HOLE2)</code>. Sets of coordinates are held together with parentheses, so we get <code>((crds_ext)(crds_hole1)(crds_hole2))</code> where <code>crds_</code> is a comma-separated set of coordinates of a ring. This leads to the case above, where <code>MULTIPOLYGON(((crds_ext)))</code> refers to the exterior ring (1), without holes (2), of the first polygon (3) - hence three parentheses.</p>
<p>We can see there is a single polygon with no rings:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="practical-session-3.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb109-2"><a href="practical-session-3.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nc[<span class="dv">1</span>], <span class="at">reset =</span> <span class="cn">FALSE</span>) <span class="co"># reset = FALSE: we want to add to a plot with a legend</span></span>
<span id="cb109-3"><a href="practical-session-3.html#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nc[<span class="dv">1</span>,<span class="dv">1</span>], <span class="at">col =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/03_sfc_Test3-1.png" width="672" /></p>
<p>Following the <code>MULTIPOLYGON</code> data structure, in R we have a list of lists of lists of matrices. For instance,
we get the first 3 coordinate pairs of the second exterior ring (first ring is always exterior) for the geometry
of feature 4 by:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="practical-session-3.html#cb110-1" aria-hidden="true" tabindex="-1"></a>nc_geom[[<span class="dv">4</span>]][[<span class="dv">2</span>]][[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]</span></code></pre></div>
<pre><code>##           [,1]     [,2]
## [1,] -76.02717 36.55672
## [2,] -75.99866 36.55665
## [3,] -75.91192 36.54253</code></pre>
<p>Geometry columns have their own class,</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="practical-session-3.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(nc_geom)</span></code></pre></div>
<pre><code>## [1] &quot;sfc_MULTIPOLYGON&quot; &quot;sfc&quot;</code></pre>
</div>
<div id="sfg-simple-feature-geometry" class="section level4 hasAnchor" number="3.1.2.4">
<h4><span class="header-section-number">3.1.2.4</span> sfg: simple feature geometry<a href="practical-session-3.html#sfg-simple-feature-geometry" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple feature geometry (<code>sfg</code>) objects carry the geometry for a single feature, e.g. a point, linestring or polygon.</p>
<p>Simple feature geometries are implemented as R native data, using the following rules</p>
<ol style="list-style-type: decimal">
<li>a single POINT is a numeric vector</li>
<li>a set of points, e.g. in a LINESTRING or ring of a POLYGON is a <code>matrix</code>, each row containing a point</li>
<li>any other set is a <code>list</code></li>
</ol>
<p>The below figure illustrates the different types of geometries:</p>
<p><img src="_main_files/figure-html/03_sf_Test7-1.png" width="672" /></p>
<p>Geometries can also be empty, as in</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="practical-session-3.html#cb114-1" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> <span class="fu">st_geometrycollection</span>())</span>
<span id="cb114-2"><a href="practical-session-3.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOMETRYCOLLECTION EMPTY</span></span>
<span id="cb114-3"><a href="practical-session-3.html#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(x)</span>
<span id="cb114-4"><a href="practical-session-3.html#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0</span></span></code></pre></div>
<p><em>The above are taken from the very well written, well-descriptive and thorough <code>sf</code> package <a href="https://cran.r-project.org/web/packages/sf/vignettes/sf1.html">vignette</a>.</em></p>
</div>
</div>
</div>
<div id="data-structures-preparation" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Data structures preparation<a href="practical-session-3.html#data-structures-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For this practical we will be using a human steatotic kidney dataset from the <a href="https://livercellatlas.org/index.php">Liver Atlas</a> <span class="citation">(<a href="#ref-GUILLIAMS2022379" role="doc-biblioref">Guilliams et al. 2022</a>)</span>. Specifically we will use the JBO019 sample.</p>
<div id="load-new-dataset" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Load new dataset<a href="practical-session-3.html#load-new-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First we generate the <code>SpatialFeaturesExperiment</code> object which is an extension of the <code>SpatialExperiment</code> (SPE) object that we used in the 2nd practical session. The difference is that the SFE object has incorporated the <code>sf</code> object structure and thus can accommodate the use of geocomputational tools.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="practical-session-3.html#cb115-1" aria-hidden="true" tabindex="-1"></a>sampleDir <span class="ot">&lt;-</span> <span class="st">&quot;./data/spaceranger_outs/Human_Liver_Steatotic/JBO019_Results&quot;</span></span>
<span id="cb115-2"><a href="practical-session-3.html#cb115-2" aria-hidden="true" tabindex="-1"></a>sampleNames <span class="ot">&lt;-</span> <span class="st">&quot;JBO019&quot;</span></span>
<span id="cb115-3"><a href="practical-session-3.html#cb115-3" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">read10xVisiumSFE</span>(<span class="at">samples =</span> sampleDir, </span>
<span id="cb115-4"><a href="practical-session-3.html#cb115-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sample_id =</span> sampleNames, </span>
<span id="cb115-5"><a href="practical-session-3.html#cb115-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="st">&quot;sparse&quot;</span>, </span>
<span id="cb115-6"><a href="practical-session-3.html#cb115-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="st">&quot;filtered&quot;</span>, </span>
<span id="cb115-7"><a href="practical-session-3.html#cb115-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">images =</span> <span class="st">&quot;lowres&quot;</span>, </span>
<span id="cb115-8"><a href="practical-session-3.html#cb115-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">style =</span> <span class="st">&quot;W&quot;</span>, </span>
<span id="cb115-9"><a href="practical-session-3.html#cb115-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb115-10"><a href="practical-session-3.html#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="practical-session-3.html#cb115-11" aria-hidden="true" tabindex="-1"></a>ground_truth <span class="ot">&lt;-</span> <span class="fu">read_table</span>(<span class="st">&quot;./data/spotzonationGroup.txt&quot;</span>)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   Barcode = col_character(),
##   sample_id = col_character(),
##   annotation = col_character()
## )</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="practical-session-3.html#cb117-1" aria-hidden="true" tabindex="-1"></a>is_mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">&quot;(^MT-)|(^mt-)&quot;</span>, <span class="fu">rowData</span>(sfe)<span class="sc">$</span>symbol)</span>
<span id="cb117-2"><a href="practical-session-3.html#cb117-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">addPerLocQC</span>(sfe, <span class="at">gTruth =</span> ground_truth, <span class="at">assay =</span> <span class="st">&quot;counts&quot;</span>, <span class="dv">2</span>, <span class="at">subsets =</span> <span class="fu">list</span>(<span class="at">mito =</span> is_mito))</span>
<span id="cb117-3"><a href="practical-session-3.html#cb117-3" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">addGeometries</span>(sfe, <span class="at">samples =</span> sampleDir, <span class="at">sample_id =</span> sampleNames, <span class="at">res =</span> <span class="st">&quot;fullres&quot;</span>)</span>
<span id="cb117-4"><a href="practical-session-3.html#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="practical-session-3.html#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb117-6"><a href="practical-session-3.html#cb117-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">geometry =</span> <span class="fu">colGeometries</span>(sfe)<span class="sc">$</span>spotHex<span class="sc">$</span>geometry, <span class="at">fill =</span> <span class="fu">colData</span>(sfe)<span class="sc">$</span>annotation)) <span class="sc">+</span> </span>
<span id="cb117-7"><a href="practical-session-3.html#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb117-8"><a href="practical-session-3.html#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> </span>
<span id="cb117-9"><a href="practical-session-3.html#cb117-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Annotation&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/03_QC_sfe-1.png" width="672" /></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="practical-session-3.html#cb118-1" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">addPerGeneQC</span>(sfe, <span class="at">assay =</span> <span class="st">&quot;counts&quot;</span>, <span class="at">version =</span> <span class="dv">92</span>)</span>
<span id="cb118-2"><a href="practical-session-3.html#cb118-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">get.spatialNeighGraphs</span>(sfe, sampleNames, <span class="at">type =</span> <span class="st">&quot;knearneigh&quot;</span>, <span class="at">style =</span> <span class="st">&quot;W&quot;</span>, <span class="at">distMod =</span> <span class="st">&quot;raw&quot;</span>, <span class="at">k =</span> <span class="dv">6</span>)</span>
<span id="cb118-3"><a href="practical-session-3.html#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="practical-session-3.html#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="practical-session-3.html#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sfe)</span></code></pre></div>
<pre><code>## DataFrame with 1185 rows and 15 columns
##                               Barcode   sample_id in_tissue array_row array_col
##                           &lt;character&gt; &lt;character&gt; &lt;logical&gt; &lt;integer&gt; &lt;integer&gt;
## AAACAAGTATCTCCCA-1 AAACAAGTATCTCCCA-1      JBO019      TRUE        50       102
## AAACATTTCCCGGATT-1 AAACATTTCCCGGATT-1      JBO019      TRUE        61        97
## AAACCCGAACGAAATC-1 AAACCCGAACGAAATC-1      JBO019      TRUE        45       115
## AAACGAGACGGTTGAT-1 AAACGAGACGGTTGAT-1      JBO019      TRUE        35        79
## AAACTAACGTGGCGAC-1 AAACTAACGTGGCGAC-1      JBO019      TRUE         8       110
## ...                               ...         ...       ...       ...       ...
## TTGTAATCCGTACTCG-1 TTGTAATCCGTACTCG-1      JBO019      TRUE        35        55
## TTGTGAACCTAATCCG-1 TTGTGAACCTAATCCG-1      JBO019      TRUE        56        90
## TTGTGCAGCCACGTCA-1 TTGTGCAGCCACGTCA-1      JBO019      TRUE        60        74
## TTGTGTTTCCCGAAAG-1 TTGTGTTTCCCGAAAG-1      JBO019      TRUE        51        59
## TTGTTGTGTGTCAAGA-1 TTGTTGTGTGTCAAGA-1      JBO019      TRUE        31        77
##                      Capt_area  annotation       index  sparsity       sum
##                    &lt;character&gt; &lt;character&gt; &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;
## AAACAAGTATCTCCCA-1           1          NA      spot_1  0.910410     13443
## AAACATTTCCCGGATT-1           1          NA      spot_2  0.967805      2648
## AAACCCGAACGAAATC-1           1         Mid      spot_3  0.864958     27733
## AAACGAGACGGTTGAT-1           1     Central      spot_4  0.835818     32973
## AAACTAACGTGGCGAC-1           1          NA      spot_5  0.995418       400
## ...                        ...         ...         ...       ...       ...
## TTGTAATCCGTACTCG-1           1          NA   spot_1181  0.933716      7612
## TTGTGAACCTAATCCG-1           1          NA   spot_1182  0.955831      4299
## TTGTGCAGCCACGTCA-1           1          NA   spot_1183  0.978252      1452
## TTGTGTTTCCCGAAAG-1           1          NA   spot_1184  0.956778      3831
## TTGTTGTGTGTCAAGA-1           1         Mid   spot_1185  0.852160     27755
##                     detected subsets_mito_sum subsets_mito_detected
##                    &lt;integer&gt;        &lt;numeric&gt;             &lt;integer&gt;
## AAACAAGTATCTCCCA-1      2933             1021                    12
## AAACATTTCCCGGATT-1      1054              285                    12
## AAACCCGAACGAAATC-1      4421             2087                    12
## AAACGAGACGGTTGAT-1      5375              821                    12
## AAACTAACGTGGCGAC-1       150              182                    11
## ...                      ...              ...                   ...
## TTGTAATCCGTACTCG-1      2170              733                    11
## TTGTGAACCTAATCCG-1      1446              515                    12
## TTGTGCAGCCACGTCA-1       712               54                    10
## TTGTGTTTCCCGAAAG-1      1415              422                    11
## TTGTTGTGTGTCAAGA-1      4840              906                    12
##                    subsets_mito_percent     total
##                               &lt;numeric&gt; &lt;numeric&gt;
## AAACAAGTATCTCCCA-1              7.59503     13443
## AAACATTTCCCGGATT-1             10.76284      2648
## AAACCCGAACGAAATC-1              7.52533     27733
## AAACGAGACGGTTGAT-1              2.48992     32973
## AAACTAACGTGGCGAC-1             45.50000       400
## ...                                 ...       ...
## TTGTAATCCGTACTCG-1              9.62953      7612
## TTGTGAACCTAATCCG-1             11.97953      4299
## TTGTGCAGCCACGTCA-1              3.71901      1452
## TTGTGTTTCCCGAAAG-1             11.01540      3831
## TTGTTGTGTGTCAAGA-1              3.26428     27755</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="practical-session-3.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(sfe)</span></code></pre></div>
<pre><code>## DataFrame with 32738 rows and 21 columns
##                              id   gene_name        biotype
##                     &lt;character&gt; &lt;character&gt;    &lt;character&gt;
## ENSG00000243485 ENSG00000243485 MIR1302-2HG        lincRNA
## ENSG00000237613 ENSG00000237613     FAM138A        lincRNA
## ENSG00000186092 ENSG00000186092       OR4F5 protein_coding
## ENSG00000238009 ENSG00000238009  AL627309.1        lincRNA
## ENSG00000239945 ENSG00000239945  AL627309.3        lincRNA
## ...                         ...         ...            ...
## ENSG00000215635 ENSG00000215635          NA             NA
## ENSG00000268590 ENSG00000268590          NA             NA
## ENSG00000251180 ENSG00000251180          NA             NA
## ENSG00000215616 ENSG00000215616          NA             NA
## ENSG00000215611 ENSG00000215611          NA             NA
##                            description       symbol       mean  detected
##                            &lt;character&gt;  &lt;character&gt;  &lt;numeric&gt; &lt;numeric&gt;
## ENSG00000243485    MIR1302-2 host gene   MIR1302-10 0.00000000  0.000000
## ENSG00000237613 family with sequence..      FAM138A 0.00000000  0.000000
## ENSG00000186092 olfactory receptor f..        OR4F5 0.00000000  0.000000
## ENSG00000238009                        RP11-34P13.7 0.00590717  0.590717
## ENSG00000239945                        RP11-34P13.8 0.00000000  0.000000
## ...                                ...          ...        ...       ...
## ENSG00000215635                     NA   AC145205.1          0         0
## ENSG00000268590                     NA        BAGE5          0         0
## ENSG00000251180                     NA   CU459201.1          0         0
## ENSG00000215616                     NA   AC002321.2          0         0
## ENSG00000215611                     NA   AC002321.1          0         0
##                     total JBO019.sparsity JBO019.total JBO019.nLocations
##                 &lt;numeric&gt;       &lt;numeric&gt;    &lt;numeric&gt;         &lt;integer&gt;
## ENSG00000243485         0        1.000000            0                 0
## ENSG00000237613         0        1.000000            0                 0
## ENSG00000186092         0        1.000000            0                 0
## ENSG00000238009         7        0.994093            7                 7
## ENSG00000239945         0        1.000000            0                 0
## ...                   ...             ...          ...               ...
## ENSG00000215635         0               1            0                 0
## ENSG00000268590         0               1            0                 0
## ENSG00000251180         0               1            0                 0
## ENSG00000215616         0               1            0                 0
## ENSG00000215611         0               1            0                 0
##                 JBO019.s_min JBO019.max JBO019.s_mean JBO019.s_median
##                    &lt;numeric&gt;  &lt;numeric&gt;     &lt;numeric&gt;       &lt;numeric&gt;
## ENSG00000243485          Inf          0           NaN              NA
## ENSG00000237613          Inf          0           NaN              NA
## ENSG00000186092          Inf          0           NaN              NA
## ENSG00000238009            1          1             1               1
## ENSG00000239945          Inf          0           NaN              NA
## ...                      ...        ...           ...             ...
## ENSG00000215635          Inf          0           NaN              NA
## ENSG00000268590          Inf          0           NaN              NA
## ENSG00000251180          Inf          0           NaN              NA
## ENSG00000215616          Inf          0           NaN              NA
## ENSG00000215611          Inf          0           NaN              NA
##                 JBO019.s_SD JBO019.p_mean JBO019.p_median JBO019.p_SD
##                   &lt;numeric&gt;     &lt;numeric&gt;       &lt;numeric&gt;   &lt;numeric&gt;
## ENSG00000243485          NA    0.00000000               0   0.0000000
## ENSG00000237613          NA    0.00000000               0   0.0000000
## ENSG00000186092          NA    0.00000000               0   0.0000000
## ENSG00000238009           0    0.00590717               0   0.0766631
## ENSG00000239945          NA    0.00000000               0   0.0000000
## ...                     ...           ...             ...         ...
## ENSG00000215635          NA             0               0           0
## ENSG00000268590          NA             0               0           0
## ENSG00000251180          NA             0               0           0
## ENSG00000215616          NA             0               0           0
## ENSG00000215611          NA             0               0           0
##                 JBO019.s_CV JBO019.p_CV
##                   &lt;numeric&gt;   &lt;numeric&gt;
## ENSG00000243485          NA         NaN
## ENSG00000237613          NA         NaN
## ENSG00000186092          NA         NaN
## ENSG00000238009           0      1297.8
## ENSG00000239945          NA         NaN
## ...                     ...         ...
## ENSG00000215635          NA         NaN
## ENSG00000268590          NA         NaN
## ENSG00000251180          NA         NaN
## ENSG00000215616          NA         NaN
## ENSG00000215611          NA         NaN</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="practical-session-3.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colGeometries</span>(sfe)</span></code></pre></div>
<pre><code>## List of length 3
## names(3): spotPoly spotCntd spotHex</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="practical-session-3.html#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colGraphs</span>(sfe)</span></code></pre></div>
<pre><code>## $col
## Characteristics of weights list object:
## Neighbour list object:
## Number of regions: 1185 
## Number of nonzero links: 7110 
## Percentage nonzero weights: 0.5063291 
## Average number of links: 6 
## Non-symmetric neighbours list
## 
## Weights style: W 
## Weights constants summary:
##      n      nn   S0       S1   S2
## W 1185 1404225 1185 385.3889 4770</code></pre>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="practical-session-3.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;possible break point to continue on Pract 4&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; #</span></span>
<span id="cb126-2"><a href="practical-session-3.html#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="practical-session-3.html#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Above we load the data and calculate some statistics, generate some </span></span>
<span id="cb126-4"><a href="practical-session-3.html#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co"># neighbour graphs and we can explore the data structures. Below we </span></span>
<span id="cb126-5"><a href="practical-session-3.html#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the QC.</span></span>
<span id="cb126-6"><a href="practical-session-3.html#cb126-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-7"><a href="practical-session-3.html#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="co"># There is a catch in the above. The get.spatialNeighGraphs is going to be used</span></span>
<span id="cb126-8"><a href="practical-session-3.html#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="co"># here to showcase the neighbour graphs but actually it is better to be called </span></span>
<span id="cb126-9"><a href="practical-session-3.html#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="co"># after we remove unwanted locations through QC application</span></span>
<span id="cb126-10"><a href="practical-session-3.html#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="practical-session-3.html#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensembl version 92 does not match the dataset. Need to find out which</span></span>
<span id="cb126-12"><a href="practical-session-3.html#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ensembl version they used with SpaceRanger. Otherwise some genes will not have</span></span>
<span id="cb126-13"><a href="practical-session-3.html#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="co"># proper annotation.</span></span>
<span id="cb126-14"><a href="practical-session-3.html#cb126-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-15"><a href="practical-session-3.html#cb126-15" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;possible break point to continue on Pract 4&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; #</span></span>
<span id="cb126-16"><a href="practical-session-3.html#cb126-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-17"><a href="practical-session-3.html#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Select library size threshold</span></span>
<span id="cb126-18"><a href="practical-session-3.html#cb126-18" aria-hidden="true" tabindex="-1"></a>qc_lib_size <span class="ot">&lt;-</span> <span class="fu">colData</span>(sfe)<span class="sc">$</span>sum <span class="sc">&lt;</span> <span class="dv">700</span></span>
<span id="cb126-19"><a href="practical-session-3.html#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb126-20"><a href="practical-session-3.html#cb126-20" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_lib_size)</span></code></pre></div>
<pre><code>## qc_lib_size
## FALSE  TRUE 
##  1171    14</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="practical-session-3.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb128-2"><a href="practical-session-3.html#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sfe)<span class="sc">$</span>qc_lib_size <span class="ot">&lt;-</span> qc_lib_size</span>
<span id="cb128-3"><a href="practical-session-3.html#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="practical-session-3.html#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Select expressed genes threshold</span></span>
<span id="cb128-5"><a href="practical-session-3.html#cb128-5" aria-hidden="true" tabindex="-1"></a>qc_detected <span class="ot">&lt;-</span> <span class="fu">colData</span>(sfe)<span class="sc">$</span>detected <span class="sc">&lt;</span> <span class="dv">500</span></span>
<span id="cb128-6"><a href="practical-session-3.html#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb128-7"><a href="practical-session-3.html#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_detected)</span></code></pre></div>
<pre><code>## qc_detected
## FALSE  TRUE 
##  1168    17</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="practical-session-3.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb130-2"><a href="practical-session-3.html#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sfe)<span class="sc">$</span>qc_detected <span class="ot">&lt;-</span> qc_detected</span>
<span id="cb130-3"><a href="practical-session-3.html#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="practical-session-3.html#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Select expressed genes threshold</span></span>
<span id="cb130-5"><a href="practical-session-3.html#cb130-5" aria-hidden="true" tabindex="-1"></a>qc_mito <span class="ot">&lt;-</span> <span class="fu">colData</span>(sfe)<span class="sc">$</span>subsets_mito_percent <span class="sc">&gt;</span> <span class="dv">25</span></span>
<span id="cb130-6"><a href="practical-session-3.html#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Check how many spots are filtered out</span></span>
<span id="cb130-7"><a href="practical-session-3.html#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(qc_mito)</span></code></pre></div>
<pre><code>## qc_mito
## FALSE  TRUE 
##  1184     1</code></pre>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="practical-session-3.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add threshold in colData</span></span>
<span id="cb132-2"><a href="practical-session-3.html#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sfe)<span class="sc">$</span>qc_mito <span class="ot">&lt;-</span> qc_mito</span>
<span id="cb132-3"><a href="practical-session-3.html#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="practical-session-3.html#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check the number of discarded spots for each metric</span></span>
<span id="cb132-5"><a href="practical-session-3.html#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">cbind</span>(qc_lib_size, qc_detected, qc_mito), <span class="dv">2</span>, sum)</span></code></pre></div>
<pre><code>## qc_lib_size qc_detected     qc_mito 
##          14          17           1</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="practical-session-3.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine together the set of discarded spots</span></span>
<span id="cb134-2"><a href="practical-session-3.html#cb134-2" aria-hidden="true" tabindex="-1"></a>discard <span class="ot">&lt;-</span> qc_lib_size <span class="sc">|</span> qc_detected <span class="sc">|</span> qc_mito</span>
<span id="cb134-3"><a href="practical-session-3.html#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Store the set in the object</span></span>
<span id="cb134-4"><a href="practical-session-3.html#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sfe)<span class="sc">$</span>discard <span class="ot">&lt;-</span> discard</span>
<span id="cb134-5"><a href="practical-session-3.html#cb134-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-6"><a href="practical-session-3.html#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Check the spatial pattern of combined set of discarded spots</span></span>
<span id="cb134-7"><a href="practical-session-3.html#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQC</span>(sfe, <span class="at">type =</span> <span class="st">&quot;spots&quot;</span>, </span>
<span id="cb134-8"><a href="practical-session-3.html#cb134-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">discard =</span> <span class="st">&quot;discard&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/03_QC_sfe-2.png" width="672" /></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="practical-session-3.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="do">## remove combined set of low-quality spots</span></span>
<span id="cb135-2"><a href="practical-session-3.html#cb135-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> sfe[, <span class="sc">!</span><span class="fu">colData</span>(sfe)<span class="sc">$</span>discard]</span>
<span id="cb135-3"><a href="practical-session-3.html#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="practical-session-3.html#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate library size factors</span></span>
<span id="cb135-5"><a href="practical-session-3.html#cb135-5" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">computeLibraryFactors</span>(sfe)</span>
<span id="cb135-6"><a href="practical-session-3.html#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look at the size factors</span></span>
<span id="cb135-7"><a href="practical-session-3.html#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sizeFactors</span>(sfe))</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.06573 0.36598 0.95403 1.00000 1.55396 2.78681</code></pre>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="practical-session-3.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate logcounts using library size factors</span></span>
<span id="cb137-2"><a href="practical-session-3.html#cb137-2" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(sfe)</span>
<span id="cb137-3"><a href="practical-session-3.html#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="practical-session-3.html#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="co"># FEATURE SELECTION</span></span>
<span id="cb137-5"><a href="practical-session-3.html#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="practical-session-3.html#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remove mitochondrial genes</span></span>
<span id="cb137-7"><a href="practical-session-3.html#cb137-7" aria-hidden="true" tabindex="-1"></a>sfe <span class="ot">&lt;-</span> sfe[<span class="sc">!</span>is_mito, ]</span>
<span id="cb137-8"><a href="practical-session-3.html#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="co"># fit mean-variance relationship</span></span>
<span id="cb137-9"><a href="practical-session-3.html#cb137-9" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(sfe)</span>
<span id="cb137-10"><a href="practical-session-3.html#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="co"># select top HVGs</span></span>
<span id="cb137-11"><a href="practical-session-3.html#cb137-11" aria-hidden="true" tabindex="-1"></a>top_hvgs <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">prop =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<div id="section" class="section level80" number="3.2.1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.1">
<p class="heading"><span class="header-section-number">3.2.1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.1</span> </p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="practical-session-3.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load counts table</span></span>
<span id="cb138-2"><a href="practical-session-3.html#cb138-2" aria-hidden="true" tabindex="-1"></a>inputD <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;./data/hsLivSteat_JBO019_inputD.rds&quot;</span>)</span>
<span id="cb138-3"><a href="practical-session-3.html#cb138-3" aria-hidden="true" tabindex="-1"></a>inputD[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>##                 AAACAAGTATCTCCCA.1 AAACATTTCCCGGATT.1 AAACCCGAACGAAATC.1
## ENSG00000243485                  0                  0                  0
## ENSG00000237613                  0                  0                  0
## ENSG00000186092                  0                  0                  0
## ENSG00000238009                  0                  0                  0
## ENSG00000239945                  0                  0                  0</code></pre>
<p>Then we load the spot metadata. The imported table has the below columns:</p>
<ul>
<li><strong>Barcode:</strong> the spot barcode (<em>note that we substituted the “-” with a “.” to match the column names in the inputD because it is not good practise to have “-” in column names in R</em>).<br />
</li>
<li><strong>Section:</strong> whether the spot is on- or off- tissue (on-tissue = 1, off-tissue = 0).<br />
</li>
<li><strong>Spot_Y/ Spot_X:</strong> X and Y spot location on the capture area array.<br />
</li>
<li><strong>Image_Y/ Image_X:</strong> X and Y spot coordinates in the full resolution image.<br />
</li>
<li><strong>pixel_x/ pixel_y:</strong> X and Y spot coordinates in the low resolution image.</li>
</ul>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="practical-session-3.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load spot metadata</span></span>
<span id="cb140-2"><a href="practical-session-3.html#cb140-2" aria-hidden="true" tabindex="-1"></a>inputMD <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;./data/hsLivSteat_JBO019_inputMD.rds&quot;</span>)</span>
<span id="cb140-3"><a href="practical-session-3.html#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(inputMD)</span></code></pre></div>
<pre><code>##              Barcode Section Spot_Y Spot_X Image_Y Image_X  pixel_x  pixel_y
## 1 ACGCCTGACACGCGCT.1       0      0      0   16961    2500 68.85156 467.1165
## 2 TACCGATCCAACACTT.1       0      1      1   16847    2696 74.24952 463.9769
## 3 ATTAAAGCGGACGAGC.1       0      0      2   16735    2499 68.82401 460.8923
## 4 GATAAGGGACGATTAG.1       0      1      3   16621    2695 74.22198 457.7527
## 5 GTGCAAATCACCAATA.1       0      0      4   16509    2497 68.76893 454.6681
## 6 TGTTGGCTGGCGGAAG.1       0      1      5   16395    2693 74.16690 451.5285</code></pre>
</div>
</div>
<div id="create-point-geometries" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Create point geometries<a href="practical-session-3.html#create-point-geometries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First we want to extract the pixel coordinates from the <code>inputMD</code> data frame and then we will generate the point geometries (centroids) from all spots of the 10X Visium capture area. This helps to tessellate space better in the next step.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="practical-session-3.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract coordinates</span></span>
<span id="cb142-2"><a href="practical-session-3.html#cb142-2" aria-hidden="true" tabindex="-1"></a>spot_position <span class="ot">&lt;-</span> inputMD <span class="sc">%&gt;%</span> </span>
<span id="cb142-3"><a href="practical-session-3.html#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;Barcode&quot;</span>, <span class="st">&quot;pixel_x&quot;</span>, <span class="st">&quot;pixel_y&quot;</span>, <span class="st">&quot;Section&quot;</span>))</span>
<span id="cb142-4"><a href="practical-session-3.html#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="practical-session-3.html#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spot_position, <span class="dv">5</span>)</span>
<span id="cb142-6"><a href="practical-session-3.html#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="do">##              Barcode  pixel_x  pixel_y Section</span></span>
<span id="cb142-7"><a href="practical-session-3.html#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 ACGCCTGACACGCGCT.1 68.85156 467.1165       0</span></span>
<span id="cb142-8"><a href="practical-session-3.html#cb142-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TACCGATCCAACACTT.1 74.24952 463.9769       0</span></span>
<span id="cb142-9"><a href="practical-session-3.html#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 ATTAAAGCGGACGAGC.1 68.82401 460.8923       0</span></span>
<span id="cb142-10"><a href="practical-session-3.html#cb142-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 GATAAGGGACGATTAG.1 74.22198 457.7527       0</span></span>
<span id="cb142-11"><a href="practical-session-3.html#cb142-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 GTGCAAATCACCAATA.1 68.76893 454.6681       0</span></span>
<span id="cb142-12"><a href="practical-session-3.html#cb142-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-13"><a href="practical-session-3.html#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Convert spots to centroids</span></span>
<span id="cb142-14"><a href="practical-session-3.html#cb142-14" aria-hidden="true" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> spot_position <span class="sc">%&gt;%</span> </span>
<span id="cb142-15"><a href="practical-session-3.html#cb142-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;pixel_x&quot;</span>, <span class="st">&quot;pixel_y&quot;</span>), </span>
<span id="cb142-16"><a href="practical-session-3.html#cb142-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-17"><a href="practical-session-3.html#cb142-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(centroids, <span class="dv">5</span>)</span>
<span id="cb142-18"><a href="practical-session-3.html#cb142-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 5 features and 4 fields</span></span>
<span id="cb142-19"><a href="practical-session-3.html#cb142-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb142-20"><a href="practical-session-3.html#cb142-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb142-21"><a href="practical-session-3.html#cb142-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 68.76893 ymin: 454.6681 xmax: 74.24952 ymax: 467.1165</span></span>
<span id="cb142-22"><a href="practical-session-3.html#cb142-22" aria-hidden="true" tabindex="-1"></a><span class="do">## CRS:           NA</span></span>
<span id="cb142-23"><a href="practical-session-3.html#cb142-23" aria-hidden="true" tabindex="-1"></a><span class="do">##              Barcode  pixel_x  pixel_y Section                  geometry</span></span>
<span id="cb142-24"><a href="practical-session-3.html#cb142-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 ACGCCTGACACGCGCT.1 68.85156 467.1165       0 POINT (68.85156 467.1165)</span></span>
<span id="cb142-25"><a href="practical-session-3.html#cb142-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 TACCGATCCAACACTT.1 74.24952 463.9769       0 POINT (74.24952 463.9769)</span></span>
<span id="cb142-26"><a href="practical-session-3.html#cb142-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 ATTAAAGCGGACGAGC.1 68.82401 460.8923       0 POINT (68.82401 460.8923)</span></span>
<span id="cb142-27"><a href="practical-session-3.html#cb142-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 GATAAGGGACGATTAG.1 74.22198 457.7527       0 POINT (74.22198 457.7527)</span></span>
<span id="cb142-28"><a href="practical-session-3.html#cb142-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 GTGCAAATCACCAATA.1 68.76893 454.6681       0 POINT (68.76893 454.6681)</span></span></code></pre></div>
</div>
<div id="tesselate-space" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Tesselate space<a href="practical-session-3.html#tesselate-space" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will take the steps towards tessellating space. This tessellation, brakes the area that surrounds the spots and as a result we can use it to find neighbours by adjacency later on. We need to always keep in mind that although tessellation makes the spots have common borders, the 10X Visium spots have a distance between them that is approximately 50μm.</p>
<ul>
<li>First, we combine the points we calculated earlier into a multipoint geometry.</li>
<li>Second, we tessellate space around the points using the Voronoi tessellation.</li>
<li>Third, we can cut the tessellation around the edges because tessellation extends to infinity.</li>
</ul>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="practical-session-3.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine the points into a multipoint geometry:</span></span>
<span id="cb143-2"><a href="practical-session-3.html#cb143-2" aria-hidden="true" tabindex="-1"></a>cntd_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(centroids)</span>
<span id="cb143-3"><a href="practical-session-3.html#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cntd_union)</span></code></pre></div>
<pre><code>## Geometry set for 1 feature 
## Geometry type: MULTIPOINT
## Dimension:     XY
## Bounding box:  xmin: 66.45552 ymin: 69.04434 xmax: 486.1195 ymax: 467.1165
## CRS:           NA</code></pre>
<pre><code>## MULTIPOINT ((66.45552 74.69017), (66.5106 80.91...</code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="practical-session-3.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Use the union of points to generate a voronoi object</span></span>
<span id="cb146-2"><a href="practical-session-3.html#cb146-2" aria-hidden="true" tabindex="-1"></a>voronoi <span class="ot">&lt;-</span> <span class="fu">st_voronoi</span>(cntd_union, <span class="at">bOnlyEdges =</span> <span class="cn">TRUE</span>)</span>
<span id="cb146-3"><a href="practical-session-3.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(voronoi)</span></code></pre></div>
<pre><code>## Geometry set for 1 feature 
## Geometry type: MULTILINESTRING
## Dimension:     XY
## Bounding box:  xmin: -353.2085 ymin: -350.6197 xmax: 905.7835 ymax: 886.7805
## CRS:           NA</code></pre>
<pre><code>## MULTILINESTRING ((68.32756 84.03226, 70.14669 8...</code></pre>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="practical-session-3.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Create an enveloped voronoi tessellation around the tissue</span></span>
<span id="cb149-2"><a href="practical-session-3.html#cb149-2" aria-hidden="true" tabindex="-1"></a>voronoi_env <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">st_cast</span>(voronoi), <span class="fu">st_convex_hull</span>(cntd_union))</span>
<span id="cb149-3"><a href="practical-session-3.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(voronoi_env)</span></code></pre></div>
<pre><code>## Geometry set for 1 feature 
## Geometry type: MULTILINESTRING
## Dimension:     XY
## Bounding box:  xmin: 66.47385 ymin: 69.06262 xmax: 486.1006 ymax: 467.0982
## CRS:           NA</code></pre>
<pre><code>## MULTILINESTRING ((68.32756 84.03226, 70.14669 8...</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="practical-session-3.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot tessellation as is</span></span>
<span id="cb152-2"><a href="practical-session-3.html#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> voronoi) <span class="sc">+</span> <span class="fu">geom_sf</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Tessellation&quot;</span>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span>
<span id="cb152-3"><a href="practical-session-3.html#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot enveloped tessellation</span></span>
<span id="cb152-4"><a href="practical-session-3.html#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> voronoi_env) <span class="sc">+</span> </span>
<span id="cb152-5"><a href="practical-session-3.html#cb152-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span> </span>
<span id="cb152-6"><a href="practical-session-3.html#cb152-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Tessellation cut to capture area&quot;</span>) <span class="sc">+</span> </span>
<span id="cb152-7"><a href="practical-session-3.html#cb152-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_voronoi-1.png" width="50%" /><img src="_main_files/figure-html/plot_voronoi-2.png" width="50%" /></p>
</div>
<div id="polygonise-the-tessellation" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Polygonise the tessellation<a href="practical-session-3.html#polygonise-the-tessellation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we will extract polygons from the tessellation object only for the spots that are on-tissue. Meaning, they have a value of <strong>1</strong> in the <code>Section</code> column.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="practical-session-3.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate the POLYGONS from the MULTILINESTRING</span></span>
<span id="cb153-2"><a href="practical-session-3.html#cb153-2" aria-hidden="true" tabindex="-1"></a>polygons <span class="ot">&lt;-</span> <span class="fu">st_polygonize</span>(voronoi_env) <span class="sc">%&gt;%</span> <span class="co"># polygonise the tessellation</span></span>
<span id="cb153-3"><a href="practical-session-3.html#cb153-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_cast</span>() <span class="sc">%&gt;%</span> <span class="co"># convert GEOMETRYCOLLECTION to multiple POLYGONS</span></span>
<span id="cb153-4"><a href="practical-session-3.html#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span>  <span class="co"># convert sfc object to sf for st_join afterwards</span></span>
<span id="cb153-5"><a href="practical-session-3.html#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_join</span>(., </span>
<span id="cb153-6"><a href="practical-session-3.html#cb153-6" aria-hidden="true" tabindex="-1"></a>            centroids[centroids<span class="sc">$</span>Section <span class="sc">==</span> <span class="dv">1</span>,],</span>
<span id="cb153-7"><a href="practical-session-3.html#cb153-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">join =</span> st_contains,</span>
<span id="cb153-8"><a href="practical-session-3.html#cb153-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">left =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-9"><a href="practical-session-3.html#cb153-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">geom_pol =</span> geometry) <span class="sc">%&gt;%</span> <span class="co"># Join the centroids with the POLYGONS </span></span>
<span id="cb153-10"><a href="practical-session-3.html#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Barcode_rn =</span> Barcode) <span class="sc">%&gt;%</span> <span class="co"># duplicate the barcode column</span></span>
<span id="cb153-11"><a href="practical-session-3.html#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_to_rownames</span>(<span class="st">&quot;Barcode_rn&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># move duplicate column to row names</span></span>
<span id="cb153-12"><a href="practical-session-3.html#cb153-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>() <span class="co"># convert back to sf (mutate makes it a df)</span></span>
<span id="cb153-13"><a href="practical-session-3.html#cb153-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-14"><a href="practical-session-3.html#cb153-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(polygons)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 4 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 106.5067 ymin: 121.1432 xmax: 201.425 ymax: 304.4226
## CRS:           NA
##                               Barcode  pixel_x  pixel_y Section
## AAACTAACGTGGCGAC.1 AAACTAACGTGGCGAC.1 110.1074 124.2633       1
## GACTAAGATCATGCAC.1 GACTAAGATCATGCAC.1 192.4814 301.2944       1
## ATCGACTCTTTCCGTT.1 ATCGACTCTTTCCGTT.1 192.3437 276.3701       1
## TGGTTCGTAGCAAAGG.1 TGGTTCGTAGCAAAGG.1 192.4539 295.0702       1
## GCTCTAAACCCTGACG.1 GCTCTAAACCCTGACG.1 197.8243 285.6789       1
## TCAAACAACCGCGTCG.1 TCAAACAACCGCGTCG.1 197.7692 279.4547       1
##                                          geom_pol
## AAACTAACGTGGCGAC.1 POLYGON ((108.2826 121.1592...
## GACTAAGATCATGCAC.1 POLYGON ((188.8807 301.3139...
## ATCGACTCTTTCCGTT.1 POLYGON ((190.496 273.2742,...
## TGGTTCGTAGCAAAGG.1 POLYGON ((190.6062 291.9742...
## GCTCTAAACCCTGACG.1 POLYGON ((195.9765 282.5829...
## TCAAACAACCGCGTCG.1 POLYGON ((194.1607 279.4881...</code></pre>
<p>As you may have observed we joined the <code>polygons</code> object with the <code>centroids</code> object so that we can add the rest of the information like <code>Barcode</code>, <code>pixel_x</code>, and <code>pixel_y</code>.</p>
<p>If we plot it:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="practical-session-3.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot on tissue polygons</span></span>
<span id="cb155-2"><a href="practical-session-3.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> polygons) <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol)) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_map1-1.png" width="384" /></p>
<p>Because there are times that we will need the polygons and times that we will need their centroids we can add both geometries in the <code>polygons</code> object.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="practical-session-3.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Update the polygon object to keep the centroid geometries as well</span></span>
<span id="cb156-2"><a href="practical-session-3.html#cb156-2" aria-hidden="true" tabindex="-1"></a>polygons <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="co"># rename polygons geom column</span></span>
<span id="cb156-3"><a href="practical-session-3.html#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">as.data.frame</span>(centroids)) <span class="sc">%&gt;%</span> <span class="co"># left joint pols and cntds</span></span>
<span id="cb156-4"><a href="practical-session-3.html#cb156-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">geom_cntd =</span> geometry) <span class="sc">%&gt;%</span> <span class="co"># rename centroids geom column</span></span>
<span id="cb156-5"><a href="practical-session-3.html#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">sf_column_name =</span> <span class="st">&quot;geom_pol&quot;</span>) <span class="co"># set polygons geom column to be the default (one must be)</span></span>
<span id="cb156-6"><a href="practical-session-3.html#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="practical-session-3.html#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(polygons)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 4 fields
## Active geometry column: geom_pol
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 106.5067 ymin: 121.1432 xmax: 201.425 ymax: 304.4226
## CRS:           NA
##              Barcode  pixel_x  pixel_y Section                       geom_pol
## 1 AAACTAACGTGGCGAC.1 110.1074 124.2633       1 POLYGON ((108.2826 121.1592...
## 2 GACTAAGATCATGCAC.1 192.4814 301.2944       1 POLYGON ((188.8807 301.3139...
## 3 ATCGACTCTTTCCGTT.1 192.3437 276.3701       1 POLYGON ((190.496 273.2742,...
## 4 TGGTTCGTAGCAAAGG.1 192.4539 295.0702       1 POLYGON ((190.6062 291.9742...
## 5 GCTCTAAACCCTGACG.1 197.8243 285.6789       1 POLYGON ((195.9765 282.5829...
## 6 TCAAACAACCGCGTCG.1 197.7692 279.4547       1 POLYGON ((194.1607 279.4881...
##                   geom_cntd
## 1 POINT (110.1074 124.2633)
## 2 POINT (192.4814 301.2944)
## 3 POINT (192.3437 276.3701)
## 4 POINT (192.4539 295.0702)
## 5 POINT (197.8243 285.6789)
## 6 POINT (197.7692 279.4547)</code></pre>
<p>As we can see here we have two geometry columns; one named <code>geom_pol</code> and one named <code>geom_cntd</code>. As a result we need to have one of these two as the active geometry column for the <code>polygons</code> object of class <code>sf</code>. We can see at the top of the printed output that the active geometry column is <code>geom_pol</code>. In general we can switch between geometry columns using: <code>st_geometry(sf_object) &lt;- "geom_column_to_change_to"</code></p>
</div>
<div id="identify-neighbours" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Identify neighbours<a href="practical-session-3.html#identify-neighbours" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="by-contiguity" class="section level4 hasAnchor" number="3.2.5.1">
<h4><span class="header-section-number">3.2.5.1</span> By contiguity<a href="practical-session-3.html#by-contiguity" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can contiguity-based neighbours for each spot using the <code>poly2nb</code> function from <code>spdep</code>. The function is using heuristics to identify polygons sharing boundary points as neighbours. It also has a <code>snap =</code> argument, to allow the shared boundary points to be a short distance from one another. Here we select <code>snap = 0</code> because the tessellation generated polygons with shared borders. Finally, the <code>queen =</code> argument is set to <code>TRUE</code>. This means that the function will look for a chess queen-style of contiguities.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="practical-session-3.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get contiguity neighbours</span></span>
<span id="cb158-2"><a href="practical-session-3.html#cb158-2" aria-hidden="true" tabindex="-1"></a>nb_adjc <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(<span class="at">pl =</span> polygons,</span>
<span id="cb158-3"><a href="practical-session-3.html#cb158-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">snap =</span> <span class="dv">0</span>,</span>
<span id="cb158-4"><a href="practical-session-3.html#cb158-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">queen =</span> <span class="cn">TRUE</span>)</span>
<span id="cb158-5"><a href="practical-session-3.html#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_adjc)</span>
<span id="cb158-6"><a href="practical-session-3.html#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb158-7"><a href="practical-session-3.html#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_adjc)</span>
<span id="cb158-8"><a href="practical-session-3.html#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb158-9"><a href="practical-session-3.html#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0</span></span>
<span id="cb158-10"><a href="practical-session-3.html#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb158-11"><a href="practical-session-3.html#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb158-12"><a href="practical-session-3.html#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  4  7 11</span></span>
<span id="cb158-13"><a href="practical-session-3.html#cb158-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb158-14"><a href="practical-session-3.html#cb158-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb158-15"><a href="practical-session-3.html#cb158-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6 10</span></span>
<span id="cb158-16"><a href="practical-session-3.html#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb158-17"><a href="practical-session-3.html#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb158-18"><a href="practical-session-3.html#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2 7 8</span></span>
<span id="cb158-19"><a href="practical-session-3.html#cb158-19" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb158-20"><a href="practical-session-3.html#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb158-21"><a href="practical-session-3.html#cb158-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6  8 12 15</span></span>
<span id="cb158-22"><a href="practical-session-3.html#cb158-22" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb158-23"><a href="practical-session-3.html#cb158-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb158-24"><a href="practical-session-3.html#cb158-24" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  5 10 12 13</span></span></code></pre></div>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="practical-session-3.html#cb159-1" aria-hidden="true" tabindex="-1"></a>nb_adjc_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_adjc)</span>
<span id="cb159-2"><a href="practical-session-3.html#cb159-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-3"><a href="practical-session-3.html#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb159-4"><a href="practical-session-3.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_adjc_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb159-5"><a href="practical-session-3.html#cb159-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb159-6"><a href="practical-session-3.html#cb159-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-7"><a href="practical-session-3.html#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_adjc_n),</span>
<span id="cb159-8"><a href="practical-session-3.html#cb159-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb159-9"><a href="practical-session-3.html#cb159-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb159-10"><a href="practical-session-3.html#cb159-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb159-11"><a href="practical-session-3.html#cb159-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-12"><a href="practical-session-3.html#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">6</span>)) <span class="sc">+</span> </span>
<span id="cb159-13"><a href="practical-session-3.html#cb159-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb159-14"><a href="practical-session-3.html#cb159-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-15"><a href="practical-session-3.html#cb159-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb159-16"><a href="practical-session-3.html#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="practical-session-3.html#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb159-18"><a href="practical-session-3.html#cb159-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb159-19"><a href="practical-session-3.html#cb159-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb159-20"><a href="practical-session-3.html#cb159-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-21"><a href="practical-session-3.html#cb159-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_adjc, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb159-22"><a href="practical-session-3.html#cb159-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb159-23"><a href="practical-session-3.html#cb159-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb159-24"><a href="practical-session-3.html#cb159-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb159-25"><a href="practical-session-3.html#cb159-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb159-26"><a href="practical-session-3.html#cb159-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_adjacent_neighbours_b-1.png" width="50%" /><img src="_main_files/figure-html/get_adjacent_neighbours_b-2.png" width="50%" /></p>
<p>As you can see, the neighbours object is a <code>list</code> of length equal to the number of spots we have in the dataset. Each element of the list represents a spot and the numbers stored inside the indexes of the neighbouring spots and the spots have a different numbers of neighbours. The connectivity histogram visualises the distribution of the number of neighbours in the data.</p>
</div>
<div id="by-graph" class="section level4 hasAnchor" number="3.2.5.2">
<h4><span class="header-section-number">3.2.5.2</span> By graph<a href="practical-session-3.html#by-graph" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Once representative points are available, the criteria for neighbourhood can be extended from just contiguity to include graph measures, distance thresholds, and 𝑘-nearest neighbours.</p>
<p>The most direct graph representation of neighbours is to make a Delaunay triangulation of the points, which extends outwards to the convex hull of the points. Note that graph-based representations construct the interpoint relationships based on Euclidean distance. Because it joins distant points around the convex hull, it may be worthwhile to thin the triangulation as a Sphere of Influence (SOI) graph, removing links that are relatively long. Points are SOI neighbours if circles centred on the points, of radius equal to the points’ nearest neighbour distances, intersect in two places <span class="citation">(<a href="#ref-Avis1985" role="doc-biblioref">Avis and Horton 1985</a>)</span>.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="practical-session-3.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set centroids as default geometry</span></span>
<span id="cb160-2"><a href="practical-session-3.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(polygons) <span class="ot">&lt;-</span> <span class="st">&quot;geom_cntd&quot;</span></span>
<span id="cb160-3"><a href="practical-session-3.html#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Get the neighbour names</span></span>
<span id="cb160-4"><a href="practical-session-3.html#cb160-4" aria-hidden="true" tabindex="-1"></a>nb_names <span class="ot">&lt;-</span> polygons<span class="sc">$</span>Barcode</span>
<span id="cb160-5"><a href="practical-session-3.html#cb160-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-6"><a href="practical-session-3.html#cb160-6" aria-hidden="true" tabindex="-1"></a><span class="do">## By Delaunay triangulation</span></span>
<span id="cb160-7"><a href="practical-session-3.html#cb160-7" aria-hidden="true" tabindex="-1"></a>nb_tri <span class="ot">&lt;-</span> <span class="fu">tri2nb</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">row.names =</span> nb_names)</span>
<span id="cb160-8"><a href="practical-session-3.html#cb160-8" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_tri)</span>
<span id="cb160-9"><a href="practical-session-3.html#cb160-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb160-10"><a href="practical-session-3.html#cb160-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_tri)</span>
<span id="cb160-11"><a href="practical-session-3.html#cb160-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb160-12"><a href="practical-session-3.html#cb160-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]   2   3   4  52  53  61  71  78  79  80  81  82  83  84  85  86  88  91 103</span></span>
<span id="cb160-13"><a href="practical-session-3.html#cb160-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [20] 155</span></span>
<span id="cb160-14"><a href="practical-session-3.html#cb160-14" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb160-15"><a href="practical-session-3.html#cb160-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb160-16"><a href="practical-session-3.html#cb160-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  1  4  7  9 11</span></span>
<span id="cb160-17"><a href="practical-session-3.html#cb160-17" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb160-18"><a href="practical-session-3.html#cb160-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb160-19"><a href="practical-session-3.html#cb160-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  1  4  5  6 10 35 61</span></span>
<span id="cb160-20"><a href="practical-session-3.html#cb160-20" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb160-21"><a href="practical-session-3.html#cb160-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb160-22"><a href="practical-session-3.html#cb160-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1 2 3 5 7 8</span></span>
<span id="cb160-23"><a href="practical-session-3.html#cb160-23" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb160-24"><a href="practical-session-3.html#cb160-24" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb160-25"><a href="practical-session-3.html#cb160-25" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  4  6  8 12 15</span></span>
<span id="cb160-26"><a href="practical-session-3.html#cb160-26" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb160-27"><a href="practical-session-3.html#cb160-27" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb160-28"><a href="practical-session-3.html#cb160-28" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  5 10 12 13</span></span></code></pre></div>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="practical-session-3.html#cb161-1" aria-hidden="true" tabindex="-1"></a>nb_tri_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_tri)</span>
<span id="cb161-2"><a href="practical-session-3.html#cb161-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-3"><a href="practical-session-3.html#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb161-4"><a href="practical-session-3.html#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_tri_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb161-5"><a href="practical-session-3.html#cb161-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb161-6"><a href="practical-session-3.html#cb161-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb161-7"><a href="practical-session-3.html#cb161-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_tri_n),</span>
<span id="cb161-8"><a href="practical-session-3.html#cb161-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb161-9"><a href="practical-session-3.html#cb161-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb161-10"><a href="practical-session-3.html#cb161-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb161-11"><a href="practical-session-3.html#cb161-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb161-12"><a href="practical-session-3.html#cb161-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb161-13"><a href="practical-session-3.html#cb161-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb161-14"><a href="practical-session-3.html#cb161-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb161-15"><a href="practical-session-3.html#cb161-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb161-16"><a href="practical-session-3.html#cb161-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-17"><a href="practical-session-3.html#cb161-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb161-18"><a href="practical-session-3.html#cb161-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb161-19"><a href="practical-session-3.html#cb161-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb161-20"><a href="practical-session-3.html#cb161-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb161-21"><a href="practical-session-3.html#cb161-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_tri, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb161-22"><a href="practical-session-3.html#cb161-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb161-23"><a href="practical-session-3.html#cb161-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb161-24"><a href="practical-session-3.html#cb161-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb161-25"><a href="practical-session-3.html#cb161-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb161-26"><a href="practical-session-3.html#cb161-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_graph_neighbours1b-1.png" width="50%" /><img src="_main_files/figure-html/get_graph_neighbours1b-2.png" width="50%" /></p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="practical-session-3.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get neighbours by SOI</span></span>
<span id="cb162-2"><a href="practical-session-3.html#cb162-2" aria-hidden="true" tabindex="-1"></a>nb_soi <span class="ot">&lt;-</span> <span class="fu">graph2nb</span>(<span class="fu">soi.graph</span>(nb_tri, polygons<span class="sc">$</span>geom_cntd), </span>
<span id="cb162-3"><a href="practical-session-3.html#cb162-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">row.names =</span> nb_names)</span>
<span id="cb162-4"><a href="practical-session-3.html#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_soi)</span>
<span id="cb162-5"><a href="practical-session-3.html#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb162-6"><a href="practical-session-3.html#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_soi)</span>
<span id="cb162-7"><a href="practical-session-3.html#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb162-8"><a href="practical-session-3.html#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 52 53 78 79</span></span>
<span id="cb162-9"><a href="practical-session-3.html#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb162-10"><a href="practical-session-3.html#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb162-11"><a href="practical-session-3.html#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  4  7  9 11</span></span>
<span id="cb162-12"><a href="practical-session-3.html#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb162-13"><a href="practical-session-3.html#cb162-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb162-14"><a href="practical-session-3.html#cb162-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  5  6 10</span></span>
<span id="cb162-15"><a href="practical-session-3.html#cb162-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb162-16"><a href="practical-session-3.html#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb162-17"><a href="practical-session-3.html#cb162-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2 5 7 8</span></span>
<span id="cb162-18"><a href="practical-session-3.html#cb162-18" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb162-19"><a href="practical-session-3.html#cb162-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb162-20"><a href="practical-session-3.html#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  4  6  8 12 15</span></span>
<span id="cb162-21"><a href="practical-session-3.html#cb162-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb162-22"><a href="practical-session-3.html#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb162-23"><a href="practical-session-3.html#cb162-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  5 10 12 13</span></span>
<span id="cb162-24"><a href="practical-session-3.html#cb162-24" aria-hidden="true" tabindex="-1"></a>nb_soi_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_soi)</span></code></pre></div>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="practical-session-3.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb163-2"><a href="practical-session-3.html#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_soi_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb163-3"><a href="practical-session-3.html#cb163-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb163-4"><a href="practical-session-3.html#cb163-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-5"><a href="practical-session-3.html#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_soi_n),</span>
<span id="cb163-6"><a href="practical-session-3.html#cb163-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb163-7"><a href="practical-session-3.html#cb163-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb163-8"><a href="practical-session-3.html#cb163-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb163-9"><a href="practical-session-3.html#cb163-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-10"><a href="practical-session-3.html#cb163-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">8</span>)) <span class="sc">+</span> </span>
<span id="cb163-11"><a href="practical-session-3.html#cb163-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb163-12"><a href="practical-session-3.html#cb163-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-13"><a href="practical-session-3.html#cb163-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb163-14"><a href="practical-session-3.html#cb163-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-15"><a href="practical-session-3.html#cb163-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb163-16"><a href="practical-session-3.html#cb163-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb163-17"><a href="practical-session-3.html#cb163-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb163-18"><a href="practical-session-3.html#cb163-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-19"><a href="practical-session-3.html#cb163-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_soi, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb163-20"><a href="practical-session-3.html#cb163-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb163-21"><a href="practical-session-3.html#cb163-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb163-22"><a href="practical-session-3.html#cb163-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb163-23"><a href="practical-session-3.html#cb163-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb163-24"><a href="practical-session-3.html#cb163-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_graph_neighbours2b-1.png" width="50%" /><img src="_main_files/figure-html/get_graph_neighbours2b-2.png" width="50%" /></p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="practical-session-3.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get neighbours by Gabriel graph</span></span>
<span id="cb164-2"><a href="practical-session-3.html#cb164-2" aria-hidden="true" tabindex="-1"></a>nb_gbn <span class="ot">&lt;-</span> <span class="fu">graph2nb</span>(<span class="fu">gabrielneigh</span>(polygons<span class="sc">$</span>geom_cntd), </span>
<span id="cb164-3"><a href="practical-session-3.html#cb164-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">row.names =</span> nb_names)</span>
<span id="cb164-4"><a href="practical-session-3.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_gbn)</span>
<span id="cb164-5"><a href="practical-session-3.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb164-6"><a href="practical-session-3.html#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_gbn)</span>
<span id="cb164-7"><a href="practical-session-3.html#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb164-8"><a href="practical-session-3.html#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 53</span></span>
<span id="cb164-9"><a href="practical-session-3.html#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb164-10"><a href="practical-session-3.html#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb164-11"><a href="practical-session-3.html#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  4  7 11</span></span>
<span id="cb164-12"><a href="practical-session-3.html#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb164-13"><a href="practical-session-3.html#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb164-14"><a href="practical-session-3.html#cb164-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6 10</span></span>
<span id="cb164-15"><a href="practical-session-3.html#cb164-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb164-16"><a href="practical-session-3.html#cb164-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb164-17"><a href="practical-session-3.html#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 7 8</span></span>
<span id="cb164-18"><a href="practical-session-3.html#cb164-18" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb164-19"><a href="practical-session-3.html#cb164-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb164-20"><a href="practical-session-3.html#cb164-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6  8 12 15</span></span>
<span id="cb164-21"><a href="practical-session-3.html#cb164-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb164-22"><a href="practical-session-3.html#cb164-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb164-23"><a href="practical-session-3.html#cb164-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 10 12 13</span></span>
<span id="cb164-24"><a href="practical-session-3.html#cb164-24" aria-hidden="true" tabindex="-1"></a>nb_gbn_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_gbn)</span></code></pre></div>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="practical-session-3.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb165-2"><a href="practical-session-3.html#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_gbn_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb165-3"><a href="practical-session-3.html#cb165-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb165-4"><a href="practical-session-3.html#cb165-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb165-5"><a href="practical-session-3.html#cb165-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_gbn_n),</span>
<span id="cb165-6"><a href="practical-session-3.html#cb165-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb165-7"><a href="practical-session-3.html#cb165-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb165-8"><a href="practical-session-3.html#cb165-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb165-9"><a href="practical-session-3.html#cb165-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb165-10"><a href="practical-session-3.html#cb165-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">4</span>)) <span class="sc">+</span> </span>
<span id="cb165-11"><a href="practical-session-3.html#cb165-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb165-12"><a href="practical-session-3.html#cb165-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb165-13"><a href="practical-session-3.html#cb165-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb165-14"><a href="practical-session-3.html#cb165-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-15"><a href="practical-session-3.html#cb165-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb165-16"><a href="practical-session-3.html#cb165-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb165-17"><a href="practical-session-3.html#cb165-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb165-18"><a href="practical-session-3.html#cb165-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb165-19"><a href="practical-session-3.html#cb165-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_gbn, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb165-20"><a href="practical-session-3.html#cb165-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb165-21"><a href="practical-session-3.html#cb165-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb165-22"><a href="practical-session-3.html#cb165-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb165-23"><a href="practical-session-3.html#cb165-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb165-24"><a href="practical-session-3.html#cb165-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_graph_neighbours3b-1.png" width="50%" /><img src="_main_files/figure-html/get_graph_neighbours3b-2.png" width="50%" /></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="practical-session-3.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get Relative graph neighbours</span></span>
<span id="cb166-2"><a href="practical-session-3.html#cb166-2" aria-hidden="true" tabindex="-1"></a>nb_rn <span class="ot">&lt;-</span> <span class="fu">graph2nb</span>(<span class="fu">relativeneigh</span>(polygons<span class="sc">$</span>geom_cntd), </span>
<span id="cb166-3"><a href="practical-session-3.html#cb166-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">row.names =</span> nb_names)</span>
<span id="cb166-4"><a href="practical-session-3.html#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_rn)</span>
<span id="cb166-5"><a href="practical-session-3.html#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb166-6"><a href="practical-session-3.html#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_rn)</span>
<span id="cb166-7"><a href="practical-session-3.html#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb166-8"><a href="practical-session-3.html#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 53</span></span>
<span id="cb166-9"><a href="practical-session-3.html#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb166-10"><a href="practical-session-3.html#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb166-11"><a href="practical-session-3.html#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4</span></span>
<span id="cb166-12"><a href="practical-session-3.html#cb166-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb166-13"><a href="practical-session-3.html#cb166-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb166-14"><a href="practical-session-3.html#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 6</span></span>
<span id="cb166-15"><a href="practical-session-3.html#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb166-16"><a href="practical-session-3.html#cb166-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb166-17"><a href="practical-session-3.html#cb166-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 7</span></span>
<span id="cb166-18"><a href="practical-session-3.html#cb166-18" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb166-19"><a href="practical-session-3.html#cb166-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb166-20"><a href="practical-session-3.html#cb166-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6  8 15</span></span>
<span id="cb166-21"><a href="practical-session-3.html#cb166-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb166-22"><a href="practical-session-3.html#cb166-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb166-23"><a href="practical-session-3.html#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 10</span></span>
<span id="cb166-24"><a href="practical-session-3.html#cb166-24" aria-hidden="true" tabindex="-1"></a>nb_rn_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_rn)</span></code></pre></div>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="practical-session-3.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb167-2"><a href="practical-session-3.html#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_rn_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb167-3"><a href="practical-session-3.html#cb167-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb167-4"><a href="practical-session-3.html#cb167-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb167-5"><a href="practical-session-3.html#cb167-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_rn_n),</span>
<span id="cb167-6"><a href="practical-session-3.html#cb167-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb167-7"><a href="practical-session-3.html#cb167-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb167-8"><a href="practical-session-3.html#cb167-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb167-9"><a href="practical-session-3.html#cb167-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb167-10"><a href="practical-session-3.html#cb167-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb167-11"><a href="practical-session-3.html#cb167-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb167-12"><a href="practical-session-3.html#cb167-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb167-13"><a href="practical-session-3.html#cb167-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb167-14"><a href="practical-session-3.html#cb167-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-15"><a href="practical-session-3.html#cb167-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb167-16"><a href="practical-session-3.html#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb167-17"><a href="practical-session-3.html#cb167-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb167-18"><a href="practical-session-3.html#cb167-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb167-19"><a href="practical-session-3.html#cb167-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_rn, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb167-20"><a href="practical-session-3.html#cb167-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb167-21"><a href="practical-session-3.html#cb167-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb167-22"><a href="practical-session-3.html#cb167-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb167-23"><a href="practical-session-3.html#cb167-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb167-24"><a href="practical-session-3.html#cb167-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_graph_neighbours4b-1.png" width="50%" /><img src="_main_files/figure-html/get_graph_neighbours4b-2.png" width="50%" /></p>
<p>Delaunay triangulation neighbours and SOI neighbours are symmetric by design – if 𝑖 is a neighbour of 𝑗, then 𝑗 is a neighbour of 𝑖. The Gabriel graph is also a subgraph of the Delaunay triangulation, retaining a different set of neighbours <span class="citation">(<a href="#ref-Matula1980" role="doc-biblioref">Matula and Sokal 1980</a>)</span>. It does not, however, guarantee symmetry; the same applies to Relative graph neighbours <span class="citation">(<a href="#ref-Toussaint1980Jan" role="doc-biblioref">Toussaint 1980</a>)</span>.</p>
</div>
<div id="by-distance" class="section level4 hasAnchor" number="3.2.5.3">
<h4><span class="header-section-number">3.2.5.3</span> By distance<a href="practical-session-3.html#by-distance" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>An alternative method is to choose the 𝑘 nearest points as neighbours – this adapts across the study area, taking account of differences in the densities of areal entities. Naturally, in the overwhelming majority of cases, it leads to asymmetric neighbours, but will ensure that all areas have 𝑘 neighbours.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="practical-session-3.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set centroids as default geometry</span></span>
<span id="cb168-2"><a href="practical-session-3.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(polygons) <span class="ot">&lt;-</span> <span class="st">&quot;geom_cntd&quot;</span></span>
<span id="cb168-3"><a href="practical-session-3.html#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Get distance-based neighbours</span></span>
<span id="cb168-4"><a href="practical-session-3.html#cb168-4" aria-hidden="true" tabindex="-1"></a>nb_knn <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(polygons, <span class="at">k =</span> <span class="dv">6</span>), </span>
<span id="cb168-5"><a href="practical-session-3.html#cb168-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">row.names =</span> nb_names)</span>
<span id="cb168-6"><a href="practical-session-3.html#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(nb_knn)</span>
<span id="cb168-7"><a href="practical-session-3.html#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1184</span></span>
<span id="cb168-8"><a href="practical-session-3.html#cb168-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nb_knn)</span>
<span id="cb168-9"><a href="practical-session-3.html#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb168-10"><a href="practical-session-3.html#cb168-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 52 53 74 76 77 78</span></span>
<span id="cb168-11"><a href="practical-session-3.html#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb168-12"><a href="practical-session-3.html#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [[2]]</span></span>
<span id="cb168-13"><a href="practical-session-3.html#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  4  7  8  9 11 19</span></span>
<span id="cb168-14"><a href="practical-session-3.html#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb168-15"><a href="practical-session-3.html#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [[3]]</span></span>
<span id="cb168-16"><a href="practical-session-3.html#cb168-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  5  6 10 12 13 18</span></span>
<span id="cb168-17"><a href="practical-session-3.html#cb168-17" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb168-18"><a href="practical-session-3.html#cb168-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [[4]]</span></span>
<span id="cb168-19"><a href="practical-session-3.html#cb168-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  2  5  7  8 11 14</span></span>
<span id="cb168-20"><a href="practical-session-3.html#cb168-20" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb168-21"><a href="practical-session-3.html#cb168-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [[5]]</span></span>
<span id="cb168-22"><a href="practical-session-3.html#cb168-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  6  8 12 13 14 15</span></span>
<span id="cb168-23"><a href="practical-session-3.html#cb168-23" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb168-24"><a href="practical-session-3.html#cb168-24" aria-hidden="true" tabindex="-1"></a><span class="do">## [[6]]</span></span>
<span id="cb168-25"><a href="practical-session-3.html#cb168-25" aria-hidden="true" tabindex="-1"></a><span class="do">## [1]  3  5 10 12 13 18</span></span></code></pre></div>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="practical-session-3.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb169-2"><a href="practical-session-3.html#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb169-3"><a href="practical-session-3.html#cb169-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb169-4"><a href="practical-session-3.html#cb169-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb169-5"><a href="practical-session-3.html#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_knn, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb169-6"><a href="practical-session-3.html#cb169-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb169-7"><a href="practical-session-3.html#cb169-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb169-8"><a href="practical-session-3.html#cb169-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb169-9"><a href="practical-session-3.html#cb169-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb169-10"><a href="practical-session-3.html#cb169-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_distance_neighbours1b-1.png" width="480" /></p>
<p>As you can see, this neighbours object is also a <code>list</code> of length equal to the number of spots we have in the dataset with the same content as the one earlier. Also, in this list all spots have the same number of neighbours since we selected <em>k = 6</em> which means we have the 6 nearest by distance spots. Another interesting fact here is that spots that are not adjacent to each other now might be neighbours.</p>
<p>Another way to find neighbours by distance is to first generate a graph for <em>k = 1</em>. This way we can find the shortest and the longest distance needed for a spot to acquire one neighbour. Then, we can use another function called <code>dnearneigh</code> which is used to find neighbours with an interpoint distance, with arguments <code>d1</code> and <code>d2</code> setting the lower and upper distance bounds. There as a lower bound we can provide zero or the shortest distance a neighbour is found in our dataset and as an upper bound we can provide a value that is a function of the largest distance a neighbour is found in our dataset.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="practical-session-3.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get distance-based neighbours for k = 1</span></span>
<span id="cb170-2"><a href="practical-session-3.html#cb170-2" aria-hidden="true" tabindex="-1"></a>nb_1nn <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(polygons, <span class="at">k =</span> <span class="dv">1</span>), </span>
<span id="cb170-3"><a href="practical-session-3.html#cb170-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">row.names =</span> nb_names)</span>
<span id="cb170-4"><a href="practical-session-3.html#cb170-4" aria-hidden="true" tabindex="-1"></a>dsts <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">nbdists</span>(nb_1nn, polygons<span class="sc">$</span>geom_cntd))</span>
<span id="cb170-5"><a href="practical-session-3.html#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dsts)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   6.224   6.224   6.224   6.320   6.224 114.870</code></pre>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="practical-session-3.html#cb172-1" aria-hidden="true" tabindex="-1"></a>max_1nn <span class="ot">&lt;-</span> <span class="fu">max</span>(dsts)</span>
<span id="cb172-2"><a href="practical-session-3.html#cb172-2" aria-hidden="true" tabindex="-1"></a>min_1nn <span class="ot">&lt;-</span> <span class="fu">min</span>(dsts)</span></code></pre></div>
<p>As you can see, because the 10X Visium spots are equidistant, the majority of the distances is around 6 pixels. Additionally, the maximum distance is almost 20 times the minimum. This is due to the one spot we keep having on the left of our tissue area. As a result in our dataset we will use as upper bound a value that is a function of the minimum distance instead of the maximum.</p>
<p>Let’s have a look at how the dataset looks with the maximum as upper boundary</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="practical-session-3.html#cb173-1" aria-hidden="true" tabindex="-1"></a>nb_1nna <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">1</span><span class="sc">*</span>max_1nn, <span class="at">row.names =</span> nb_names)</span>
<span id="cb173-2"><a href="practical-session-3.html#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(nb_1nna[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code></pre></div>
<pre><code>## List of 5
##  $ : int 53
##  $ : int [1:334] 3 4 5 6 7 8 9 10 11 12 ...
##  $ : int [1:387] 2 4 5 6 7 8 9 10 11 12 ...
##  $ : int [1:347] 2 3 5 6 7 8 9 10 11 12 ...
##  $ : int [1:392] 2 3 4 6 7 8 9 10 11 12 ...</code></pre>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="practical-session-3.html#cb175-1" aria-hidden="true" tabindex="-1"></a>nb_1nna_n <span class="ot">&lt;-</span> <span class="fu">card</span>(nb_1nna)</span></code></pre></div>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="practical-session-3.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb176-2"><a href="practical-session-3.html#cb176-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_1nna_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb176-3"><a href="practical-session-3.html#cb176-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb176-4"><a href="practical-session-3.html#cb176-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb176-5"><a href="practical-session-3.html#cb176-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> nb_1nna_n),</span>
<span id="cb176-6"><a href="practical-session-3.html#cb176-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb176-7"><a href="practical-session-3.html#cb176-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb176-8"><a href="practical-session-3.html#cb176-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb176-9"><a href="practical-session-3.html#cb176-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb176-10"><a href="practical-session-3.html#cb176-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb176-11"><a href="practical-session-3.html#cb176-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb176-12"><a href="practical-session-3.html#cb176-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb176-13"><a href="practical-session-3.html#cb176-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/get_distance_neighbours2b_b-1.png" width="480" /></p>
<p>As you can see, the number of neighbours each spot acquires because we use the maximum distance as the upper bound is massive and as a result it will not plot correctly.</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="practical-session-3.html#cb177-1" aria-hidden="true" tabindex="-1"></a>nb_1nnb <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">1</span><span class="sc">*</span>min_1nn, <span class="at">row.names =</span> nb_names)</span>
<span id="cb177-2"><a href="practical-session-3.html#cb177-2" aria-hidden="true" tabindex="-1"></a>nb_1nnc <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="fl">1.5</span><span class="sc">*</span>min_1nn, <span class="at">row.names =</span> nb_names)</span>
<span id="cb177-3"><a href="practical-session-3.html#cb177-3" aria-hidden="true" tabindex="-1"></a>nb_1nnd <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="fl">1.75</span><span class="sc">*</span>min_1nn, <span class="at">row.names =</span> nb_names)</span>
<span id="cb177-4"><a href="practical-session-3.html#cb177-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-5"><a href="practical-session-3.html#cb177-5" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;nn[b,c,d]&quot;</span>, <span class="fu">names</span>(.GlobalEnv), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb177-6"><a href="practical-session-3.html#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="practical-session-3.html#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p <span class="cf">in</span> ps) {</span>
<span id="cb177-8"><a href="practical-session-3.html#cb177-8" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">get</span>(p)</span>
<span id="cb177-9"><a href="practical-session-3.html#cb177-9" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb177-10"><a href="practical-session-3.html#cb177-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb177-11"><a href="practical-session-3.html#cb177-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb177-12"><a href="practical-session-3.html#cb177-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb177-13"><a href="practical-session-3.html#cb177-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(q, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb177-14"><a href="practical-session-3.html#cb177-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb177-15"><a href="practical-session-3.html#cb177-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb177-16"><a href="practical-session-3.html#cb177-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb177-17"><a href="practical-session-3.html#cb177-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb177-18"><a href="practical-session-3.html#cb177-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> p) <span class="sc">+</span></span>
<span id="cb177-19"><a href="practical-session-3.html#cb177-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_void</span>()) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span>
<span id="cb177-20"><a href="practical-session-3.html#cb177-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/get_distance_neighbours2c-1.png" width="33%" /><img src="_main_files/figure-html/get_distance_neighbours2c-2.png" width="33%" /><img src="_main_files/figure-html/get_distance_neighbours2c-3.png" width="33%" /></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="practical-session-3.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(p <span class="cf">in</span> ps) {</span>
<span id="cb178-2"><a href="practical-session-3.html#cb178-2" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">get</span>(p)</span>
<span id="cb178-3"><a href="practical-session-3.html#cb178-3" aria-hidden="true" tabindex="-1"></a>  q_n <span class="ot">&lt;-</span> <span class="fu">card</span>(q)</span>
<span id="cb178-4"><a href="practical-session-3.html#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="practical-session-3.html#cb178-5" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb178-6"><a href="practical-session-3.html#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> q_n, <span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb178-7"><a href="practical-session-3.html#cb178-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb178-8"><a href="practical-session-3.html#cb178-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb178-9"><a href="practical-session-3.html#cb178-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> q_n),</span>
<span id="cb178-10"><a href="practical-session-3.html#cb178-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb178-11"><a href="practical-session-3.html#cb178-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">adjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb178-12"><a href="practical-session-3.html#cb178-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;#A0CBE8&quot;</span>,</span>
<span id="cb178-13"><a href="practical-session-3.html#cb178-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colour =</span> <span class="st">&quot;#4E79A7&quot;</span>) <span class="sc">+</span></span>
<span id="cb178-14"><a href="practical-session-3.html#cb178-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb178-15"><a href="practical-session-3.html#cb178-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb178-16"><a href="practical-session-3.html#cb178-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> p, </span>
<span id="cb178-17"><a href="practical-session-3.html#cb178-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Number of Neighbours&quot;</span>) <span class="sc">+</span></span>
<span id="cb178-18"><a href="practical-session-3.html#cb178-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span>
<span id="cb178-19"><a href="practical-session-3.html#cb178-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="_main_files/figure-html/get_distance_neighbours2d-1.png" width="33%" /><img src="_main_files/figure-html/get_distance_neighbours2d-2.png" width="33%" /><img src="_main_files/figure-html/get_distance_neighbours2d-3.png" width="33%" />
Using the maximum as the upper limit is not prohibited, it is just not advised if you plan to plot the neighbour relationships on a map.</p>
<p><em>The above for identifying neighbours are partially taken from the very well written, well-descriptive and thorough <code>spdep</code> package <a href="https://r-spatial.github.io/spdep/articles/nb.html#distance-based-neighbours">vignette</a> for neighbours identification.</em></p>
</div>
<div id="adding-spatial-weights" class="section level4 hasAnchor" number="3.2.5.4">
<h4><span class="header-section-number">3.2.5.4</span> Adding spatial weights<a href="practical-session-3.html#adding-spatial-weights" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The neighbour lists can be supplemented with spatial weights using the <code>nb2listw</code> and <code>nb2listwdist</code> function from <code>spdep</code> package for the chosen type and coding scheme style. There are 6 different coding scheme styles that can be used to weigh neighbour relationships:</p>
<ol style="list-style-type: decimal">
<li><strong>B</strong>: is the basic binary coding (1 for neighbour, 0 for no neighbour).</li>
<li><strong>W</strong>: is row standardised (sums over all links to n).</li>
<li><strong>C</strong>: is globally standardised (sums over all links to n).</li>
<li><strong>U</strong>: is equal to C divided by the number of neighbours (sums over all links to unity).</li>
<li><strong>S</strong>: is the variance-stabilizing coding scheme (sums over all links to n).</li>
<li><strong>minmax</strong>: divides the weights by the minimum of the maximum row sums and maximum column sums of the input weights; It is similar to the C and U styles.</li>
</ol>
<p>The coding scheme style is practically the value each neighbour will get. For example, in a binary coding scheme style (<strong>B</strong>) if a spot is a neighbour of the spot in focus then gets the value of <strong>1</strong>, else gets <strong>0</strong>. Another example, in a row standardised coding scheme style (<strong>W</strong>) if the spot in focus has a total of 10 neighbours and each neighbour has a weight of 1, then the sum of all neighbour weights is 10, and each neighbour will get a normalised weight of 1/10 = 0.1. As a result, in the row standardised coding scheme, spots with many neighbours will have neighbours with lower weights and thus will not be over-emphasised.</p>
<p>Starting from a binary neighbours list, in which regions are either listed as neighbours or are absent (thus not in the set of neighbours for some definition), we can add a distance-based weights list. The <code>nb2listwdist</code> function supplements a neighbours list with spatial weights for the chosen types of distance modelling and coding scheme. While the offered coding schemes parallel those of the <code>nb2listw</code> function above, three distance-based types of weights are available: inverse distance weighting (IDW), double-power distance weights (DPD), and exponential distance decay (EXP). The three types of distance weight calculations are based on pairwise distances 𝑑𝑖𝑗, all of which are controlled by parameter <em>“alpha”</em> (𝛼 below):</p>
<ol style="list-style-type: decimal">
<li><strong>idw</strong>: 𝑤𝑖𝑗=𝑑−𝛼𝑖𝑗,</li>
<li><strong>exp</strong>: 𝑤𝑖𝑗=exp(−𝛼⋅𝑑𝑖𝑗),</li>
<li><strong>dpd</strong>: 𝑤𝑖𝑗=[1−(𝑑𝑖𝑗/𝑑max)𝛼]𝛼,</li>
</ol>
<p>the latter of which leads to 𝑤𝑖𝑗=0 for all 𝑑𝑖𝑗&gt;𝑑max. Note that <em>IDW</em> weights show extreme behaviour close to 0 and can take on the value infinity. In such cases, the infinite values are replaced by the largest finite weight present in the weights list.</p>
<p>The default coding scheme for <code>nb2listwdist</code> is “raw”, which outputs the raw distance-based weights without applying any kind of normalisation. In addition, the same coding scheme styles that are also available in the <code>nb2listw</code> function can be chosen.</p>
<p>Below we will use only the <code>nb2listwdist</code> function which can accommodate both weight types and coding scheme styles.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="practical-session-3.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set centroids as default geometry</span></span>
<span id="cb180-2"><a href="practical-session-3.html#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(polygons) <span class="ot">&lt;-</span> <span class="st">&quot;geom_cntd&quot;</span></span>
<span id="cb180-3"><a href="practical-session-3.html#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Add weights</span></span>
<span id="cb180-4"><a href="practical-session-3.html#cb180-4" aria-hidden="true" tabindex="-1"></a>nb_adjc_w <span class="ot">&lt;-</span> <span class="fu">nb2listwdist</span>(nb_adjc, polygons, <span class="at">type =</span> <span class="st">&quot;idw&quot;</span>, <span class="at">style =</span> <span class="st">&quot;W&quot;</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb180-5"><a href="practical-session-3.html#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look</span></span>
<span id="cb180-6"><a href="practical-session-3.html#cb180-6" aria-hidden="true" tabindex="-1"></a>nb_adjc_w<span class="sc">$</span>weights[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [[1]]
## NULL
## 
## [[2]]
## [1] 0.3344222 0.3333309 0.3322469
## 
## [[3]]
## [1] 0.5001435 0.4998565
## 
## [[4]]
## [1] 0.3339962 0.3330975 0.3329063
## 
## [[5]]
## [1] 0.2506436 0.2495468 0.2498330 0.2499765</code></pre>
</div>
</div>
<div id="generate-distance-matrices" class="section level3 hasAnchor" number="3.2.6">
<h3><span class="header-section-number">3.2.6</span> Generate distance matrices<a href="practical-session-3.html#generate-distance-matrices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A distance matrix is a mirrored matrix that contains the distance between a spot and every other spot. This distance can be a simple Euclidean distance based on the coordinates of the spots or a weighted distance according to a bandwidth around each spot using a kernel that gives higher scores to distances between spots that are closer together compared to the ones that are farther away. These weighted distance matrices are later used to run geographically weighted (GW) models.</p>
<p>There are 6 different kernels that can be used to weight the distances between spots. The next two figures are from the <code>GWmodel</code>’s publication <span class="citation">(<a href="#ref-Gollini2015Feb" role="doc-biblioref">Gollini et al. 2015</a>)</span> and provide a bit more description on that.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:GWmodelFig1"></span>
<img src="images/gwmodel_kernel_math.png" alt="The math equations that define the kernels." width="100%" />
<p class="caption">
Figure 3.2: The math equations that define the kernels.
</p>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:GWmodelFig2"></span>
<img src="images/gwmodel_kernel_graphs.png" alt="Examples from using each kernel." width="100%" />
<p class="caption">
Figure 3.3: Examples from using each kernel.
</p>
</div>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="practical-session-3.html#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set centroids as default geometry</span></span>
<span id="cb182-2"><a href="practical-session-3.html#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(polygons) <span class="ot">&lt;-</span> <span class="st">&quot;geom_cntd&quot;</span></span>
<span id="cb182-3"><a href="practical-session-3.html#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Get Euclidean distances between spots</span></span>
<span id="cb182-4"><a href="practical-session-3.html#cb182-4" aria-hidden="true" tabindex="-1"></a>dist.Mat <span class="ot">&lt;-</span> <span class="fu">gw.dist</span>(<span class="at">dp.locat =</span> <span class="fu">st_coordinates</span>(polygons), <span class="at">p =</span> <span class="dv">2</span>)</span>
<span id="cb182-5"><a href="practical-session-3.html#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dist.Mat) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb182-6"><a href="practical-session-3.html#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dist.Mat) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb182-7"><a href="practical-session-3.html#cb182-7" aria-hidden="true" tabindex="-1"></a>dist.Mat[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>##                    AAACTAACGTGGCGAC.1 GACTAAGATCATGCAC.1 ATCGACTCTTTCCGTT.1
## AAACTAACGTGGCGAC.1             0.0000         195.257504          172.91415
## GACTAAGATCATGCAC.1           195.2575           0.000000           24.92464
## ATCGACTCTTTCCGTT.1           172.9142          24.924643            0.00000
## TGGTTCGTAGCAAAGG.1           189.6205           6.224242           18.70041
## GCTCTAAACCCTGACG.1           183.7097          16.504279           10.80228
##                    TGGTTCGTAGCAAAGG.1
## AAACTAACGTGGCGAC.1         189.620541
## GACTAAGATCATGCAC.1           6.224242
## ATCGACTCTTTCCGTT.1          18.700407
## TGGTTCGTAGCAAAGG.1           0.000000
## GCTCTAAACCCTGACG.1          10.818453</code></pre>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="practical-session-3.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set bandwidth</span></span>
<span id="cb184-2"><a href="practical-session-3.html#cb184-2" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">=</span> (<span class="fu">range</span>(dist.Mat)[<span class="dv">2</span>])<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb184-3"><a href="practical-session-3.html#cb184-3" aria-hidden="true" tabindex="-1"></a>bw</span></code></pre></div>
<pre><code>## [1] 165.0985</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="practical-session-3.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select a kernel</span></span>
<span id="cb186-2"><a href="practical-session-3.html#cb186-2" aria-hidden="true" tabindex="-1"></a>kernel <span class="ot">=</span> <span class="st">&quot;bisquare&quot;</span></span>
<span id="cb186-3"><a href="practical-session-3.html#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate W distance matrix</span></span>
<span id="cb186-4"><a href="practical-session-3.html#cb186-4" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">gw.weight</span>(<span class="at">vdist =</span> dist.Mat, </span>
<span id="cb186-5"><a href="practical-session-3.html#cb186-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">bw =</span> bw,</span>
<span id="cb186-6"><a href="practical-session-3.html#cb186-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel =</span> kernel,</span>
<span id="cb186-7"><a href="practical-session-3.html#cb186-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">adaptive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb186-8"><a href="practical-session-3.html#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(w) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb186-9"><a href="practical-session-3.html#cb186-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(w) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb186-10"><a href="practical-session-3.html#cb186-10" aria-hidden="true" tabindex="-1"></a>w[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>##                    AAACTAACGTGGCGAC.1 GACTAAGATCATGCAC.1 ATCGACTCTTTCCGTT.1
## AAACTAACGTGGCGAC.1                  1          0.0000000          0.0000000
## GACTAAGATCATGCAC.1                  0          1.0000000          0.9549366
## ATCGACTCTTTCCGTT.1                  0          0.9549366          1.0000000
## TGGTTCGTAGCAAAGG.1                  0          0.9971594          0.9745052
## GCTCTAAACCCTGACG.1                  0          0.9801134          0.9914563
##                    TGGTTCGTAGCAAAGG.1
## AAACTAACGTGGCGAC.1          0.0000000
## GACTAAGATCATGCAC.1          0.9971594
## ATCGACTCTTTCCGTT.1          0.9745052
## TGGTTCGTAGCAAAGG.1          1.0000000
## GCTCTAAACCCTGACG.1          0.9914308</code></pre>
</div>
<div id="putting-it-all-together-1" class="section level3 hasAnchor" number="3.2.7">
<h3><span class="header-section-number">3.2.7</span> Putting it all together<a href="practical-session-3.html#putting-it-all-together-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The below code puts all these steps in order by selecting one of the options at each step.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="practical-session-3.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load data and metadata</span></span>
<span id="cb188-2"><a href="practical-session-3.html#cb188-2" aria-hidden="true" tabindex="-1"></a>inputD <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;./data/hsLivSteat_JBO019_inputD.rds&quot;</span>)</span>
<span id="cb188-3"><a href="practical-session-3.html#cb188-3" aria-hidden="true" tabindex="-1"></a>inputMD <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;./data/hsLivSteat_JBO019_inputMD.rds&quot;</span>)</span>
<span id="cb188-4"><a href="practical-session-3.html#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Create point geometries</span></span>
<span id="cb188-5"><a href="practical-session-3.html#cb188-5" aria-hidden="true" tabindex="-1"></a>spot_position <span class="ot">&lt;-</span> inputMD <span class="sc">%&gt;%</span> </span>
<span id="cb188-6"><a href="practical-session-3.html#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;Barcode&quot;</span>, <span class="st">&quot;pixel_x&quot;</span>, <span class="st">&quot;pixel_y&quot;</span>, <span class="st">&quot;Section&quot;</span>))</span>
<span id="cb188-7"><a href="practical-session-3.html#cb188-7" aria-hidden="true" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> spot_position <span class="sc">%&gt;%</span> </span>
<span id="cb188-8"><a href="practical-session-3.html#cb188-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;pixel_x&quot;</span>, <span class="st">&quot;pixel_y&quot;</span>), </span>
<span id="cb188-9"><a href="practical-session-3.html#cb188-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb188-10"><a href="practical-session-3.html#cb188-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Tessellate space</span></span>
<span id="cb188-11"><a href="practical-session-3.html#cb188-11" aria-hidden="true" tabindex="-1"></a>cntd_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(centroids)</span>
<span id="cb188-12"><a href="practical-session-3.html#cb188-12" aria-hidden="true" tabindex="-1"></a>voronoi <span class="ot">&lt;-</span> <span class="fu">st_voronoi</span>(cntd_union, <span class="at">bOnlyEdges =</span> <span class="cn">TRUE</span>)</span>
<span id="cb188-13"><a href="practical-session-3.html#cb188-13" aria-hidden="true" tabindex="-1"></a>voronoi_env <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">st_cast</span>(voronoi), <span class="fu">st_convex_hull</span>(cntd_union))</span>
<span id="cb188-14"><a href="practical-session-3.html#cb188-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Polygonise tessellation</span></span>
<span id="cb188-15"><a href="practical-session-3.html#cb188-15" aria-hidden="true" tabindex="-1"></a>polygons <span class="ot">&lt;-</span> <span class="fu">st_polygonize</span>(voronoi_env) <span class="sc">%&gt;%</span> </span>
<span id="cb188-16"><a href="practical-session-3.html#cb188-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_cast</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb188-17"><a href="practical-session-3.html#cb188-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb188-18"><a href="practical-session-3.html#cb188-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_join</span>(., </span>
<span id="cb188-19"><a href="practical-session-3.html#cb188-19" aria-hidden="true" tabindex="-1"></a>            centroids[centroids<span class="sc">$</span>Section <span class="sc">==</span> <span class="dv">1</span>,],</span>
<span id="cb188-20"><a href="practical-session-3.html#cb188-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">join =</span> st_contains,</span>
<span id="cb188-21"><a href="practical-session-3.html#cb188-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">left =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb188-22"><a href="practical-session-3.html#cb188-22" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">geom_pol =</span> geometry) <span class="sc">%&gt;%</span> </span>
<span id="cb188-23"><a href="practical-session-3.html#cb188-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Barcode_rn =</span> Barcode) <span class="sc">%&gt;%</span> </span>
<span id="cb188-24"><a href="practical-session-3.html#cb188-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_to_rownames</span>(<span class="st">&quot;Barcode_rn&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb188-25"><a href="practical-session-3.html#cb188-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>() </span>
<span id="cb188-26"><a href="practical-session-3.html#cb188-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Update the polygon object to keep the centroid geometries as well</span></span>
<span id="cb188-27"><a href="practical-session-3.html#cb188-27" aria-hidden="true" tabindex="-1"></a>polygons <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> </span>
<span id="cb188-28"><a href="practical-session-3.html#cb188-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">as.data.frame</span>(centroids)) <span class="sc">%&gt;%</span> </span>
<span id="cb188-29"><a href="practical-session-3.html#cb188-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">geom_cntd =</span> geometry) <span class="sc">%&gt;%</span> </span>
<span id="cb188-30"><a href="practical-session-3.html#cb188-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">sf_column_name =</span> <span class="st">&quot;geom_pol&quot;</span>) </span></code></pre></div>
<pre><code>## Joining with `by = join_by(Barcode, pixel_x, pixel_y, Section)`</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="practical-session-3.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Identify neighbours by Sphere Of Influence</span></span>
<span id="cb190-2"><a href="practical-session-3.html#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(polygons) <span class="ot">&lt;-</span> <span class="st">&quot;geom_cntd&quot;</span></span>
<span id="cb190-3"><a href="practical-session-3.html#cb190-3" aria-hidden="true" tabindex="-1"></a>nb_tri <span class="ot">&lt;-</span> <span class="fu">tri2nb</span>(polygons<span class="sc">$</span>geom_cntd, <span class="at">row.names =</span> nb_names)</span>
<span id="cb190-4"><a href="practical-session-3.html#cb190-4" aria-hidden="true" tabindex="-1"></a>nb_soi <span class="ot">&lt;-</span> <span class="fu">graph2nb</span>(<span class="fu">soi.graph</span>(nb_tri, polygons<span class="sc">$</span>geom_cntd), </span>
<span id="cb190-5"><a href="practical-session-3.html#cb190-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">row.names =</span> nb_names)</span>
<span id="cb190-6"><a href="practical-session-3.html#cb190-6" aria-hidden="true" tabindex="-1"></a>nb_soi_w <span class="ot">&lt;-</span> <span class="fu">nb2listwdist</span>(nb_soi, polygons, <span class="at">type =</span> <span class="st">&quot;idw&quot;</span>, <span class="at">style =</span> <span class="st">&quot;W&quot;</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb190-7"><a href="practical-session-3.html#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate distance matrix</span></span>
<span id="cb190-8"><a href="practical-session-3.html#cb190-8" aria-hidden="true" tabindex="-1"></a>dist.Mat <span class="ot">&lt;-</span> <span class="fu">gw.dist</span>(<span class="at">dp.locat =</span> <span class="fu">st_coordinates</span>(polygons), <span class="at">p =</span> <span class="dv">2</span>)</span>
<span id="cb190-9"><a href="practical-session-3.html#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dist.Mat) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb190-10"><a href="practical-session-3.html#cb190-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dist.Mat) <span class="ot">&lt;-</span> nb_names</span>
<span id="cb190-11"><a href="practical-session-3.html#cb190-11" aria-hidden="true" tabindex="-1"></a>bw <span class="ot">=</span> (<span class="fu">range</span>(dist.Mat)[<span class="dv">2</span>])<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb190-12"><a href="practical-session-3.html#cb190-12" aria-hidden="true" tabindex="-1"></a>kernel <span class="ot">=</span> <span class="st">&quot;bisquare&quot;</span></span>
<span id="cb190-13"><a href="practical-session-3.html#cb190-13" aria-hidden="true" tabindex="-1"></a>dist.Mat.w <span class="ot">&lt;-</span> <span class="fu">gw.weight</span>(<span class="at">vdist =</span> dist.Mat, </span>
<span id="cb190-14"><a href="practical-session-3.html#cb190-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">bw =</span> bw,</span>
<span id="cb190-15"><a href="practical-session-3.html#cb190-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel =</span> kernel,</span>
<span id="cb190-16"><a href="practical-session-3.html#cb190-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">adaptive =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="practical-session-3.html#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot on tissue polygons</span></span>
<span id="cb191-2"><a href="practical-session-3.html#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> polygons) <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol)) <span class="sc">+</span> <span class="fu">theme_void</span>()</span>
<span id="cb191-3"><a href="practical-session-3.html#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot neighbour graph</span></span>
<span id="cb191-4"><a href="practical-session-3.html#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb191-5"><a href="practical-session-3.html#cb191-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, </span>
<span id="cb191-6"><a href="practical-session-3.html#cb191-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_pol), </span>
<span id="cb191-7"><a href="practical-session-3.html#cb191-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb191-8"><a href="practical-session-3.html#cb191-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">as</span>(<span class="fu">nb2lines</span>(nb_soi, <span class="at">coords =</span> polygons<span class="sc">$</span>geom_cntd), <span class="st">&quot;sf&quot;</span>), </span>
<span id="cb191-9"><a href="practical-session-3.html#cb191-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb191-10"><a href="practical-session-3.html#cb191-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons,</span>
<span id="cb191-11"><a href="practical-session-3.html#cb191-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">geometry =</span> geom_cntd),</span>
<span id="cb191-12"><a href="practical-session-3.html#cb191-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-13"><a href="practical-session-3.html#cb191-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/all_in_one_plots-1.png" width="50%" /><img src="_main_files/figure-html/all_in_one_plots-2.png" width="50%" /></p>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Avis1985" class="csl-entry">
Avis, David, and Joe Horton. 1985. <span>“REMARKS ON THE SPHERE OF INFLUENCE GRAPH.”</span> <em>Annals of the New York Academy of Sciences</em> 440 (1): 323–27. https://doi.org/<a href="https://doi.org/10.1111/j.1749-6632.1985.tb14563.x">https://doi.org/10.1111/j.1749-6632.1985.tb14563.x</a>.
</div>
<div id="ref-Gollini2015Feb" class="csl-entry">
Gollini, Isabella, Binbin Lu, Martin Charlton, Christopher Brunsdon, and Paul Harris. 2015. <span>“<span class="nocase">GWmodel: An R Package for Exploring Spatial Heterogeneity Using Geographically Weighted Models</span>.”</span> <em>J Stat Soft</em> 63 (February): 1–50. <a href="https://doi.org/10.18637/jss.v063.i17">https://doi.org/10.18637/jss.v063.i17</a>.
</div>
<div id="ref-GUILLIAMS2022379" class="csl-entry">
Guilliams, Martin, Johnny Bonnardel, Birthe Haest, Bart Vanderborght, Camille Wagner, Anneleen Remmerie, Anna Bujko, et al. 2022. <span>“Spatial Proteogenomics Reveals Distinct and Evolutionarily Conserved Hepatic Macrophage Niches.”</span> <em>Cell</em> 185 (2): 379–396.e38. https://doi.org/<a href="https://doi.org/10.1016/j.cell.2021.12.018">https://doi.org/10.1016/j.cell.2021.12.018</a>.
</div>
<div id="ref-Matula1980" class="csl-entry">
Matula, David W., and Robert R. Sokal. 1980. <span>“<span class="nocase">Properties of Gabriel Graphs Relevant to Geographic Variation Research and the Clustering of Points in the Plane</span>.”</span> <em>Geog Anal</em> 12 (3): 205–22. <a href="https://doi.org/10.1111/j.1538-4632.1980.tb00031.x">https://doi.org/10.1111/j.1538-4632.1980.tb00031.x</a>.
</div>
<div id="ref-Toussaint1980Jan" class="csl-entry">
Toussaint, Godfried T. 1980. <span>“<span class="nocase">The relative neighbourhood graph of a finite planar set</span>.”</span> <em>Pattern Recognit</em> 12 (4): 261–68. <a href="https://doi.org/10.1016/0031-3203(80)90066-7">https://doi.org/10.1016/0031-3203(80)90066-7</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="practical-session-2.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="practical-session-4.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/03-intro-geospatial.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
